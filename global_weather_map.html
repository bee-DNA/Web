<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç ÂÖ®ÁêÉÂç≥ÊôÇÂ§©Ê∞£Êµ∑Ê¥ãÂú∞ÂúñÁ≥ªÁµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 420px;
            background: white;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
        }

        .sidebar-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.8rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .sidebar-header p {
            opacity: 0.95;
            font-size: 1rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 35px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            padding: 14px 18px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            font-weight: 500;
        }

        .control-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            background: rgba(255, 255, 255, 1);
        }

        .status-bar {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 0.9rem;
            backdrop-filter: blur(15px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-width: 250px;
            backdrop-filter: blur(10px);
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            margin-right: 12px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .weather-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 18px;
            border-left: 5px solid #3498db;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .weather-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-left-color: #2980b9;
        }

        .weather-station {
            font-weight: bold;
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .weather-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: 0.95rem;
        }

        .weather-item {
            background: #f1f2f6;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .region-filter {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .region-btn {
            padding: 10px 15px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 25px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 500;
        }

        .region-btn.active,
        .region-btn:hover {
            background: #3498db;
            color: white;
            transform: scale(1.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .layer-controls {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .layer-section {
            margin-bottom: 20px;
        }

        .layer-section h4 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1rem;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f1f2f6;
        }

        .layer-checkbox {
            margin-right: 12px;
            transform: scale(1.2);
        }

        .layer-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .opacity-slider {
            width: 80px;
            margin-left: 15px;
        }

        .update-info {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #055160;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 40vh;
            }

            .map-container {
                height: 60vh;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .region-filter {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üåç ÂÖ®ÁêÉÂ§©Ê∞£Âú∞Âúñ</h1>
                <p>Âç≥ÊôÇÂ§©Ê∞£„ÄÅÈõ≤Âúñ„ÄÅÊµ∑Ê¥ã„ÄÅÈ¢±È¢®Ë≥áÊñôÊï¥ÂêàÁ≥ªÁµ±</p>
            </div>

            <div class="sidebar-content">
                <!-- Êõ¥Êñ∞Ë≥áË®ä -->
                <div class="update-info">
                    <strong>‚è∞ Ëá™ÂãïÊõ¥Êñ∞:</strong> ÊØè2Â∞èÊôÇÊõ¥Êñ∞‰∏ÄÊ¨°<br>
                    <strong>üì° Ë≥áÊñô‰æÜÊ∫ê:</strong> OpenWeather ‚Ä¢ NASA ‚Ä¢ NOAA
                </div>

                <!-- ÂÖ®ÁêÉÁµ±Ë®à -->
                <div class="section">
                    <div class="section-title">
                        üìä ÂÖ®ÁêÉÁµ±Ë®à
                    </div>
                    <div class="stats-grid" id="global-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="total-stations">--</div>
                            <div class="stat-label">Áõ£Ê∏¨Á´ôÈªû</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-temp">--¬∞C</div>
                            <div class="stat-label">Âπ≥ÂùáÊ∫´Â∫¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="max-temp">--¬∞C</div>
                            <div class="stat-label">ÊúÄÈ´òÊ∫´Â∫¶</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="min-temp">--¬∞C</div>
                            <div class="stat-label">ÊúÄ‰ΩéÊ∫´Â∫¶</div>
                        </div>
                    </div>
                </div>

                <!-- ÂúñÂ±§ÊéßÂà∂ -->
                <div class="section">
                    <div class="section-title">
                        üó∫Ô∏è ÂúñÂ±§ÊéßÂà∂
                    </div>

                    <div class="layer-section">
                        <h4>‚òÅÔ∏è Â§©Ê∞£ÂúñÂ±§</h4>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="weather-stations" checked
                                onchange="toggleWeatherStations()">
                            <label class="layer-name" for="weather-stations">Ê∞£Ë±°Á´ô</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="80"
                                onchange="setWeatherOpacity(this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="precipitation-layer"
                                onchange="togglePrecipitation()">
                            <label class="layer-name" for="precipitation-layer">ÈôçÈõ®Èõ≤Âúñ</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="60"
                                onchange="setPrecipitationOpacity(this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="clouds-layer" onchange="toggleClouds()">
                            <label class="layer-name" for="clouds-layer">Èõ≤Â±§Ë¶ÜËìã</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="50"
                                onchange="setCloudsOpacity(this.value)">
                        </div>
                    </div>

                    <div class="layer-section">
                        <h4>üõ∞Ô∏è Ë°õÊòüÂúñÂ±§</h4>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="satellite-layer"
                                onchange="toggleSatellite()">
                            <label class="layer-name" for="satellite-layer">Ë°õÊòüÂΩ±ÂÉè</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="70"
                                onchange="setSatelliteOpacity(this.value)">
                        </div>
                    </div>

                    <div class="layer-section">
                        <h4>üåä Êµ∑Ê¥ãÂúñÂ±§</h4>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="ocean-temp-layer"
                                onchange="toggleOceanTemp()">
                            <label class="layer-name" for="ocean-temp-layer">Êµ∑Ë°®Ê∫´Â∫¶</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="60"
                                onchange="setOceanTempOpacity(this.value)">
                        </div>
                    </div>
                </div>

                <!-- Âú∞ÂçÄÁØ©ÈÅ∏ -->
                <div class="section">
                    <div class="section-title">
                        üåè Âú∞ÂçÄÁØ©ÈÅ∏
                    </div>
                    <div class="region-filter">
                        <button class="region-btn active" onclick="filterByRegion('all')">ÂÖ®ÈÉ®</button>
                        <button class="region-btn" onclick="filterByRegion('asia')">‰∫ûÊ¥≤</button>
                        <button class="region-btn" onclick="filterByRegion('europe')">Ê≠êÊ¥≤</button>
                        <button class="region-btn" onclick="filterByRegion('americas')">ÁæéÊ¥≤</button>
                        <button class="region-btn" onclick="filterByRegion('oceania')">Â§ßÊ¥ãÊ¥≤</button>
                        <button class="region-btn" onclick="filterByRegion('africa')">ÈùûÊ¥≤</button>
                    </div>
                </div>

                <!-- Âç≥ÊôÇÂ§©Ê∞£ -->
                <div class="section">
                    <div class="section-title">
                        üå¶Ô∏è Âç≥ÊôÇÂ§©Ê∞£
                    </div>
                    <div id="weather-data">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span style="margin-left: 15px;">ËºâÂÖ•ÂÖ®ÁêÉÂ§©Ê∞£Ë≥áÊñô‰∏≠...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>

            <div class="map-controls">
                <button class="control-button" onclick="refreshAllData()">
                    üîÑ Êõ¥Êñ∞Ë≥áÊñô
                </button>
                <button class="control-button" onclick="toggleFullscreen()">
                    üì∫ ÂÖ®Ëû¢Âπï
                </button>
                <button class="control-button" onclick="showGlobalView()">
                    üåç ÂÖ®ÁêÉË¶ñÂúñ
                </button>
                <button class="control-button" onclick="showTaiwanView()">
                    üáπüáº Âè∞ÁÅ£Ë¶ñÂúñ
                </button>
                <button class="control-button" onclick="toggle3D()">
                    üèîÔ∏è 3DË¶ñËßí
                </button>
            </div>

            <div class="status-bar" id="status">
                ÂàùÂßãÂåñÂÖ®ÁêÉÂ§©Ê∞£Âú∞ÂúñÁ≥ªÁµ±...
            </div>

            <div class="legend">
                <div class="legend-title">üå°Ô∏è Ê∫´Â∫¶Âúñ‰æã</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #0000ff, #4169e1);"></div>
                    <span>
                        < 0¬∞C (Ê•µÂØí)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #00ffff, #00bfff);"></div>
                    <span>0-10¬∞C (ÂØíÂÜ∑)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #00ff00, #32cd32);"></div>
                    <span>10-20¬∞C (Ê∂ºÁàΩ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #ffff00, #ffd700);"></div>
                    <span>20-30¬∞C (Ê∫´Êöñ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #ff8000, #ff6347);"></div>
                    <span>30-40¬∞C (ÁÇéÁÜ±)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: linear-gradient(to right, #ff0000, #dc143c);"></div>
                    <span>> 40¬∞C (ÈÖ∑ÁÜ±)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mapbox Ë®≠ÂÆö
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlLWRuYSIsImEiOiJjbWZ5MTlhOTkwZnF3MmxvbjkwN2RtM2Z4In0.yFiY2MNpWqaDINuLaz1e0w';

        // ÂÖ®ÂüüËÆäÊï∏
        let map, globalWeatherData, currentFilter = 'all';
        let is3D = false;

        // API Keys (ÊÇ®Êèê‰æõÁöÑ)
        const API_KEYS = {
            openweather: 'c3021b469b0ad866b2e96b3e5676347f'
        };

        // ÂàùÂßãÂåñÂú∞Âúñ
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/light-v11',
                center: [0, 20], // ÂÖ®ÁêÉ‰∏≠ÂøÉ
                zoom: 2,
                pitch: 0,
                bearing: 0
            });

            map.on('load', () => {
                updateStatus('üåç ÂÖ®ÁêÉÂú∞ÂúñËºâÂÖ•ÂÆåÊàê');
                loadGlobalWeatherData();
                setupMapLayers();
                setupWeatherLayers();
            });

            // Ê∑ªÂä†ÊéßÂà∂È†Ö
            map.addControl(new mapboxgl.NavigationControl());
            map.addControl(new mapboxgl.ScaleControl());

            // Ê∑ªÂä†ÂÖ®Ëû¢ÂπïÊéßÂà∂
            map.addControl(new mapboxgl.FullscreenControl());
        }

        // ËºâÂÖ•ÂÖ®ÁêÉÂ§©Ê∞£Ë≥áÊñô
        async function loadGlobalWeatherData() {
            try {
                updateStatus('üîÑ ËºâÂÖ•ÂÖ®ÁêÉÂ§©Ê∞£Ë≥áÊñô‰∏≠...');

                // Ê®°Êì¨ÂÖ®ÁêÉ‰∏ªË¶ÅÂüéÂ∏ÇË≥áÊñô
                const globalCities = [
                    { name: 'Êù±‰∫¨', lat: 35.6762, lng: 139.6503, country: 'JP', region: 'asia' },
                    { name: 'Á¥êÁ¥Ñ', lat: 40.7128, lng: -74.0060, country: 'US', region: 'americas' },
                    { name: 'ÂÄ´Êï¶', lat: 51.5074, lng: -0.1278, country: 'GB', region: 'europe' },
                    { name: 'Èõ™Ê¢®', lat: -33.8688, lng: 151.2093, country: 'AU', region: 'oceania' },
                    { name: 'ÈñãÁæÖ', lat: 30.0444, lng: 31.2357, country: 'EG', region: 'africa' },
                    { name: 'Âè∞Âåó', lat: 25.0330, lng: 121.5654, country: 'TW', region: 'asia' },
                    { name: 'È¶ñÁàæ', lat: 37.5665, lng: 126.9780, country: 'KR', region: 'asia' },
                    { name: 'Âåó‰∫¨', lat: 39.9042, lng: 116.4074, country: 'CN', region: 'asia' },
                    { name: 'Â∑¥Èªé', lat: 48.8566, lng: 2.3522, country: 'FR', region: 'europe' },
                    { name: 'ÊüèÊûó', lat: 52.5200, lng: 13.4050, country: 'DE', region: 'europe' },
                    { name: 'Ê¥õÊùâÁ£Ø', lat: 34.0522, lng: -118.2437, country: 'US', region: 'americas' },
                    { name: 'ËÅñ‰øùÁæÖ', lat: -23.5505, lng: -46.6333, country: 'BR', region: 'americas' },
                    { name: 'Â¢®ÁàæÊú¨', lat: -37.8136, lng: 144.9631, country: 'AU', region: 'oceania' },
                    { name: 'ÈñãÊôÆÊï¶', lat: -33.9249, lng: 18.4241, country: 'ZA', region: 'africa' },
                    { name: 'Â≠üË≤∑', lat: 19.0760, lng: 72.8777, country: 'IN', region: 'asia' },
                    { name: 'Ëé´ÊñØÁßë', lat: 55.7558, lng: 37.6176, country: 'RU', region: 'europe' }
                ];

                const weatherPromises = globalCities.map(async city => {
                    try {
                        const response = await fetch(
                            `https://api.openweathermap.org/data/2.5/weather?lat=${city.lat}&lon=${city.lng}&appid=${API_KEYS.openweather}&units=metric&lang=zh_tw`
                        );
                        const weatherData = await response.json();

                        return {
                            type: "Feature",
                            geometry: {
                                type: "Point",
                                coordinates: [city.lng, city.lat]
                            },
                            properties: {
                                name: city.name,
                                country: city.country,
                                region: city.region,
                                temperature: weatherData.main?.temp || 20,
                                feels_like: weatherData.main?.feels_like || 20,
                                humidity: weatherData.main?.humidity || 50,
                                pressure: weatherData.main?.pressure || 1013,
                                wind_speed: weatherData.wind?.speed || 0,
                                wind_direction: weatherData.wind?.deg || 0,
                                weather_main: weatherData.weather?.[0]?.main || 'Êô¥Â§©',
                                weather_description: weatherData.weather?.[0]?.description || 'Êô¥Êúó',
                                icon: weatherData.weather?.[0]?.icon || '01d',
                                visibility: weatherData.visibility || 10000,
                                clouds: weatherData.clouds?.all || 0,
                                timestamp: new Date().toISOString()
                            }
                        };
                    } catch (error) {
                        console.error(`ËºâÂÖ• ${city.name} Â§©Ê∞£Â§±Êïó:`, error);
                        // ËøîÂõûÊ®°Êì¨Ë≥áÊñô
                        return {
                            type: "Feature",
                            geometry: { type: "Point", coordinates: [city.lng, city.lat] },
                            properties: {
                                name: city.name, country: city.country, region: city.region,
                                temperature: 15 + Math.random() * 20, feels_like: 15 + Math.random() * 20,
                                humidity: 40 + Math.random() * 40, pressure: 1000 + Math.random() * 50,
                                wind_speed: Math.random() * 10, wind_direction: Math.random() * 360,
                                weather_main: 'Êô¥Â§©', weather_description: 'Êô¥Êúó', icon: '01d',
                                visibility: 10000, clouds: Math.random() * 100,
                                timestamp: new Date().toISOString()
                            }
                        };
                    }
                });

                const features = await Promise.all(weatherPromises);

                globalWeatherData = {
                    type: "FeatureCollection",
                    features: features,
                    metadata: {
                        total_stations: features.length,
                        last_update: new Date().toISOString()
                    }
                };

                // Êõ¥Êñ∞Âú∞ÂúñË≥áÊñôÊ∫ê
                if (map.getSource('global-weather')) {
                    map.getSource('global-weather').setData(globalWeatherData);
                } else {
                    map.addSource('global-weather', {
                        type: 'geojson',
                        data: globalWeatherData
                    });
                }

                updateWeatherSidebar(globalWeatherData);
                updateGlobalStats(globalWeatherData);
                updateStatus('‚úÖ ÂÖ®ÁêÉÂ§©Ê∞£Ë≥áÊñôËºâÂÖ•ÂÆåÊàê');

            } catch (error) {
                console.error('ËºâÂÖ•ÂÖ®ÁêÉÂ§©Ê∞£Ë≥áÊñôÂ§±Êïó:', error);
                updateStatus('‚ùå ËºâÂÖ•Â§±Êïó: ' + error.message);
            }
        }

        // Ë®≠ÂÆöÂú∞ÂúñÂúñÂ±§
        function setupMapLayers() {
            if (!globalWeatherData) return;

            // Ê∞£Ë±°Á´ôÈªûÂúñÂ±§
            if (!map.getLayer('weather-points')) {
                map.addLayer({
                    'id': 'weather-points',
                    'type': 'circle',
                    'source': 'global-weather',
                    'paint': {
                        'circle-radius': [
                            'interpolate', ['linear'], ['zoom'],
                            2, 5, 8, 10, 12, 15
                        ],
                        'circle-color': [
                            'interpolate', ['linear'], ['get', 'temperature'],
                            -20, '#0000ff', 0, '#00ffff', 10, '#00ff00',
                            20, '#ffff00', 30, '#ff8000', 40, '#ff0000'
                        ],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': 0.8
                    }
                });
            }

            // Ê∫´Â∫¶Ê®ôÁ±§
            if (!map.getLayer('temperature-labels')) {
                map.addLayer({
                    'id': 'temperature-labels',
                    'type': 'symbol',
                    'source': 'global-weather',
                    'layout': {
                        'text-field': [
                            'format',
                            ['round', ['get', 'temperature']], {},
                            '¬∞', { 'font-scale': 0.8 }
                        ],
                        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                        'text-size': ['interpolate', ['linear'], ['zoom'], 2, 10, 8, 14],
                        'text-offset': [0, -2.5],
                        'text-anchor': 'center'
                    },
                    'paint': {
                        'text-color': '#2c3e50',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 2
                    }
                });
            }

            // ÂüéÂ∏ÇÂêçÁ®±Ê®ôÁ±§
            if (!map.getLayer('city-labels')) {
                map.addLayer({
                    'id': 'city-labels',
                    'type': 'symbol',
                    'source': 'global-weather',
                    'layout': {
                        'text-field': '{name}',
                        'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
                        'text-size': ['interpolate', ['linear'], ['zoom'], 2, 9, 8, 12],
                        'text-offset': [0, 2.5],
                        'text-anchor': 'center'
                    },
                    'paint': {
                        'text-color': '#34495e',
                        'text-halo-color': '#ffffff',
                        'text-halo-width': 1.5
                    }
                });
            }

            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
            map.on('click', 'weather-points', handleWeatherPointClick);
            map.on('mouseenter', 'weather-points', () => {
                map.getCanvas().style.cursor = 'pointer';
            });
            map.on('mouseleave', 'weather-points', () => {
                map.getCanvas().style.cursor = '';
            });
        }

        // Ë®≠ÂÆöÂ§©Ê∞£ÂúñÂ±§
        function setupWeatherLayers() {
            // ÈôçÈõ®ÂúñÂ±§
            map.addSource('precipitation', {
                'type': 'raster',
                'tiles': [`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${API_KEYS.openweather}`],
                'tileSize': 256
            });

            map.addLayer({
                'id': 'precipitation-layer',
                'type': 'raster',
                'source': 'precipitation',
                'layout': { 'visibility': 'none' },
                'paint': { 'raster-opacity': 0.6 }
            });

            // Èõ≤Â±§ÂúñÂ±§
            map.addSource('clouds', {
                'type': 'raster',
                'tiles': [`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${API_KEYS.openweather}`],
                'tileSize': 256
            });

            map.addLayer({
                'id': 'clouds-layer',
                'type': 'raster',
                'source': 'clouds',
                'layout': { 'visibility': 'none' },
                'paint': { 'raster-opacity': 0.5 }
            });
        }

        // ËôïÁêÜÊ∞£Ë±°Á´ôÈªûÊìä‰∫ã‰ª∂
        function handleWeatherPointClick(e) {
            const props = e.features[0].properties;

            new mapboxgl.Popup({ offset: [0, -15], closeOnClick: true })
                .setLngLat(e.lngLat)
                .setHTML(`
                    <div style="min-width: 320px; font-family: Arial; line-height: 1.4;">
                        <h3 style="margin: 0 0 20px 0; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; font-size: 1.2rem;">
                            üåç ${props.name}, ${props.country}
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">üå°Ô∏è Ê∫´Â∫¶</div>
                                <div style="font-size: 24px; font-weight: bold; margin: 5px 0;">${Math.round(props.temperature)}¬∞C</div>
                                <div style="font-size: 0.8rem; opacity: 0.8;">È´îÊÑü ${Math.round(props.feels_like)}¬∞C</div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9;">üíß ÊøïÂ∫¶</div>
                                <div style="font-size: 24px; font-weight: bold; margin: 5px 0;">${props.humidity}%</div>
                                <div style="font-size: 0.8rem; opacity: 0.8;">Áõ∏Â∞çÊøïÂ∫¶</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <strong>üìä Ê∞£Â£ì</strong><br>
                                <span style="font-size: 16px; color: #2c3e50;">${props.pressure} hPa</span>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <strong>üí® È¢®ÈÄü</strong><br>
                                <span style="font-size: 16px; color: #2c3e50;">${props.wind_speed} m/s</span>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <strong>üëÅÔ∏è ËÉΩË¶ãÂ∫¶</strong><br>
                                <span style="font-size: 14px; color: #2c3e50;">${(props.visibility / 1000).toFixed(1)} km</span>
                            </div>
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;">
                                <strong>‚òÅÔ∏è Èõ≤Èáè</strong><br>
                                <span style="font-size: 14px; color: #2c3e50;">${props.clouds}%</span>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <strong>üå§Ô∏è Â§©Ê∞£ÁãÄÊ≥Å:</strong><br>
                            <span style="font-size: 1.1rem;">${props.weather_description}</span>
                        </div>
                        
                        <div style="text-align: center; color: #7f8c8d; font-size: 0.85rem; border-top: 1px solid #ecf0f1; padding-top: 10px;">
                            üìÖ Êõ¥Êñ∞ÊôÇÈñì: ${new Date(props.timestamp).toLocaleString('zh-TW')}
                        </div>
                    </div>
                `)
                .addTo(map);
        }

        // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÂ§©Ê∞£Ë≥áÊñô
        function updateWeatherSidebar(data) {
            const weatherDataDiv = document.getElementById('weather-data');

            if (!data.features || data.features.length === 0) {
                weatherDataDiv.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Êö´ÁÑ°Â§©Ê∞£Ë≥áÊñô</p>';
                return;
            }

            let filteredFeatures = data.features;
            if (currentFilter !== 'all') {
                filteredFeatures = data.features.filter(f => f.properties.region === currentFilter);
            }

            const weatherCards = filteredFeatures.map(feature => {
                const props = feature.properties;
                return `
                    <div class="weather-card" onclick="focusOnStation(${feature.geometry.coordinates[0]}, ${feature.geometry.coordinates[1]})">
                        <div class="weather-station">
                            ${props.name}, ${props.country}
                            <span style="float: right; font-size: 0.8rem; color: #7f8c8d;">${props.region}</span>
                        </div>
                        <div class="weather-data">
                            <div class="weather-item">
                                <strong>üå°Ô∏è Ê∫´Â∫¶</strong><br>
                                ${Math.round(props.temperature)}¬∞C
                            </div>
                            <div class="weather-item">
                                <strong>üíß ÊøïÂ∫¶</strong><br>
                                ${props.humidity}%
                            </div>
                            <div class="weather-item">
                                <strong>üí® È¢®ÈÄü</strong><br>
                                ${props.wind_speed} m/s
                            </div>
                            <div class="weather-item">
                                <strong>‚òÅÔ∏è Èõ≤Èáè</strong><br>
                                ${props.clouds}%
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            weatherDataDiv.innerHTML = weatherCards || '<p style="text-align: center; color: #7f8c8d;">Ê≠§Âú∞ÂçÄÊö´ÁÑ°Ë≥áÊñô</p>';
        }

        // Êõ¥Êñ∞ÂÖ®ÁêÉÁµ±Ë®à
        function updateGlobalStats(data) {
            if (!data.features) return;

            const temperatures = data.features
                .map(f => f.properties.temperature)
                .filter(t => t !== 'N/A' && !isNaN(t));

            const totalStations = data.features.length;
            const avgTemp = temperatures.length > 0 ?
                (temperatures.reduce((a, b) => a + b, 0) / temperatures.length).toFixed(1) : '--';
            const maxTemp = temperatures.length > 0 ? Math.max(...temperatures).toFixed(1) : '--';
            const minTemp = temperatures.length > 0 ? Math.min(...temperatures).toFixed(1) : '--';

            document.getElementById('total-stations').textContent = totalStations;
            document.getElementById('avg-temp').textContent = avgTemp;
            document.getElementById('max-temp').textContent = maxTemp;
            document.getElementById('min-temp').textContent = minTemp;
        }

        // Âú∞ÂçÄÁØ©ÈÅ∏
        function filterByRegion(region) {
            currentFilter = region;

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.region-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Êõ¥Êñ∞Âú∞ÂúñÁØ©ÈÅ∏
            if (region === 'all') {
                map.setFilter('weather-points', null);
                map.setFilter('temperature-labels', null);
                map.setFilter('city-labels', null);
            } else {
                const filter = ['==', ['get', 'region'], region];
                map.setFilter('weather-points', filter);
                map.setFilter('temperature-labels', filter);
                map.setFilter('city-labels', filter);
            }

            updateWeatherSidebar(globalWeatherData);
            updateStatus(`üåè Â∑≤ÁØ©ÈÅ∏ ${region === 'all' ? 'ÂÖ®ÁêÉ' : region} Âú∞ÂçÄË≥áÊñô`);
        }

        // ÂúñÂ±§ÊéßÂà∂ÂáΩÊï∏
        function toggleWeatherStations() {
            const checkbox = document.getElementById('weather-stations');
            const visibility = checkbox.checked ? 'visible' : 'none';

            ['weather-points', 'temperature-labels', 'city-labels'].forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', visibility);
                }
            });
        }

        function togglePrecipitation() {
            const checkbox = document.getElementById('precipitation-layer');
            const visibility = checkbox.checked ? 'visible' : 'none';

            if (map.getLayer('precipitation-layer')) {
                map.setLayoutProperty('precipitation-layer', 'visibility', visibility);
            }
        }

        function toggleClouds() {
            const checkbox = document.getElementById('clouds-layer');
            const visibility = checkbox.checked ? 'visible' : 'none';

            if (map.getLayer('clouds-layer')) {
                map.setLayoutProperty('clouds-layer', 'visibility', visibility);
            }
        }

        function toggleSatellite() {
            const checkbox = document.getElementById('satellite-layer');
            if (checkbox.checked) {
                map.setStyle('mapbox://styles/mapbox/satellite-v9');
            } else {
                map.setStyle('mapbox://styles/mapbox/light-v11');
            }

            // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÊ∫êÂíåÂúñÂ±§
            map.once('styledata', () => {
                if (globalWeatherData) {
                    map.addSource('global-weather', {
                        type: 'geojson',
                        data: globalWeatherData
                    });
                    setupMapLayers();
                    setupWeatherLayers();
                }
            });
        }

        function toggleOceanTemp() {
            // Êµ∑Ë°®Ê∫´Â∫¶ÂúñÂ±§ÂäüËÉΩ (ÈúÄË¶ÅÈÄ≤‰∏ÄÊ≠•ÂØ¶‰Ωú)
            updateStatus('üåä Êµ∑Ë°®Ê∫´Â∫¶ÂúñÂ±§ÂäüËÉΩÈñãÁôº‰∏≠...');
        }

        // ÈÄèÊòéÂ∫¶ÊéßÂà∂
        function setWeatherOpacity(value) {
            const opacity = value / 100;
            if (map.getLayer('weather-points')) {
                map.setPaintProperty('weather-points', 'circle-opacity', opacity);
            }
        }

        function setPrecipitationOpacity(value) {
            const opacity = value / 100;
            if (map.getLayer('precipitation-layer')) {
                map.setPaintProperty('precipitation-layer', 'raster-opacity', opacity);
            }
        }

        function setCloudsOpacity(value) {
            const opacity = value / 100;
            if (map.getLayer('clouds-layer')) {
                map.setPaintProperty('clouds-layer', 'raster-opacity', opacity);
            }
        }

        function setSatelliteOpacity(value) {
            // Ë°õÊòüÂúñÂ±§ÈÄèÊòéÂ∫¶ÊéßÂà∂
        }

        function setOceanTempOpacity(value) {
            // Êµ∑Ê¥ãÊ∫´Â∫¶ÈÄèÊòéÂ∫¶ÊéßÂà∂
        }

        // Âú∞ÂúñÊéßÂà∂ÂáΩÊï∏
        function focusOnStation(lng, lat) {
            map.flyTo({
                center: [lng, lat],
                zoom: 8,
                duration: 1500
            });
        }

        function refreshAllData() {
            updateStatus('üîÑ Âà∑Êñ∞ÂÖ®ÁêÉË≥áÊñô‰∏≠...');
            loadGlobalWeatherData();
        }

        function showGlobalView() {
            map.flyTo({
                center: [0, 20],
                zoom: 2,
                pitch: 0,
                bearing: 0,
                duration: 2000
            });
            updateStatus('üåç Â∑≤ÂàáÊèõËá≥ÂÖ®ÁêÉË¶ñÂúñ');
        }

        function showTaiwanView() {
            map.flyTo({
                center: [121.0, 23.8],
                zoom: 7,
                pitch: 0,
                bearing: 0,
                duration: 2000
            });
            updateStatus('üáπüáº Â∑≤ÂàáÊèõËá≥Âè∞ÁÅ£Ë¶ñÂúñ');
        }

        function toggle3D() {
            is3D = !is3D;
            map.flyTo({
                pitch: is3D ? 60 : 0,
                bearing: is3D ? 20 : 0,
                duration: 1000
            });
            updateStatus(is3D ? 'üèîÔ∏è Â∑≤ÂïüÁî®3DË¶ñËßí' : 'üó∫Ô∏è Â∑≤ÂàáÊèõËá≥2DË¶ñËßí');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                updateStatus('üì∫ Â∑≤ÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÊ®°Âºè');
            } else {
                document.exitFullscreen();
                updateStatus('ü™ü Â∑≤ÈÄÄÂá∫ÂÖ®Ëû¢ÂπïÊ®°Âºè');
            }
        }

        function updateStatus(message) {
            const now = new Date().toLocaleTimeString('zh-TW');
            document.getElementById('status').textContent = `${now} - ${message}`;
        }

        // ÂàùÂßãÂåñ
        window.addEventListener('load', initMap);

        // Ëá™ÂãïÊõ¥Êñ∞ (ÊØè2Â∞èÊôÇ)
        setInterval(() => {
            updateStatus('‚è∞ Âü∑Ë°åÂÆöÊôÇÊõ¥Êñ∞...');
            refreshAllData();
        }, 2 * 60 * 60 * 1000);

        console.log('üåç ÂÖ®ÁêÉÂ§©Ê∞£Âú∞ÂúñÁ≥ªÁµ±Â∑≤ËºâÂÖ•');
        console.log('üì° Â∑≤Êï¥Âêà OpenWeather API');
        console.log('‚è∞ ÊØè2Â∞èÊôÇËá™ÂãïÊõ¥Êñ∞');
    </script>
</body>

</html>