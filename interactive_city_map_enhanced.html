<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ äº’å‹•å¼åŸå¸‚äººå£åœ°åœ–ç³»çµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .panel {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select,
        button,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        button.secondary:hover {
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* çµ±è¨ˆè³‡è¨Šé¢æ¿ */
        .stats-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .stats-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-header:hover {
            background: linear-gradient(135deg, #218838 0%, #1e8a7a 100%);
        }

        .stats-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .stats-content {
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            max-height: 500px;
            opacity: 1;
        }

        .collapsed .stats-content {
            max-height: 0 !important;
            opacity: 0;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease forwards;
        }

        .stat-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(5px);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }

        .stat-value {
            font-weight: 700;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å€åŸŸå¿«é€Ÿè·³è½‰æŒ‰éˆ• */
        .region-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .region-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border: 2px solid #667eea;
            padding: 0.6rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 80px;
            text-align: center;
        }

        .region-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .region-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            .region-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
                min-width: 60px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header {
                padding: 1rem;
            }
        }

        /* åœ°åœ–å½ˆçª—æ¨£å¼ */
        .mapboxgl-popup-content {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 1.5rem 1.25rem 1.25rem;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .mapboxgl-popup-close-button {
            font-size: 16px;
            padding: 4px;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            line-height: 18px;
        }

        /* åŸå¸‚äººå£é¡¯ç¤ºæ¨£å¼ */
        .city-info {
            padding: 10px;
            min-width: 200px;
        }

        .city-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .city-info p {
            margin: 8px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .population-highlight {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        /* è¼‰å…¥å‹•ç•«æ•ˆæœ */
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        .slide-in-left {
            animation: slideInLeft 0.8s ease-out;
        }

        .slide-in-right {
            animation: slideInRight 0.8s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- æ¨™é¡Œå€åŸŸ -->
        <header class="header">
            <h1>ğŸŒ äº’å‹•å¼åŸå¸‚äººå£åœ°åœ–ç³»çµ±</h1>
            <p>æ¢ç´¢å…¨çƒä¸»è¦åŸå¸‚çš„äººå£åˆ†å¸ƒèˆ‡åœ°ç†è³‡è¨Š - é»æ“ŠåŸå¸‚æŸ¥çœ‹è©³ç´°è³‡æ–™</p>
        </header>

        <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
        <div class="main-content">
            <!-- å´é‚Šæ¬„æ§åˆ¶é¢æ¿ -->
            <aside class="sidebar">
                <!-- åœ°åœ–æ¨£å¼æ§åˆ¶ -->
                <div class="panel">
                    <h3>ğŸ¨ åœ°åœ–æ¨£å¼</h3>
                    <div class="control-group">
                        <label for="mapStyle">é¸æ“‡åœ°åœ–æ¨£å¼</label>
                        <select id="mapStyle" onchange="changeMapStyle(this.value)">
                            <option value="mapbox://styles/mapbox/streets-v12">è¡—é“åœ°åœ–</option>
                            <option value="mapbox://styles/mapbox/outdoors-v12">æˆ¶å¤–åœ°åœ–</option>
                            <option value="mapbox://styles/mapbox/light-v11">æ·ºè‰²åœ°åœ–</option>
                            <option value="mapbox://styles/mapbox/dark-v11">æ·±è‰²åœ°åœ–</option>
                            <option value="mapbox://styles/mapbox/satellite-v9">è¡›æ˜Ÿåœ°åœ–</option>
                            <option value="mapbox://styles/mapbox/satellite-streets-v12">è¡›æ˜Ÿè¡—é“</option>
                            <option value="mapbox://styles/mapbox/navigation-day-v1">å°èˆªæ—¥é–“</option>
                            <option value="mapbox://styles/mapbox/navigation-night-v1">å°èˆªå¤œé–“</option>
                        </select>
                    </div>
                </div>

                <!-- 3Dè¦–è§’æ§åˆ¶ -->
                <div class="panel">
                    <h3>ğŸ—ï¸ 3D è¦–è§’</h3>
                    <div class="control-group">
                        <label for="view3D">è¦–è§’æ¨¡å¼</label>
                        <select id="view3D" onchange="change3DView(this.value)">
                            <option value="2d">å¹³é¢è¦–è§’ (2D)</option>
                            <option value="3d-low">è¼•å¾®å‚¾æ–œ (3D)</option>
                            <option value="3d-medium">ä¸­åº¦å‚¾æ–œ (3D)</option>
                            <option value="3d-high">é«˜åº¦å‚¾æ–œ (3D)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button onclick="toggle3DBuildings()" id="buildingsToggle" class="btn secondary">
                            ğŸ¢ é¡¯ç¤ºå»ºç¯‰ç‰©
                        </button>
                    </div>
                </div>

                <!-- é¡¯ç¤ºæ§åˆ¶ -->
                <div class="panel">
                    <h3>ğŸŒ é¡¯ç¤ºèªè¨€</h3>
                    <div class="control-group">
                        <label for="labelLanguage">åŸå¸‚åç¨±èªè¨€</label>
                        <select id="labelLanguage" onchange="changeLabelLanguage(this.value)">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                            <option value="default">é è¨­ (å¤šèª)</option>
                        </select>
                    </div>
                </div>

                <!-- æ•¸æ“šé»æ¨£å¼ -->
                <div class="panel">
                    <h3>ğŸ“ é»æ¨£å¼æ¨¡å¼</h3>
                    <div class="control-group">
                        <label for="pointStyleMode">æ•¸æ“šé»å¤§å°</label>
                        <select id="pointStyleMode" onchange="changePointStyleMode(this.value)">
                            <option value="population">æŒ‰äººå£èª¿æ•´å¤§å°</option>
                            <option value="fixed">çµ±ä¸€å¤§å°</option>
                        </select>
                    </div>
                </div>

                <!-- æ§åˆ¶æŒ‰éˆ• -->
                <div class="panel">
                    <h3>ğŸ”§ æ§åˆ¶åŠŸèƒ½</h3>
                    <div class="control-group">
                        <button onclick="resetMapView()">ğŸ” é‡ç½®è¦–åœ–</button>
                    </div>
                    <div class="control-group">
                        <button onclick="toggleFullscreen()">ğŸ“º å…¨è¢å¹•æ¨¡å¼</button>
                    </div>
                    <div class="control-group">
                        <button onclick="returnToPreviousView()" id="returnViewBtn"
                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: none;">ğŸ”™
                            è¿”å›ä¹‹å‰è¦–åœ–</button>
                    </div>
                </div>

                <!-- çµ±è¨ˆè³‡è¨Šé¢æ¿ -->
                <div class="stats-container" id="statsPanel">
                    <div class="stats-header" onclick="toggleStatsPanel()">
                        <h3 class="stats-title">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h3>
                        <span class="toggle-icon" id="toggleIcon">â–¼</span>
                    </div>
                    <div class="stats-content" id="statsContent">
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">ğŸ™ï¸ åŸå¸‚æ•¸é‡</span>
                            <span class="stat-value" id="cityCount">25</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">ğŸ‘¥ ç¸½äººå£</span>
                            <span class="stat-value" id="totalPopulation">310.6M</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">ğŸ“ˆ å¹³å‡äººå£</span>
                            <span class="stat-value" id="avgPopulation">12.4M</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">ğŸŒŸ æœ€å¤§åŸå¸‚</span>
                            <span class="stat-value" id="largestCity">æ±äº¬</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">ğŸ” ç•¶å‰ç¸®æ”¾</span>
                            <span class="stat-value" id="currentZoom">2.0</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">â° æœ€å¾Œæ›´æ–°</span>
                            <span class="stat-value" id="lastUpdate">è¼‰å…¥ä¸­...</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- åœ°åœ–å®¹å™¨ -->
            <main class="map-container">
                <div id="map"></div>

                <!-- å€åŸŸå¿«é€Ÿè·³è½‰æŒ‰éˆ• -->
                <div class="region-buttons">
                    <button class="region-btn" onclick="resetMapView()" style="background: #667eea; color: white;">ğŸŒ
                        å…¨çƒ</button>
                    <button class="region-btn" onclick="flyToRegion('asia')">ğŸ® äºæ´²</button>
                    <button class="region-btn" onclick="flyToRegion('europe')">ğŸ° æ­æ´²</button>
                    <button class="region-btn" onclick="flyToRegion('america')">ğŸ—½ ç¾æ´²</button>
                    <button class="region-btn" onclick="flyToRegion('africa')">ğŸ¦ éæ´²</button>
                    <button class="region-btn" onclick="flyToRegion('oceania')">ğŸ„ å¤§æ´‹æ´²</button>
                </div>

                <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>æ­£åœ¨è¼‰å…¥åœ°åœ–...</div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // å…¨åŸŸè®Šæ•¸
        let map;
        let currentLanguage = 'zh';
        let pointStyleMode = 'population';
        let statsCollapsed = false;
        let previousView = null; // å„²å­˜é»æ“Šå‰çš„è¦–åœ–ç‹€æ…‹

        // èªè¨€é…ç½®
        const LABEL_LAYER_IDS = [
            'country-label', 'country-label-sm', 'state-label',
            'settlement-label', 'settlement-subdivision-label',
            'settlement-label-sm', 'settlement-subdivision-label-sm',
            'airport-label', 'waterway-label', 'poi-label',
            'road-label', 'road-label-navigation', 'road-label-small'
        ];

        const LANGUAGE_FIELDS = {
            zh: ['coalesce',
                ['get', 'name_zh-Hant'],
                ['get', 'name_zh-Hans'],
                ['get', 'name_zh'],
                ['get', 'name'],
                ['get', 'name_en']
            ],
            en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
            default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
        };

        const LANGUAGE_DISPLAY_NAMES = {
            zh: 'ä¸­æ–‡',
            en: 'English',
            default: 'é è¨­ (å¤šèª)'
        };

        // åŸå¸‚æ•¸æ“š (25å€‹å…¨çƒä¸»è¦åŸå¸‚)
        const CITY_DATA = [
            { name_zh: 'æ±äº¬', name_en: 'Tokyo', coordinates: [139.6917, 35.6895], population: 37400068, country: 'æ—¥æœ¬' },
            { name_zh: 'é›…åŠ é”', name_en: 'Jakarta', coordinates: [106.8650, -6.1751], population: 10562088, country: 'å°å°¼' },
            { name_zh: 'å¾·é‡Œ', name_en: 'Delhi', coordinates: [77.1025, 28.7041], population: 29399141, country: 'å°åº¦' },
            { name_zh: 'é¦¬å°¼æ‹‰', name_en: 'Manila', coordinates: [120.9842, 14.5995], population: 13482462, country: 'è²å¾‹è³“' },
            { name_zh: 'ä¸Šæµ·', name_en: 'Shanghai', coordinates: [121.4737, 31.2304], population: 24870895, country: 'ä¸­åœ‹' },
            { name_zh: 'è–ä¿ç¾…', name_en: 'SÃ£o Paulo', coordinates: [-46.6333, -23.5505], population: 21831000, country: 'å·´è¥¿' },
            { name_zh: 'é¦–çˆ¾', name_en: 'Seoul', coordinates: [126.9780, 37.5665], population: 9733509, country: 'éŸ“åœ‹' },
            { name_zh: 'å¢¨è¥¿å“¥åŸ', name_en: 'Mexico City', coordinates: [-99.1332, 19.4326], population: 21581000, country: 'å¢¨è¥¿å“¥' },
            { name_zh: 'é–‹ç¾…', name_en: 'Cairo', coordinates: [31.2357, 30.0444], population: 18772000, country: 'åŸƒåŠ' },
            { name_zh: 'å­Ÿè²·', name_en: 'Mumbai', coordinates: [72.8777, 19.0760], population: 19980000, country: 'å°åº¦' },
            { name_zh: 'åŒ—äº¬', name_en: 'Beijing', coordinates: [116.4074, 39.9042], population: 21542000, country: 'ä¸­åœ‹' },
            { name_zh: 'é”å¡', name_en: 'Dhaka', coordinates: [90.4125, 23.8103], population: 20284000, country: 'å­ŸåŠ æ‹‰' },
            { name_zh: 'å¤§é˜ª', name_en: 'Osaka', coordinates: [135.5023, 34.6937], population: 19222665, country: 'æ—¥æœ¬' },
            { name_zh: 'ç´ç´„', name_en: 'New York', coordinates: [-74.0059, 40.7128], population: 18819000, country: 'ç¾åœ‹' },
            { name_zh: 'å¡æ‹‰å¥‡', name_en: 'Karachi', coordinates: [67.0011, 24.8607], population: 14910352, country: 'å·´åŸºæ–¯å¦' },
            { name_zh: 'å¸ƒå®œè«¾æ–¯è‰¾åˆ©æ–¯', name_en: 'Buenos Aires', coordinates: [-58.3816, -34.6037], population: 14967000, country: 'é˜¿æ ¹å»·' },
            { name_zh: 'é„­å·', name_en: 'Zhengzhou', coordinates: [113.6254, 34.7466], population: 10120000, country: 'ä¸­åœ‹' },
            { name_zh: 'ä¼Šæ–¯å¦å ¡', name_en: 'Istanbul', coordinates: [28.9784, 41.0082], population: 14751000, country: 'åœŸè€³å…¶' },
            { name_zh: 'é‡æ…¶', name_en: 'Chongqing', coordinates: [106.9128, 29.4316], population: 14838000, country: 'ä¸­åœ‹' },
            { name_zh: 'æ‹‰å„æ–¯', name_en: 'Lagos', coordinates: [3.3792, 6.5244], population: 13463000, country: 'å¥ˆåŠåˆ©äº' },
            { name_zh: 'é¦¬å¾·é‡Œ', name_en: 'Madrid', coordinates: [-3.7038, 40.4168], population: 6155116, country: 'è¥¿ç­ç‰™' },
            { name_zh: 'å°åŒ—', name_en: 'Taipei', coordinates: [121.5654, 25.0330], population: 2700000, country: 'å°ç£' },
            { name_zh: 'é¦™æ¸¯', name_en: 'Hong Kong', coordinates: [114.1694, 22.3193], population: 7496981, country: 'é¦™æ¸¯' },
            { name_zh: 'æ–°åŠ å¡', name_en: 'Singapore', coordinates: [103.8198, 1.3521], population: 5850342, country: 'æ–°åŠ å¡' },
            { name_zh: 'å€«æ•¦', name_en: 'London', coordinates: [-0.1276, 51.5074], population: 8982000, country: 'è‹±åœ‹' }
        ];

        // å€åŸŸåæ¨™
        const REGIONS = {
            asia: { center: [116, 35], zoom: 3 },
            europe: { center: [10, 50], zoom: 3.5 },
            america: { center: [-74, 40], zoom: 2.5 },
            africa: { center: [20, 0], zoom: 2.5 },
            oceania: { center: [151, -33], zoom: 4 }
        };

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            showLoading(true);

            // è¨­å®š Mapbox Access Token
            mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlLWRuYSIsImEiOiJjbWZ5MTlhOTkwZnF3MmxvbjkwN2RtM2Z4In0.yFiY2MNpWqaDINuLaz1e0w';

            // å»ºç«‹åœ°åœ–å¯¦ä¾‹
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [121.5654, 25.0330], // å°åŒ—ç‚ºä¸­å¿ƒ
                zoom: 2,
                pitch: 0,
                bearing: 0
            });

            // åœ°åœ–è¼‰å…¥å®Œæˆäº‹ä»¶
            map.on('load', function () {
                console.log('ğŸ—ºï¸ åœ°åœ–è¼‰å…¥å®Œæˆ');

                // æ·»åŠ æ§ä»¶
                map.addControl(new mapboxgl.NavigationControl());
                map.addControl(new mapboxgl.FullscreenControl());
                map.addControl(new mapboxgl.ScaleControl({
                    maxWidth: 100,
                    unit: 'metric'
                }));

                // æ‡‰ç”¨åœ°åœ–æ¨™ç±¤èªè¨€
                applyMapLabelLanguage(currentLanguage);

                // è¼‰å…¥åŸå¸‚æ•¸æ“š
                loadCityData();
                updateStats();

                // ç›£è½åœ°åœ–ç§»å‹•äº‹ä»¶
                map.on('moveend', updateStats);
                map.on('zoomend', updateStats);

                showLoading(false);
            });

            // éŒ¯èª¤è™•ç†
            map.on('error', function (e) {
                console.error('åœ°åœ–è¼‰å…¥éŒ¯èª¤:', e);
                showLoading(false);
            });
        }

        // è¼‰å…¥åŸå¸‚æ•¸æ“š
        function loadCityData() {
            if (!map) return;

            // æº–å‚™ GeoJSON æ•¸æ“š
            const geojsonData = {
                type: 'FeatureCollection',
                features: CITY_DATA.map(city => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: city.coordinates
                    },
                    properties: {
                        name_zh: city.name_zh,
                        name_en: city.name_en,
                        population: city.population,
                        country: city.country
                    }
                }))
            };

            // æ·»åŠ æ•¸æ“šæº
            map.addSource('cities', {
                type: 'geojson',
                data: geojsonData
            });

            // æ·»åŠ åŸå¸‚åœ“é»å±¤
            map.addLayer({
                id: 'cities',
                type: 'circle',
                source: 'cities',
                paint: {
                    'circle-radius': getCircleRadius(),
                    'circle-color': getCircleColor(),
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });

            // æ·»åŠ åŸå¸‚æ¨™ç±¤å±¤
            map.addLayer({
                id: 'city-labels',
                type: 'symbol',
                source: 'cities',
                layout: {
                    'text-field': getCityNameExpression(),
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-offset': [0, 1.5],
                    'text-anchor': 'top',
                    'text-size': 12
                },
                paint: {
                    'text-color': '#333',
                    'text-halo-color': '#fff',
                    'text-halo-width': 1
                }
            });

            // æ·»åŠ é»æ“Šäº‹ä»¶
            map.on('click', 'cities', onCityClick);
            map.on('mouseenter', 'cities', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'cities', () => map.getCanvas().style.cursor = '');
        }

        // ç²å–åœ“é»åŠå¾‘è¡¨é”å¼
        function getCircleRadius() {
            if (pointStyleMode === 'population') {
                return [
                    'interpolate',
                    ['linear'],
                    ['get', 'population'],
                    1000000, 8,
                    10000000, 15,
                    20000000, 25,
                    40000000, 35
                ];
            } else {
                return 12;
            }
        }

        // ç²å–åœ“é»é¡è‰²è¡¨é”å¼
        function getCircleColor() {
            if (pointStyleMode === 'population') {
                return [
                    'interpolate',
                    ['linear'],
                    ['get', 'population'],
                    1000000, '#FED976',
                    5000000, '#FD8D3C',
                    10000000, '#E31A1C',
                    20000000, '#800026'
                ];
            } else {
                return '#3b82f6';
            }
        }

        // ç²å–åŸå¸‚åç¨±è¡¨é”å¼
        function getCityNameExpression() {
            const CITY_LANGUAGE_FIELDS = {
                zh: ['coalesce', ['get', 'name_zh'], ['get', 'name_en'], ['get', 'name']],
                en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
                default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
            };
            return CITY_LANGUAGE_FIELDS[currentLanguage] || CITY_LANGUAGE_FIELDS.default;
        }

        // ç²å–æœ¬åœ°åŒ–åŸå¸‚åç¨±
        function getLocalizedCityName(properties, language = currentLanguage) {
            if (!properties) return 'æœªçŸ¥åŸå¸‚';

            const languageOrder = {
                zh: ['name_zh', 'name', 'name_en'],
                en: ['name_en', 'name', 'name_zh'],
                default: ['name', 'name_en', 'name_zh']
            };

            const keys = languageOrder[language] || languageOrder.default;
            for (const key of keys) {
                if (properties[key]) {
                    return properties[key];
                }
            }

            return properties.name || properties.name_zh || properties.name_en || 'æœªçŸ¥åŸå¸‚';
        }

        // åŸå¸‚é»æ“Šäº‹ä»¶
        function onCityClick(e) {
            const feature = e.features[0];
            const coordinates = feature.geometry.coordinates.slice();
            const properties = feature.properties;

            const cityName = getLocalizedCityName(properties);
            const population = properties.population;

            // å„²å­˜ç•¶å‰è¦–åœ–ç‹€æ…‹ï¼ˆé»æ“Šå‰çš„ç‹€æ…‹ï¼‰
            previousView = {
                center: map.getCenter(),
                zoom: map.getZoom(),
                pitch: map.getPitch(),
                bearing: map.getBearing()
            };

            // é¡¯ç¤ºè¿”å›æŒ‰éˆ•
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'block';
            }

            console.log('ğŸ’¾ å·²å„²å­˜ç•¶å‰è¦–åœ–ç‹€æ…‹:', {
                zoom: previousView.zoom.toFixed(2),
                center: [previousView.center.lng.toFixed(4), previousView.center.lat.toFixed(4)]
            });

            // æ™ºèƒ½ç¸®æ”¾é‚è¼¯
            const currentZoom = map.getZoom();
            let targetZoom;

            if (currentZoom < 5) {
                targetZoom = 10; // å¾é è·é›¢è¦–åœ–æ”¾å¤§åˆ°åŸå¸‚ç´šåˆ¥
            } else if (currentZoom < 8) {
                targetZoom = 12; // å¾ä¸­ç­‰è·é›¢æ”¾å¤§åˆ°è©³ç´°ç´šåˆ¥
            } else {
                targetZoom = Math.min(currentZoom + 3, 15); // å·²ç¶“å¾ˆè¿‘æ™‚é©åº¦æ”¾å¤§
            }

            // é¡¯ç¤ºé£›è¡Œä¸­çš„æç¤º
            console.log(`ğŸš é£›è¡Œåˆ° ${cityName} (ç¸®æ”¾: ${currentZoom.toFixed(1)} â†’ ${targetZoom})`);

            map.flyTo({
                center: coordinates,
                zoom: targetZoom,
                duration: 1500, // 1.5ç§’çš„é£›è¡Œå‹•ç•«
                curve: 1.2, // é£›è¡Œè·¯å¾‘çš„å½æ›²åº¦
                easing: function (t) {
                    // ç·©å‹•å‡½æ•¸ï¼Œè®“å‹•ç•«æ›´æµæš¢
                    return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                }
            });

            // å…ˆé—œé–‰æ‰€æœ‰ç¾æœ‰å½ˆçª—ï¼Œé¿å…è¡çª
            const existingPopups = document.querySelectorAll('.mapboxgl-popup');
            existingPopups.forEach(popup => popup.remove());

            // å»¶é²é¡¯ç¤ºå½ˆçª—ï¼Œç­‰å¾…é£›è¡Œå‹•ç•«å®Œæˆä¸€åŠ
            setTimeout(() => {
                // å‰µå»ºå½ˆçª—å…§å®¹
                const popupContent = `
                    <div class="city-info">
                        <h3>${cityName}</h3>
                        <p><strong>åœ‹å®¶/åœ°å€ï¼š</strong>${properties.country}</p>
                        <p><strong>äººå£æ•¸é‡ï¼š</strong><span class="population-highlight">${population.toLocaleString()}</span> äºº</p>
                        <p><strong>åº§æ¨™ä½ç½®ï¼š</strong>${coordinates[1].toFixed(4)}, ${coordinates[0].toFixed(4)}</p>
                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.8rem; color: #666;">
                            ğŸ’¡ é—œé–‰æ­¤å½ˆçª—å°‡è¿”å›åŸæœ¬è¦–åœ–
                        </div>
                    </div>
                `;

                // å‰µå»ºæ–°å½ˆçª—
                const popup = new mapboxgl.Popup({
                    closeButton: true,
                    closeOnClick: false,
                    maxWidth: '300px',
                    focusAfterOpen: false // é˜²æ­¢ç„¦é»å•é¡Œå°è‡´çš„äº‹ä»¶è¡çª
                })
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);

                // ç¢ºä¿å½ˆçª—æ­£ç¢ºé¡¯ç¤ºå¾Œå†ç›£è½äº‹ä»¶
                setTimeout(() => {
                    // ç›£è½å½ˆçª—é—œé–‰äº‹ä»¶
                    popup.on('close', function () {
                        console.log('ğŸ”™ å½ˆçª—é—œé–‰äº‹ä»¶è§¸ç™¼');
                        if (previousView) {
                            console.log('ğŸ”™ åŸ·è¡Œè¿”å›ä¹‹å‰çš„è¦–åœ–');
                            // ä½¿ç”¨ setTimeout ç¢ºä¿äº‹ä»¶è™•ç†å®Œæˆå¾Œå†åŸ·è¡Œè¿”å›
                            setTimeout(() => {
                                returnToPreviousView();
                            }, 100);
                        }
                    });

                    // æ·»åŠ é¡å¤–çš„é»æ“Šç›£è½ï¼Œç¢ºä¿é—œé–‰æŒ‰éˆ•æ­£å¸¸å·¥ä½œ
                    const closeButton = document.querySelector('.mapboxgl-popup-close-button');
                    if (closeButton) {
                        closeButton.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ğŸ”™ é—œé–‰æŒ‰éˆ•ç›´æ¥é»æ“Šäº‹ä»¶');
                            popup.remove();
                            if (previousView) {
                                setTimeout(() => {
                                    returnToPreviousView();
                                }, 100);
                            }
                        }, { once: true }); // åªåŸ·è¡Œä¸€æ¬¡
                    }
                }, 50); // ç­‰å¾…å½ˆçª—å®Œå…¨æ¸²æŸ“
            }, 800); // ç­‰å¾…800æ¯«ç§’å†é¡¯ç¤ºå½ˆçª—
        }

        // æ‡‰ç”¨åœ°åœ–æ¨™ç±¤èªè¨€
        function applyMapLabelLanguage(language) {
            if (!map) return;

            const applyToLayers = () => {
                const field = LANGUAGE_FIELDS[language] || LANGUAGE_FIELDS.default;

                LABEL_LAYER_IDS.forEach(layerId => {
                    if (map.getLayer(layerId)) {
                        try {
                            map.setLayoutProperty(layerId, 'text-field', field);
                        } catch (error) {
                            console.warn(`âš ï¸  ç„¡æ³•æ›´æ–°åœ–å±¤ ${layerId} çš„æ¨™ç±¤èªè¨€`, error);
                        }
                    }
                });

                // è™•ç†å…¶ä»–å¯èƒ½çš„æ¨™ç±¤åœ–å±¤
                const style = map.getStyle();
                if (style && Array.isArray(style.layers)) {
                    style.layers.forEach(layer => {
                        if (!layer || layer.type !== 'symbol') return;
                        if (!layer.layout || !layer.layout['text-field']) return;
                        if (layer.id && layer.id.includes('city')) return; // è·³éåŸå¸‚æ¨™ç±¤

                        const textField = layer.layout['text-field'];
                        const textFieldString = typeof textField === 'string'
                            ? textField
                            : Array.isArray(textField)
                                ? JSON.stringify(textField)
                                : '';

                        if (textFieldString.includes('name') && layer.id.includes('label')) {
                            try {
                                map.setLayoutProperty(layer.id, 'text-field', field);
                            } catch (error) {
                                console.warn(`âš ï¸  ç„¡æ³•æ›´æ–°åœ–å±¤ ${layer.id} çš„æ¨™ç±¤èªè¨€`, error);
                            }
                        }
                    });
                }
            };

            if (!map.isStyleLoaded()) {
                map.once('styledata', applyToLayers);
                return;
            }

            applyToLayers();
        }

        // æ”¹è®Šåœ°åœ–æ¨£å¼
        function changeMapStyle(styleUrl) {
            if (!map) return;

            showLoading(true, 'åˆ‡æ›åœ°åœ–æ¨£å¼ä¸­...');
            map.setStyle(styleUrl);

            map.once('styledata', () => {
                applyMapLabelLanguage(currentLanguage);
                loadCityData();
                showLoading(false);
            });
        }

        // æ”¹è®Šæ¨™ç±¤èªè¨€
        function changeLabelLanguage(language) {
            currentLanguage = language;

            // æ‡‰ç”¨åœ°åœ–æ¨™ç±¤èªè¨€
            applyMapLabelLanguage(language);

            // æ›´æ–°åŸå¸‚æ¨™ç±¤
            if (map && map.getLayer('city-labels')) {
                try {
                    map.setLayoutProperty('city-labels', 'text-field', getCityNameExpression());
                } catch (error) {
                    console.warn('âš ï¸  ç„¡æ³•æ›´æ–°åŸå¸‚æ¨™ç±¤èªè¨€', error);
                }
            }

            // æ›´æ–°èªè¨€é¸æ“‡å™¨
            const languageSelect = document.getElementById('labelLanguage');
            if (languageSelect && languageSelect.value !== language) {
                languageSelect.value = language;
            }

            // æ›´æ–°çµ±è¨ˆè³‡æ–™
            updateStats();

            const displayName = LANGUAGE_DISPLAY_NAMES[language] || LANGUAGE_DISPLAY_NAMES.default;
            console.log('ğŸŒ èªè¨€å·²åˆ‡æ›ç‚º:', displayName);
        }

        // æ”¹è®Šé»æ¨£å¼æ¨¡å¼
        function changePointStyleMode(mode) {
            pointStyleMode = mode;
            if (map && map.getLayer('cities')) {
                map.setPaintProperty('cities', 'circle-radius', getCircleRadius());
                map.setPaintProperty('cities', 'circle-color', getCircleColor());
            }
        }

        // é£›è¡Œåˆ°å€åŸŸ
        function flyToRegion(region) {
            if (!map || !REGIONS[region]) return;

            const regionNames = {
                asia: 'äºæ´²',
                europe: 'æ­æ´²',
                america: 'ç¾æ´²',
                africa: 'éæ´²',
                oceania: 'å¤§æ´‹æ´²'
            };

            console.log(`ğŸŒ é£›è¡Œåˆ° ${regionNames[region] || region}`);

            // é—œé–‰æ‰€æœ‰å½ˆçª—
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => popup.remove());

            // æ¸…é™¤ä¹‹å‰è¦–åœ–ç‹€æ…‹
            previousView = null;

            // éš±è—è¿”å›æŒ‰éˆ•
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            const { center, zoom } = REGIONS[region];
            map.flyTo({
                center: center,
                zoom: zoom,
                duration: 2000,
                curve: 1.3,
                easing: function (t) {
                    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; // ease-in-out cubic
                }
            });
        }

        // è¿”å›ä¹‹å‰çš„è¦–åœ–
        function returnToPreviousView() {
            if (!map || !previousView) {
                console.log('âš ï¸  æ²’æœ‰å„²å­˜çš„è¦–åœ–ç‹€æ…‹');
                return;
            }

            console.log('ğŸ”™ è¿”å›ä¹‹å‰çš„è¦–åœ–:', {
                zoom: previousView.zoom.toFixed(2),
                center: [previousView.center.lng.toFixed(4), previousView.center.lat.toFixed(4)]
            });

            // ç¢ºä¿æ‰€æœ‰å½ˆçª—éƒ½è¢«é—œé–‰
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('æ¸…ç†å½ˆçª—æ™‚å‡ºç¾éŒ¯èª¤:', error);
                }
            });

            map.flyTo({
                center: [previousView.center.lng, previousView.center.lat],
                zoom: previousView.zoom,
                pitch: previousView.pitch,
                bearing: previousView.bearing,
                duration: 1200, // ç¨å¾®å¿«ä¸€é»çš„è¿”å›å‹•ç•«
                curve: 1.1,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2); // ease-out quadraticï¼Œæ›´è¼•å¿«çš„æ„Ÿè¦º
                }
            });

            // æ¸…é™¤å„²å­˜çš„è¦–åœ–ç‹€æ…‹
            previousView = null;

            // éš±è—è¿”å›æŒ‰éˆ•
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            console.log('âœ… è¿”å›è¦–åœ–æ“ä½œå®Œæˆ');
        }

        // é‡ç½®åœ°åœ–è¦–åœ–
        function resetMapView() {
            if (!map) return;

            console.log('ğŸŒ è¿”å›å…¨çƒè¦–åœ–');

            // é—œé–‰æ‰€æœ‰å½ˆçª—
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => popup.remove());

            // æ¸…é™¤ä¹‹å‰è¦–åœ–ç‹€æ…‹
            previousView = null;

            // éš±è—è¿”å›æŒ‰éˆ•
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            map.flyTo({
                center: [20, 20], // å…¨çƒä¸­å¿ƒé»
                zoom: 2,
                pitch: 0,
                bearing: 0,
                duration: 2000,
                curve: 1.5, // æ›´å¤§çš„å½æ›²åº¦è®“é£›è¡Œæ›´å„ªé›…
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 3); // ease-out cubic
                }
            });
        }

        // åˆ‡æ›å…¨è¢å¹•æ¨¡å¼
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // å…¨å±€è®Šé‡è¿½è¹¤ 3D ç‹€æ…‹
        let buildingsLayerVisible = false;

        // åˆ‡æ› 3D è¦–è§’
        function change3DView(viewMode) {
            if (!map) return;

            console.log('ğŸ—ï¸ åˆ‡æ› 3D è¦–è§’:', viewMode);

            let pitch = 0;
            let bearing = map.getBearing(); // ä¿æŒç•¶å‰æ–¹å‘

            switch (viewMode) {
                case '2d':
                    pitch = 0;
                    console.log('ğŸ“ åˆ‡æ›åˆ°å¹³é¢è¦–è§’');
                    break;
                case '3d-low':
                    pitch = 30;
                    console.log('ğŸ“ åˆ‡æ›åˆ°è¼•å¾®å‚¾æ–œè¦–è§’');
                    break;
                case '3d-medium':
                    pitch = 45;
                    console.log('ğŸ“ åˆ‡æ›åˆ°ä¸­åº¦å‚¾æ–œè¦–è§’');
                    break;
                case '3d-high':
                    pitch = 60;
                    console.log('ğŸ“ åˆ‡æ›åˆ°é«˜åº¦å‚¾æ–œè¦–è§’');
                    break;
                default:
                    pitch = 0;
            }

            // å¹³æ»‘éæ¸¡åˆ°æ–°çš„è¦–è§’
            map.flyTo({
                pitch: pitch,
                bearing: bearing,
                duration: 1500,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2); // ease-out quadratic
                }
            });

            // å¦‚æœæ˜¯ 3D è¦–è§’ï¼Œè‡ªå‹•é¡¯ç¤ºå»ºç¯‰ç‰©æç¤º
            if (pitch > 0 && !buildingsLayerVisible) {
                setTimeout(() => {
                    console.log('ğŸ’¡ æç¤º: æ‚¨å¯ä»¥é–‹å•Ÿå»ºç¯‰ç‰©åœ–å±¤ä»¥ç²å¾—æ›´å¥½çš„ 3D æ•ˆæœ');
                }, 1000);
            }
        }

        // åˆ‡æ›å»ºç¯‰ç‰©åœ–å±¤
        function toggle3DBuildings() {
            if (!map) return;

            const layerId = '3d-buildings';
            const button = document.getElementById('buildingsToggle');

            try {
                if (buildingsLayerVisible) {
                    // éš±è—å»ºç¯‰ç‰©
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', 'none');
                    }
                    buildingsLayerVisible = false;
                    button.textContent = 'ğŸ¢ é¡¯ç¤ºå»ºç¯‰ç‰©';
                    button.classList.remove('active');
                    console.log('ğŸ¢ å·²éš±è—å»ºç¯‰ç‰©åœ–å±¤');
                } else {
                    // é¡¯ç¤ºå»ºç¯‰ç‰©
                    if (!map.getLayer(layerId)) {
                        // å¦‚æœåœ–å±¤ä¸å­˜åœ¨ï¼Œæ·»åŠ å®ƒ
                        add3DBuildingsLayer();
                    } else {
                        map.setLayoutProperty(layerId, 'visibility', 'visible');
                    }
                    buildingsLayerVisible = true;
                    button.textContent = 'ğŸ—ï¸ éš±è—å»ºç¯‰ç‰©';
                    button.classList.add('active');
                    console.log('ğŸ¢ å·²é¡¯ç¤ºå»ºç¯‰ç‰©åœ–å±¤');

                    // å¦‚æœç•¶å‰æ˜¯ 2D è¦–è§’ï¼Œå»ºè­°åˆ‡æ›åˆ° 3D
                    if (map.getPitch() === 0) {
                        console.log('ğŸ’¡ å»ºè­°: åˆ‡æ›åˆ° 3D è¦–è§’ä»¥ç²å¾—æ›´å¥½çš„å»ºç¯‰ç‰©æ•ˆæœ');
                    }
                }
            } catch (error) {
                console.error('âŒ åˆ‡æ›å»ºç¯‰ç‰©åœ–å±¤æ™‚å‡ºéŒ¯:', error);
            }
        }

        // æ·»åŠ  3D å»ºç¯‰ç‰©åœ–å±¤
        function add3DBuildingsLayer() {
            if (!map) return;

            // ç­‰å¾…åœ°åœ–æ¨£å¼å®Œå…¨è¼‰å…¥
            if (!map.isStyleLoaded()) {
                map.once('styledata', add3DBuildingsLayer);
                return;
            }

            try {
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰å»ºç¯‰ç‰©æ•¸æ“šæº
                if (!map.getSource('composite')) {
                    console.warn('âš ï¸ ç•¶å‰åœ°åœ–æ¨£å¼ä¸æ”¯æ´å»ºç¯‰ç‰©åœ–å±¤');
                    return;
                }

                const layerId = '3d-buildings';

                // å¦‚æœåœ–å±¤å·²å­˜åœ¨ï¼Œç§»é™¤å®ƒ
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }

                // æ·»åŠ  3D å»ºç¯‰ç‰©åœ–å±¤
                map.addLayer({
                    id: layerId,
                    source: 'composite',
                    'source-layer': 'building',
                    filter: ['==', 'extrude', 'true'],
                    type: 'fill-extrusion',
                    minzoom: 15,
                    paint: {
                        'fill-extrusion-color': [
                            'case',
                            ['>', ['get', 'height'], 100], '#667eea',  // é«˜æ¨“ - è—è‰²
                            ['>', ['get', 'height'], 50], '#764ba2',   // ä¸­æ¨“ - ç´«è‰²
                            '#95a5a6'  // ä½æ¨“ - ç°è‰²
                        ],
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.8
                    }
                });

                console.log('ğŸ—ï¸ 3D å»ºç¯‰ç‰©åœ–å±¤å·²æ·»åŠ ');
            } catch (error) {
                console.error('âŒ æ·»åŠ å»ºç¯‰ç‰©åœ–å±¤å¤±æ•—:', error);
                console.warn('âš ï¸ ç•¶å‰åœ°åœ–æ¨£å¼å¯èƒ½ä¸æ”¯æ´ 3D å»ºç¯‰ç‰©');
            }
        }

        // åˆ‡æ›çµ±è¨ˆé¢æ¿
        function toggleStatsPanel() {
            const panel = document.getElementById('statsPanel');
            const icon = document.getElementById('toggleIcon');

            statsCollapsed = !statsCollapsed;

            if (statsCollapsed) {
                panel.classList.add('collapsed');
                icon.textContent = 'â–¶';
            } else {
                panel.classList.remove('collapsed');
                icon.textContent = 'â–¼';
                updateStats();
            }
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStats() {
            if (!map) return;

            const totalPopulation = CITY_DATA.reduce((sum, city) => sum + city.population, 0);
            const avgPopulation = totalPopulation / CITY_DATA.length;
            const largestCity = CITY_DATA.reduce((max, city) =>
                city.population > max.population ? city : max
            );

            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            document.getElementById('cityCount').textContent = CITY_DATA.length;
            document.getElementById('totalPopulation').textContent = (totalPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('avgPopulation').textContent = (avgPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('largestCity').textContent = getLocalizedCityName(largestCity);
            document.getElementById('currentZoom').textContent = map.getZoom().toFixed(1);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
        function showLoading(show, message = 'æ­£åœ¨è¼‰å…¥åœ°åœ–...') {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.querySelector('div:last-child').textContent = message;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // é é¢è¼‰å…¥å®Œæˆæ™‚åˆå§‹åŒ–åœ°åœ–
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ–äº’å‹•å¼åŸå¸‚äººå£åœ°åœ–ç³»çµ±...');
            initializeMap();
        });

        // éŸ¿æ‡‰å¼è™•ç†
        window.addEventListener('resize', function () {
            if (map) {
                map.resize();
            }
        });
    </script>
</body>

</html>