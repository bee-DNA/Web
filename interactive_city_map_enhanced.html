<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç ‰∫íÂãïÂºèÂüéÂ∏Ç‰∫∫Âè£Âú∞ÂúñÁ≥ªÁµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .panel {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select,
        button,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        button.secondary:hover {
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Áµ±Ë®àË≥áË®äÈù¢Êùø */
        .stats-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1rem;
        }

        .stats-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-header:hover {
            background: linear-gradient(135deg, #218838 0%, #1e8a7a 100%);
        }

        .stats-title {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .stats-content {
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            max-height: 500px;
            opacity: 1;
        }

        .collapsed .stats-content {
            max-height: 0 !important;
            opacity: 0;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.6s ease forwards;
        }

        .stat-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(5px);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.95rem;
        }

        .stat-value {
            font-weight: 700;
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÂçÄÂüüÂø´ÈÄüË∑≥ËΩâÊåâÈàï */
        .region-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .region-btn {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            border: 2px solid #667eea;
            padding: 0.6rem 1rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 80px;
            text-align: center;
        }

        .region-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                max-height: 50vh;
            }

            .region-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                top: 10px;
                right: 10px;
                gap: 5px;
            }

            .region-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
                min-width: 60px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header {
                padding: 1rem;
            }
        }

        /* Âú∞ÂúñÂΩàÁ™óÊ®£Âºè */
        .mapboxgl-popup-content {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 1.5rem 1.25rem 1.25rem;
            animation: popIn 0.3s ease-out;
        }

        @keyframes popIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(10px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .mapboxgl-popup-close-button {
            font-size: 16px;
            padding: 4px;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            line-height: 18px;
        }

        /* ÂüéÂ∏Ç‰∫∫Âè£È°ØÁ§∫Ê®£Âºè */
        .city-info {
            padding: 10px;
            min-width: 200px;
        }

        .city-info h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.2rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .city-info p {
            margin: 8px 0;
            color: #666;
            font-size: 0.9rem;
        }

        .population-highlight {
            font-size: 1.1rem;
            font-weight: bold;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        /* ËºâÂÖ•ÂãïÁï´ÊïàÊûú */
        .fade-in-up {
            animation: fadeInUp 0.8s ease-out;
        }

        .slide-in-left {
            animation: slideInLeft 0.8s ease-out;
        }

        .slide-in-right {
            animation: slideInRight 0.8s ease-out;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Ê®ôÈ°åÂçÄÂüü -->
        <header class="header">
            <h1>üåç ‰∫íÂãïÂºèÂüéÂ∏Ç‰∫∫Âè£Âú∞ÂúñÁ≥ªÁµ±</h1>
            <p>Êé¢Á¥¢ÂÖ®ÁêÉ‰∏ªË¶ÅÂüéÂ∏ÇÁöÑ‰∫∫Âè£ÂàÜÂ∏ÉËàáÂú∞ÁêÜË≥áË®ä - ÈªûÊìäÂüéÂ∏ÇÊü•ÁúãË©≥Á¥∞Ë≥áÊñô</p>
        </header>

        <!-- ‰∏ªË¶ÅÂÖßÂÆπÂçÄÂüü -->
        <div class="main-content">
            <!-- ÂÅ¥ÈÇäÊ¨ÑÊéßÂà∂Èù¢Êùø -->
            <aside class="sidebar">
                <!-- Âú∞ÂúñÊ®£ÂºèÊéßÂà∂ -->
                <div class="panel">
                    <h3>üé® Âú∞ÂúñÊ®£Âºè</h3>
                    <div class="control-group">
                        <label for="mapStyle">ÈÅ∏ÊìáÂú∞ÂúñÊ®£Âºè</label>
                        <select id="mapStyle" onchange="changeMapStyle(this.value)">
                            <option value="mapbox://styles/mapbox/streets-v12">Ë°óÈÅìÂú∞Âúñ</option>
                            <option value="mapbox://styles/mapbox/outdoors-v12">Êà∂Â§ñÂú∞Âúñ</option>
                            <option value="mapbox://styles/mapbox/light-v11">Ê∑∫Ëâ≤Âú∞Âúñ</option>
                            <option value="mapbox://styles/mapbox/dark-v11">Ê∑±Ëâ≤Âú∞Âúñ</option>
                            <option value="mapbox://styles/mapbox/satellite-v9">Ë°õÊòüÂú∞Âúñ</option>
                            <option value="mapbox://styles/mapbox/satellite-streets-v12">Ë°õÊòüË°óÈÅì</option>
                            <option value="mapbox://styles/mapbox/navigation-day-v1">Â∞éËà™Êó•Èñì</option>
                            <option value="mapbox://styles/mapbox/navigation-night-v1">Â∞éËà™Â§úÈñì</option>
                        </select>
                    </div>
                </div>

                <!-- 3DË¶ñËßíÊéßÂà∂ -->
                <div class="panel">
                    <h3>üèóÔ∏è 3D Ë¶ñËßí</h3>
                    <div class="control-group">
                        <label for="view3D">Ë¶ñËßíÊ®°Âºè</label>
                        <select id="view3D" onchange="change3DView(this.value)">
                            <option value="2d">Âπ≥Èù¢Ë¶ñËßí (2D)</option>
                            <option value="3d-low">ËºïÂæÆÂÇæÊñú (3D)</option>
                            <option value="3d-medium">‰∏≠Â∫¶ÂÇæÊñú (3D)</option>
                            <option value="3d-high">È´òÂ∫¶ÂÇæÊñú (3D)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button onclick="toggle3DBuildings()" id="buildingsToggle" class="btn secondary">
                            üè¢ È°ØÁ§∫Âª∫ÁØâÁâ©
                        </button>
                    </div>
                </div>

                <!-- È°ØÁ§∫ÊéßÂà∂ -->
                <div class="panel">
                    <h3>üåê È°ØÁ§∫Ë™ûË®Ä</h3>
                    <div class="control-group">
                        <label for="labelLanguage">ÂüéÂ∏ÇÂêçÁ®±Ë™ûË®Ä</label>
                        <select id="labelLanguage" onchange="changeLabelLanguage(this.value)">
                            <option value="zh">‰∏≠Êñá</option>
                            <option value="en">English</option>
                            <option value="default">È†êË®≠ (Â§öË™û)</option>
                        </select>
                    </div>
                </div>

                <!-- Êï∏ÊìöÈªûÊ®£Âºè -->
                <div class="panel">
                    <h3>üìç ÈªûÊ®£ÂºèÊ®°Âºè</h3>
                    <div class="control-group">
                        <label for="pointStyleMode">Êï∏ÊìöÈªûÂ§ßÂ∞è</label>
                        <select id="pointStyleMode" onchange="changePointStyleMode(this.value)">
                            <option value="population">Êåâ‰∫∫Âè£Ë™øÊï¥Â§ßÂ∞è</option>
                            <option value="fixed">Áµ±‰∏ÄÂ§ßÂ∞è</option>
                        </select>
                    </div>
                </div>

                <!-- ÊéßÂà∂ÊåâÈàï -->
                <div class="panel">
                    <h3>üîß ÊéßÂà∂ÂäüËÉΩ</h3>
                    <div class="control-group">
                        <button onclick="resetMapView()">üîç ÈáçÁΩÆË¶ñÂúñ</button>
                    </div>
                    <div class="control-group">
                        <button onclick="toggleFullscreen()">üì∫ ÂÖ®Ëû¢ÂπïÊ®°Âºè</button>
                    </div>
                    <div class="control-group">
                        <button onclick="returnToPreviousView()" id="returnViewBtn"
                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: none;">üîô
                            ËøîÂõû‰πãÂâçË¶ñÂúñ</button>
                    </div>
                </div>

                <!-- Áµ±Ë®àË≥áË®äÈù¢Êùø -->
                <div class="stats-container" id="statsPanel">
                    <div class="stats-header" onclick="toggleStatsPanel()">
                        <h3 class="stats-title">üìä Áµ±Ë®àË≥áË®ä</h3>
                        <span class="toggle-icon" id="toggleIcon">‚ñº</span>
                    </div>
                    <div class="stats-content" id="statsContent">
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">üèôÔ∏è ÂüéÂ∏ÇÊï∏Èáè</span>
                            <span class="stat-value" id="cityCount">25</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">üë• Á∏Ω‰∫∫Âè£</span>
                            <span class="stat-value" id="totalPopulation">310.6M</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">üìà Âπ≥Âùá‰∫∫Âè£</span>
                            <span class="stat-value" id="avgPopulation">12.4M</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">üåü ÊúÄÂ§ßÂüéÂ∏Ç</span>
                            <span class="stat-value" id="largestCity">Êù±‰∫¨</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">üîç Áï∂ÂâçÁ∏ÆÊîæ</span>
                            <span class="stat-value" id="currentZoom">2.0</span>
                        </div>
                        <div class="stat-item fade-in-up">
                            <span class="stat-label">‚è∞ ÊúÄÂæåÊõ¥Êñ∞</span>
                            <span class="stat-value" id="lastUpdate">ËºâÂÖ•‰∏≠...</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Âú∞ÂúñÂÆπÂô® -->
            <main class="map-container">
                <div id="map"></div>

                <!-- ÂçÄÂüüÂø´ÈÄüË∑≥ËΩâÊåâÈàï -->
                <div class="region-buttons">
                    <button class="region-btn" onclick="resetMapView()" style="background: #667eea; color: white;">üåç
                        ÂÖ®ÁêÉ</button>
                    <button class="region-btn" onclick="flyToRegion('asia')">üèÆ ‰∫ûÊ¥≤</button>
                    <button class="region-btn" onclick="flyToRegion('europe')">üè∞ Ê≠êÊ¥≤</button>
                    <button class="region-btn" onclick="flyToRegion('america')">üóΩ ÁæéÊ¥≤</button>
                    <button class="region-btn" onclick="flyToRegion('africa')">ü¶Å ÈùûÊ¥≤</button>
                    <button class="region-btn" onclick="flyToRegion('oceania')">üèÑ Â§ßÊ¥ãÊ¥≤</button>
                </div>

                <!-- ËºâÂÖ•ÊåáÁ§∫Âô® -->
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <div>Ê≠£Âú®ËºâÂÖ•Âú∞Âúñ...</div>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let map;
        let currentLanguage = 'zh';
        let pointStyleMode = 'population';
        let statsCollapsed = false;
        let previousView = null; // ÂÑ≤Â≠òÈªûÊìäÂâçÁöÑË¶ñÂúñÁãÄÊÖã

        // Ë™ûË®ÄÈÖçÁΩÆ
        const LABEL_LAYER_IDS = [
            'country-label', 'country-label-sm', 'state-label',
            'settlement-label', 'settlement-subdivision-label',
            'settlement-label-sm', 'settlement-subdivision-label-sm',
            'airport-label', 'waterway-label', 'poi-label',
            'road-label', 'road-label-navigation', 'road-label-small'
        ];

        const LANGUAGE_FIELDS = {
            zh: ['coalesce',
                ['get', 'name_zh-Hant'],
                ['get', 'name_zh-Hans'],
                ['get', 'name_zh'],
                ['get', 'name'],
                ['get', 'name_en']
            ],
            en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
            default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
        };

        const LANGUAGE_DISPLAY_NAMES = {
            zh: '‰∏≠Êñá',
            en: 'English',
            default: 'È†êË®≠ (Â§öË™û)'
        };

        // ÂüéÂ∏ÇÊï∏Êìö (25ÂÄãÂÖ®ÁêÉ‰∏ªË¶ÅÂüéÂ∏Ç)
        const CITY_DATA = [
            { name_zh: 'Êù±‰∫¨', name_en: 'Tokyo', coordinates: [139.6917, 35.6895], population: 37400068, country: 'Êó•Êú¨' },
            { name_zh: 'ÈõÖÂä†ÈÅî', name_en: 'Jakarta', coordinates: [106.8650, -6.1751], population: 10562088, country: 'Âç∞Â∞º' },
            { name_zh: 'Âæ∑Èáå', name_en: 'Delhi', coordinates: [77.1025, 28.7041], population: 29399141, country: 'Âç∞Â∫¶' },
            { name_zh: 'È¶¨Â∞ºÊãâ', name_en: 'Manila', coordinates: [120.9842, 14.5995], population: 13482462, country: 'Ëè≤ÂæãË≥ì' },
            { name_zh: '‰∏äÊµ∑', name_en: 'Shanghai', coordinates: [121.4737, 31.2304], population: 24870895, country: '‰∏≠Âúã' },
            { name_zh: 'ËÅñ‰øùÁæÖ', name_en: 'S√£o Paulo', coordinates: [-46.6333, -23.5505], population: 21831000, country: 'Â∑¥Ë•ø' },
            { name_zh: 'È¶ñÁàæ', name_en: 'Seoul', coordinates: [126.9780, 37.5665], population: 9733509, country: 'ÈüìÂúã' },
            { name_zh: 'Â¢®Ë•øÂì•Âüé', name_en: 'Mexico City', coordinates: [-99.1332, 19.4326], population: 21581000, country: 'Â¢®Ë•øÂì•' },
            { name_zh: 'ÈñãÁæÖ', name_en: 'Cairo', coordinates: [31.2357, 30.0444], population: 18772000, country: 'ÂüÉÂèä' },
            { name_zh: 'Â≠üË≤∑', name_en: 'Mumbai', coordinates: [72.8777, 19.0760], population: 19980000, country: 'Âç∞Â∫¶' },
            { name_zh: 'Âåó‰∫¨', name_en: 'Beijing', coordinates: [116.4074, 39.9042], population: 21542000, country: '‰∏≠Âúã' },
            { name_zh: 'ÈÅîÂç°', name_en: 'Dhaka', coordinates: [90.4125, 23.8103], population: 20284000, country: 'Â≠üÂä†Êãâ' },
            { name_zh: 'Â§ßÈò™', name_en: 'Osaka', coordinates: [135.5023, 34.6937], population: 19222665, country: 'Êó•Êú¨' },
            { name_zh: 'Á¥êÁ¥Ñ', name_en: 'New York', coordinates: [-74.0059, 40.7128], population: 18819000, country: 'ÁæéÂúã' },
            { name_zh: 'Âç°ÊãâÂ•á', name_en: 'Karachi', coordinates: [67.0011, 24.8607], population: 14910352, country: 'Â∑¥Âü∫ÊñØÂù¶' },
            { name_zh: 'Â∏ÉÂÆúË´æÊñØËâæÂà©ÊñØ', name_en: 'Buenos Aires', coordinates: [-58.3816, -34.6037], population: 14967000, country: 'ÈòøÊ†πÂª∑' },
            { name_zh: 'ÈÑ≠Â∑û', name_en: 'Zhengzhou', coordinates: [113.6254, 34.7466], population: 10120000, country: '‰∏≠Âúã' },
            { name_zh: '‰ºäÊñØÂù¶Â†°', name_en: 'Istanbul', coordinates: [28.9784, 41.0082], population: 14751000, country: 'ÂúüËÄ≥ÂÖ∂' },
            { name_zh: 'ÈáçÊÖ∂', name_en: 'Chongqing', coordinates: [106.9128, 29.4316], population: 14838000, country: '‰∏≠Âúã' },
            { name_zh: 'ÊãâÂêÑÊñØ', name_en: 'Lagos', coordinates: [3.3792, 6.5244], population: 13463000, country: 'Â•àÂèäÂà©‰∫û' },
            { name_zh: 'È¶¨Âæ∑Èáå', name_en: 'Madrid', coordinates: [-3.7038, 40.4168], population: 6155116, country: 'Ë•øÁè≠Áâô' },
            { name_zh: 'Âè∞Âåó', name_en: 'Taipei', coordinates: [121.5654, 25.0330], population: 2700000, country: 'Âè∞ÁÅ£' },
            { name_zh: 'È¶ôÊ∏Ø', name_en: 'Hong Kong', coordinates: [114.1694, 22.3193], population: 7496981, country: 'È¶ôÊ∏Ø' },
            { name_zh: 'Êñ∞Âä†Âù°', name_en: 'Singapore', coordinates: [103.8198, 1.3521], population: 5850342, country: 'Êñ∞Âä†Âù°' },
            { name_zh: 'ÂÄ´Êï¶', name_en: 'London', coordinates: [-0.1276, 51.5074], population: 8982000, country: 'Ëã±Âúã' }
        ];

        // ÂçÄÂüüÂùêÊ®ô
        const REGIONS = {
            asia: { center: [116, 35], zoom: 3 },
            europe: { center: [10, 50], zoom: 3.5 },
            america: { center: [-74, 40], zoom: 2.5 },
            africa: { center: [20, 0], zoom: 2.5 },
            oceania: { center: [151, -33], zoom: 4 }
        };

        // ÂàùÂßãÂåñÂú∞Âúñ
        function initializeMap() {
            showLoading(true);

            // Ë®≠ÂÆö Mapbox Access Token
            mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlLWRuYSIsImEiOiJjbWZ5MTlhOTkwZnF3MmxvbjkwN2RtM2Z4In0.yFiY2MNpWqaDINuLaz1e0w';

            // Âª∫Á´ãÂú∞ÂúñÂØ¶‰æã
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v12',
                center: [121.5654, 25.0330], // Âè∞ÂåóÁÇ∫‰∏≠ÂøÉ
                zoom: 2,
                pitch: 0,
                bearing: 0
            });

            // Âú∞ÂúñËºâÂÖ•ÂÆåÊàê‰∫ã‰ª∂
            map.on('load', function () {
                console.log('üó∫Ô∏è Âú∞ÂúñËºâÂÖ•ÂÆåÊàê');

                // Ê∑ªÂä†Êéß‰ª∂
                map.addControl(new mapboxgl.NavigationControl());
                map.addControl(new mapboxgl.FullscreenControl());
                map.addControl(new mapboxgl.ScaleControl({
                    maxWidth: 100,
                    unit: 'metric'
                }));

                // ÊáâÁî®Âú∞ÂúñÊ®ôÁ±§Ë™ûË®Ä
                applyMapLabelLanguage(currentLanguage);

                // ËºâÂÖ•ÂüéÂ∏ÇÊï∏Êìö
                loadCityData();
                updateStats();

                // Áõ£ËÅΩÂú∞ÂúñÁßªÂãï‰∫ã‰ª∂
                map.on('moveend', updateStats);
                map.on('zoomend', updateStats);

                showLoading(false);
            });

            // ÈåØË™§ËôïÁêÜ
            map.on('error', function (e) {
                console.error('Âú∞ÂúñËºâÂÖ•ÈåØË™§:', e);
                showLoading(false);
            });
        }

        // ËºâÂÖ•ÂüéÂ∏ÇÊï∏Êìö
        function loadCityData() {
            if (!map) return;

            // Ê∫ñÂÇô GeoJSON Êï∏Êìö
            const geojsonData = {
                type: 'FeatureCollection',
                features: CITY_DATA.map(city => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: city.coordinates
                    },
                    properties: {
                        name_zh: city.name_zh,
                        name_en: city.name_en,
                        population: city.population,
                        country: city.country
                    }
                }))
            };

            // Ê∑ªÂä†Êï∏ÊìöÊ∫ê
            map.addSource('cities', {
                type: 'geojson',
                data: geojsonData
            });

            // Ê∑ªÂä†ÂüéÂ∏ÇÂúìÈªûÂ±§
            map.addLayer({
                id: 'cities',
                type: 'circle',
                source: 'cities',
                paint: {
                    'circle-radius': getCircleRadius(),
                    'circle-color': getCircleColor(),
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#fff'
                }
            });

            // Ê∑ªÂä†ÂüéÂ∏ÇÊ®ôÁ±§Â±§
            map.addLayer({
                id: 'city-labels',
                type: 'symbol',
                source: 'cities',
                layout: {
                    'text-field': getCityNameExpression(),
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-offset': [0, 1.5],
                    'text-anchor': 'top',
                    'text-size': 12
                },
                paint: {
                    'text-color': '#333',
                    'text-halo-color': '#fff',
                    'text-halo-width': 1
                }
            });

            // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
            map.on('click', 'cities', onCityClick);
            map.on('mouseenter', 'cities', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'cities', () => map.getCanvas().style.cursor = '');
        }

        // Áç≤ÂèñÂúìÈªûÂçäÂæëË°®ÈÅîÂºè
        function getCircleRadius() {
            if (pointStyleMode === 'population') {
                return [
                    'interpolate',
                    ['linear'],
                    ['get', 'population'],
                    1000000, 8,
                    10000000, 15,
                    20000000, 25,
                    40000000, 35
                ];
            } else {
                return 12;
            }
        }

        // Áç≤ÂèñÂúìÈªûÈ°èËâ≤Ë°®ÈÅîÂºè
        function getCircleColor() {
            if (pointStyleMode === 'population') {
                return [
                    'interpolate',
                    ['linear'],
                    ['get', 'population'],
                    1000000, '#FED976',
                    5000000, '#FD8D3C',
                    10000000, '#E31A1C',
                    20000000, '#800026'
                ];
            } else {
                return '#3b82f6';
            }
        }

        // Áç≤ÂèñÂüéÂ∏ÇÂêçÁ®±Ë°®ÈÅîÂºè
        function getCityNameExpression() {
            const CITY_LANGUAGE_FIELDS = {
                zh: ['coalesce', ['get', 'name_zh'], ['get', 'name_en'], ['get', 'name']],
                en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
                default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
            };
            return CITY_LANGUAGE_FIELDS[currentLanguage] || CITY_LANGUAGE_FIELDS.default;
        }

        // Áç≤ÂèñÊú¨Âú∞ÂåñÂüéÂ∏ÇÂêçÁ®±
        function getLocalizedCityName(properties, language = currentLanguage) {
            if (!properties) return 'Êú™Áü•ÂüéÂ∏Ç';

            const languageOrder = {
                zh: ['name_zh', 'name', 'name_en'],
                en: ['name_en', 'name', 'name_zh'],
                default: ['name', 'name_en', 'name_zh']
            };

            const keys = languageOrder[language] || languageOrder.default;
            for (const key of keys) {
                if (properties[key]) {
                    return properties[key];
                }
            }

            return properties.name || properties.name_zh || properties.name_en || 'Êú™Áü•ÂüéÂ∏Ç';
        }

        // ÂüéÂ∏ÇÈªûÊìä‰∫ã‰ª∂
        function onCityClick(e) {
            const feature = e.features[0];
            const coordinates = feature.geometry.coordinates.slice();
            const properties = feature.properties;

            const cityName = getLocalizedCityName(properties);
            const population = properties.population;

            // ÂÑ≤Â≠òÁï∂ÂâçË¶ñÂúñÁãÄÊÖãÔºàÈªûÊìäÂâçÁöÑÁãÄÊÖãÔºâ
            previousView = {
                center: map.getCenter(),
                zoom: map.getZoom(),
                pitch: map.getPitch(),
                bearing: map.getBearing()
            };

            // È°ØÁ§∫ËøîÂõûÊåâÈàï
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'block';
            }

            console.log('üíæ Â∑≤ÂÑ≤Â≠òÁï∂ÂâçË¶ñÂúñÁãÄÊÖã:', {
                zoom: previousView.zoom.toFixed(2),
                center: [previousView.center.lng.toFixed(4), previousView.center.lat.toFixed(4)]
            });

            // Êô∫ËÉΩÁ∏ÆÊîæÈÇèËºØ
            const currentZoom = map.getZoom();
            let targetZoom;

            if (currentZoom < 5) {
                targetZoom = 10; // ÂæûÈÅ†Ë∑ùÈõ¢Ë¶ñÂúñÊîæÂ§ßÂà∞ÂüéÂ∏ÇÁ¥öÂà•
            } else if (currentZoom < 8) {
                targetZoom = 12; // Âæû‰∏≠Á≠âË∑ùÈõ¢ÊîæÂ§ßÂà∞Ë©≥Á¥∞Á¥öÂà•
            } else {
                targetZoom = Math.min(currentZoom + 3, 15); // Â∑≤Á∂ìÂæàËøëÊôÇÈÅ©Â∫¶ÊîæÂ§ß
            }

            // È°ØÁ§∫È£õË°å‰∏≠ÁöÑÊèêÁ§∫
            console.log(`üöÅ È£õË°åÂà∞ ${cityName} (Á∏ÆÊîæ: ${currentZoom.toFixed(1)} ‚Üí ${targetZoom})`);

            map.flyTo({
                center: coordinates,
                zoom: targetZoom,
                duration: 1500, // 1.5ÁßíÁöÑÈ£õË°åÂãïÁï´
                curve: 1.2, // È£õË°åË∑ØÂæëÁöÑÂΩéÊõ≤Â∫¶
                easing: function (t) {
                    // Á∑©ÂãïÂáΩÊï∏ÔºåËÆìÂãïÁï´Êõ¥ÊµÅÊö¢
                    return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
                }
            });

            // ÂÖàÈóúÈñâÊâÄÊúâÁèæÊúâÂΩàÁ™óÔºåÈÅøÂÖçË°ùÁ™Å
            const existingPopups = document.querySelectorAll('.mapboxgl-popup');
            existingPopups.forEach(popup => popup.remove());

            // Âª∂ÈÅ≤È°ØÁ§∫ÂΩàÁ™óÔºåÁ≠âÂæÖÈ£õË°åÂãïÁï´ÂÆåÊàê‰∏ÄÂçä
            setTimeout(() => {
                // ÂâµÂª∫ÂΩàÁ™óÂÖßÂÆπ
                const popupContent = `
                    <div class="city-info">
                        <h3>${cityName}</h3>
                        <p><strong>ÂúãÂÆ∂/Âú∞ÂçÄÔºö</strong>${properties.country}</p>
                        <p><strong>‰∫∫Âè£Êï∏ÈáèÔºö</strong><span class="population-highlight">${population.toLocaleString()}</span> ‰∫∫</p>
                        <p><strong>Â∫ßÊ®ô‰ΩçÁΩÆÔºö</strong>${coordinates[1].toFixed(4)}, ${coordinates[0].toFixed(4)}</p>
                        <div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #eee; font-size: 0.8rem; color: #666;">
                            üí° ÈóúÈñâÊ≠§ÂΩàÁ™óÂ∞áËøîÂõûÂéüÊú¨Ë¶ñÂúñ
                        </div>
                    </div>
                `;

                // ÂâµÂª∫Êñ∞ÂΩàÁ™ó
                const popup = new mapboxgl.Popup({
                    closeButton: true,
                    closeOnClick: false,
                    maxWidth: '300px',
                    focusAfterOpen: false // Èò≤Ê≠¢ÁÑ¶ÈªûÂïèÈ°åÂ∞éËá¥ÁöÑ‰∫ã‰ª∂Ë°ùÁ™Å
                })
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);

                // Á¢∫‰øùÂΩàÁ™óÊ≠£Á¢∫È°ØÁ§∫ÂæåÂÜçÁõ£ËÅΩ‰∫ã‰ª∂
                setTimeout(() => {
                    // Áõ£ËÅΩÂΩàÁ™óÈóúÈñâ‰∫ã‰ª∂
                    popup.on('close', function () {
                        console.log('üîô ÂΩàÁ™óÈóúÈñâ‰∫ã‰ª∂Ëß∏Áôº');
                        if (previousView) {
                            console.log('üîô Âü∑Ë°åËøîÂõû‰πãÂâçÁöÑË¶ñÂúñ');
                            // ‰ΩøÁî® setTimeout Á¢∫‰øù‰∫ã‰ª∂ËôïÁêÜÂÆåÊàêÂæåÂÜçÂü∑Ë°åËøîÂõû
                            setTimeout(() => {
                                returnToPreviousView();
                            }, 100);
                        }
                    });

                    // Ê∑ªÂä†È°çÂ§ñÁöÑÈªûÊìäÁõ£ËÅΩÔºåÁ¢∫‰øùÈóúÈñâÊåâÈàïÊ≠£Â∏∏Â∑•‰Ωú
                    const closeButton = document.querySelector('.mapboxgl-popup-close-button');
                    if (closeButton) {
                        closeButton.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('üîô ÈóúÈñâÊåâÈàïÁõ¥Êé•ÈªûÊìä‰∫ã‰ª∂');
                            popup.remove();
                            if (previousView) {
                                setTimeout(() => {
                                    returnToPreviousView();
                                }, 100);
                            }
                        }, { once: true }); // Âè™Âü∑Ë°å‰∏ÄÊ¨°
                    }
                }, 50); // Á≠âÂæÖÂΩàÁ™óÂÆåÂÖ®Ê∏≤Êüì
            }, 800); // Á≠âÂæÖ800ÊØ´ÁßíÂÜçÈ°ØÁ§∫ÂΩàÁ™ó
        }

        // ÊáâÁî®Âú∞ÂúñÊ®ôÁ±§Ë™ûË®Ä
        function applyMapLabelLanguage(language) {
            if (!map) return;

            const applyToLayers = () => {
                const field = LANGUAGE_FIELDS[language] || LANGUAGE_FIELDS.default;

                LABEL_LAYER_IDS.forEach(layerId => {
                    if (map.getLayer(layerId)) {
                        try {
                            map.setLayoutProperty(layerId, 'text-field', field);
                        } catch (error) {
                            console.warn(`‚ö†Ô∏è  ÁÑ°Ê≥ïÊõ¥Êñ∞ÂúñÂ±§ ${layerId} ÁöÑÊ®ôÁ±§Ë™ûË®Ä`, error);
                        }
                    }
                });

                // ËôïÁêÜÂÖ∂‰ªñÂèØËÉΩÁöÑÊ®ôÁ±§ÂúñÂ±§
                const style = map.getStyle();
                if (style && Array.isArray(style.layers)) {
                    style.layers.forEach(layer => {
                        if (!layer || layer.type !== 'symbol') return;
                        if (!layer.layout || !layer.layout['text-field']) return;
                        if (layer.id && layer.id.includes('city')) return; // Ë∑≥ÈÅéÂüéÂ∏ÇÊ®ôÁ±§

                        const textField = layer.layout['text-field'];
                        const textFieldString = typeof textField === 'string'
                            ? textField
                            : Array.isArray(textField)
                                ? JSON.stringify(textField)
                                : '';

                        if (textFieldString.includes('name') && layer.id.includes('label')) {
                            try {
                                map.setLayoutProperty(layer.id, 'text-field', field);
                            } catch (error) {
                                console.warn(`‚ö†Ô∏è  ÁÑ°Ê≥ïÊõ¥Êñ∞ÂúñÂ±§ ${layer.id} ÁöÑÊ®ôÁ±§Ë™ûË®Ä`, error);
                            }
                        }
                    });
                }
            };

            if (!map.isStyleLoaded()) {
                map.once('styledata', applyToLayers);
                return;
            }

            applyToLayers();
        }

        // ÊîπËÆäÂú∞ÂúñÊ®£Âºè
        function changeMapStyle(styleUrl) {
            if (!map) return;

            showLoading(true, 'ÂàáÊèõÂú∞ÂúñÊ®£Âºè‰∏≠...');
            map.setStyle(styleUrl);

            map.once('styledata', () => {
                applyMapLabelLanguage(currentLanguage);
                loadCityData();
                showLoading(false);
            });
        }

        // ÊîπËÆäÊ®ôÁ±§Ë™ûË®Ä
        function changeLabelLanguage(language) {
            currentLanguage = language;

            // ÊáâÁî®Âú∞ÂúñÊ®ôÁ±§Ë™ûË®Ä
            applyMapLabelLanguage(language);

            // Êõ¥Êñ∞ÂüéÂ∏ÇÊ®ôÁ±§
            if (map && map.getLayer('city-labels')) {
                try {
                    map.setLayoutProperty('city-labels', 'text-field', getCityNameExpression());
                } catch (error) {
                    console.warn('‚ö†Ô∏è  ÁÑ°Ê≥ïÊõ¥Êñ∞ÂüéÂ∏ÇÊ®ôÁ±§Ë™ûË®Ä', error);
                }
            }

            // Êõ¥Êñ∞Ë™ûË®ÄÈÅ∏ÊìáÂô®
            const languageSelect = document.getElementById('labelLanguage');
            if (languageSelect && languageSelect.value !== language) {
                languageSelect.value = language;
            }

            // Êõ¥Êñ∞Áµ±Ë®àË≥áÊñô
            updateStats();

            const displayName = LANGUAGE_DISPLAY_NAMES[language] || LANGUAGE_DISPLAY_NAMES.default;
            console.log('üåê Ë™ûË®ÄÂ∑≤ÂàáÊèõÁÇ∫:', displayName);
        }

        // ÊîπËÆäÈªûÊ®£ÂºèÊ®°Âºè
        function changePointStyleMode(mode) {
            pointStyleMode = mode;
            if (map && map.getLayer('cities')) {
                map.setPaintProperty('cities', 'circle-radius', getCircleRadius());
                map.setPaintProperty('cities', 'circle-color', getCircleColor());
            }
        }

        // È£õË°åÂà∞ÂçÄÂüü
        function flyToRegion(region) {
            if (!map || !REGIONS[region]) return;

            const regionNames = {
                asia: '‰∫ûÊ¥≤',
                europe: 'Ê≠êÊ¥≤',
                america: 'ÁæéÊ¥≤',
                africa: 'ÈùûÊ¥≤',
                oceania: 'Â§ßÊ¥ãÊ¥≤'
            };

            console.log(`üåè È£õË°åÂà∞ ${regionNames[region] || region}`);

            // ÈóúÈñâÊâÄÊúâÂΩàÁ™ó
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => popup.remove());

            // Ê∏ÖÈô§‰πãÂâçË¶ñÂúñÁãÄÊÖã
            previousView = null;

            // Èö±ËóèËøîÂõûÊåâÈàï
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            const { center, zoom } = REGIONS[region];
            map.flyTo({
                center: center,
                zoom: zoom,
                duration: 2000,
                curve: 1.3,
                easing: function (t) {
                    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; // ease-in-out cubic
                }
            });
        }

        // ËøîÂõû‰πãÂâçÁöÑË¶ñÂúñ
        function returnToPreviousView() {
            if (!map || !previousView) {
                console.log('‚ö†Ô∏è  Ê≤íÊúâÂÑ≤Â≠òÁöÑË¶ñÂúñÁãÄÊÖã');
                return;
            }

            console.log('üîô ËøîÂõû‰πãÂâçÁöÑË¶ñÂúñ:', {
                zoom: previousView.zoom.toFixed(2),
                center: [previousView.center.lng.toFixed(4), previousView.center.lat.toFixed(4)]
            });

            // Á¢∫‰øùÊâÄÊúâÂΩàÁ™óÈÉΩË¢´ÈóúÈñâ
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('Ê∏ÖÁêÜÂΩàÁ™óÊôÇÂá∫ÁèæÈåØË™§:', error);
                }
            });

            map.flyTo({
                center: [previousView.center.lng, previousView.center.lat],
                zoom: previousView.zoom,
                pitch: previousView.pitch,
                bearing: previousView.bearing,
                duration: 1200, // Á®çÂæÆÂø´‰∏ÄÈªûÁöÑËøîÂõûÂãïÁï´
                curve: 1.1,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2); // ease-out quadraticÔºåÊõ¥ËºïÂø´ÁöÑÊÑüË¶∫
                }
            });

            // Ê∏ÖÈô§ÂÑ≤Â≠òÁöÑË¶ñÂúñÁãÄÊÖã
            previousView = null;

            // Èö±ËóèËøîÂõûÊåâÈàï
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            console.log('‚úÖ ËøîÂõûË¶ñÂúñÊìç‰ΩúÂÆåÊàê');
        }

        // ÈáçÁΩÆÂú∞ÂúñË¶ñÂúñ
        function resetMapView() {
            if (!map) return;

            console.log('üåç ËøîÂõûÂÖ®ÁêÉË¶ñÂúñ');

            // ÈóúÈñâÊâÄÊúâÂΩàÁ™ó
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => popup.remove());

            // Ê∏ÖÈô§‰πãÂâçË¶ñÂúñÁãÄÊÖã
            previousView = null;

            // Èö±ËóèËøîÂõûÊåâÈàï
            const returnBtn = document.getElementById('returnViewBtn');
            if (returnBtn) {
                returnBtn.style.display = 'none';
            }

            map.flyTo({
                center: [20, 20], // ÂÖ®ÁêÉ‰∏≠ÂøÉÈªû
                zoom: 2,
                pitch: 0,
                bearing: 0,
                duration: 2000,
                curve: 1.5, // Êõ¥Â§ßÁöÑÂΩéÊõ≤Â∫¶ËÆìÈ£õË°åÊõ¥ÂÑ™ÈõÖ
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 3); // ease-out cubic
                }
            });
        }

        // ÂàáÊèõÂÖ®Ëû¢ÂπïÊ®°Âºè
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // ÂÖ®Â±ÄËÆäÈáèËøΩËπ§ 3D ÁãÄÊÖã
        let buildingsLayerVisible = false;

        // ÂàáÊèõ 3D Ë¶ñËßí
        function change3DView(viewMode) {
            if (!map) return;

            console.log('üèóÔ∏è ÂàáÊèõ 3D Ë¶ñËßí:', viewMode);

            let pitch = 0;
            let bearing = map.getBearing(); // ‰øùÊåÅÁï∂ÂâçÊñπÂêë

            switch (viewMode) {
                case '2d':
                    pitch = 0;
                    console.log('üìê ÂàáÊèõÂà∞Âπ≥Èù¢Ë¶ñËßí');
                    break;
                case '3d-low':
                    pitch = 30;
                    console.log('üìê ÂàáÊèõÂà∞ËºïÂæÆÂÇæÊñúË¶ñËßí');
                    break;
                case '3d-medium':
                    pitch = 45;
                    console.log('üìê ÂàáÊèõÂà∞‰∏≠Â∫¶ÂÇæÊñúË¶ñËßí');
                    break;
                case '3d-high':
                    pitch = 60;
                    console.log('üìê ÂàáÊèõÂà∞È´òÂ∫¶ÂÇæÊñúË¶ñËßí');
                    break;
                default:
                    pitch = 0;
            }

            // Âπ≥ÊªëÈÅéÊ∏°Âà∞Êñ∞ÁöÑË¶ñËßí
            map.flyTo({
                pitch: pitch,
                bearing: bearing,
                duration: 1500,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2); // ease-out quadratic
                }
            });

            // Â¶ÇÊûúÊòØ 3D Ë¶ñËßíÔºåËá™ÂãïÈ°ØÁ§∫Âª∫ÁØâÁâ©ÊèêÁ§∫
            if (pitch > 0 && !buildingsLayerVisible) {
                setTimeout(() => {
                    console.log('üí° ÊèêÁ§∫: ÊÇ®ÂèØ‰ª•ÈñãÂïüÂª∫ÁØâÁâ©ÂúñÂ±§‰ª•Áç≤ÂæóÊõ¥Â•ΩÁöÑ 3D ÊïàÊûú');
                }, 1000);
            }
        }

        // ÂàáÊèõÂª∫ÁØâÁâ©ÂúñÂ±§
        function toggle3DBuildings() {
            if (!map) return;

            const layerId = '3d-buildings';
            const button = document.getElementById('buildingsToggle');

            try {
                if (buildingsLayerVisible) {
                    // Èö±ËóèÂª∫ÁØâÁâ©
                    if (map.getLayer(layerId)) {
                        map.setLayoutProperty(layerId, 'visibility', 'none');
                    }
                    buildingsLayerVisible = false;
                    button.textContent = 'üè¢ È°ØÁ§∫Âª∫ÁØâÁâ©';
                    button.classList.remove('active');
                    console.log('üè¢ Â∑≤Èö±ËóèÂª∫ÁØâÁâ©ÂúñÂ±§');
                } else {
                    // È°ØÁ§∫Âª∫ÁØâÁâ©
                    if (!map.getLayer(layerId)) {
                        // Â¶ÇÊûúÂúñÂ±§‰∏çÂ≠òÂú®ÔºåÊ∑ªÂä†ÂÆÉ
                        add3DBuildingsLayer();
                    } else {
                        map.setLayoutProperty(layerId, 'visibility', 'visible');
                    }
                    buildingsLayerVisible = true;
                    button.textContent = 'üèóÔ∏è Èö±ËóèÂª∫ÁØâÁâ©';
                    button.classList.add('active');
                    console.log('üè¢ Â∑≤È°ØÁ§∫Âª∫ÁØâÁâ©ÂúñÂ±§');

                    // Â¶ÇÊûúÁï∂ÂâçÊòØ 2D Ë¶ñËßíÔºåÂª∫Ë≠∞ÂàáÊèõÂà∞ 3D
                    if (map.getPitch() === 0) {
                        console.log('üí° Âª∫Ë≠∞: ÂàáÊèõÂà∞ 3D Ë¶ñËßí‰ª•Áç≤ÂæóÊõ¥Â•ΩÁöÑÂª∫ÁØâÁâ©ÊïàÊûú');
                    }
                }
            } catch (error) {
                console.error('‚ùå ÂàáÊèõÂª∫ÁØâÁâ©ÂúñÂ±§ÊôÇÂá∫ÈåØ:', error);
            }
        }

        // Ê∑ªÂä† 3D Âª∫ÁØâÁâ©ÂúñÂ±§
        function add3DBuildingsLayer() {
            if (!map) return;

            // Á≠âÂæÖÂú∞ÂúñÊ®£ÂºèÂÆåÂÖ®ËºâÂÖ•
            if (!map.isStyleLoaded()) {
                map.once('styledata', add3DBuildingsLayer);
                return;
            }

            try {
                // Ê™¢Êü•ÊòØÂê¶Â∑≤ÊúâÂª∫ÁØâÁâ©Êï∏ÊìöÊ∫ê
                if (!map.getSource('composite')) {
                    console.warn('‚ö†Ô∏è Áï∂ÂâçÂú∞ÂúñÊ®£Âºè‰∏çÊîØÊè¥Âª∫ÁØâÁâ©ÂúñÂ±§');
                    return;
                }

                const layerId = '3d-buildings';

                // Â¶ÇÊûúÂúñÂ±§Â∑≤Â≠òÂú®ÔºåÁßªÈô§ÂÆÉ
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }

                // Ê∑ªÂä† 3D Âª∫ÁØâÁâ©ÂúñÂ±§
                map.addLayer({
                    id: layerId,
                    source: 'composite',
                    'source-layer': 'building',
                    filter: ['==', 'extrude', 'true'],
                    type: 'fill-extrusion',
                    minzoom: 15,
                    paint: {
                        'fill-extrusion-color': [
                            'case',
                            ['>', ['get', 'height'], 100], '#667eea',  // È´òÊ®ì - ËóçËâ≤
                            ['>', ['get', 'height'], 50], '#764ba2',   // ‰∏≠Ê®ì - Á¥´Ëâ≤
                            '#95a5a6'  // ‰ΩéÊ®ì - ÁÅ∞Ëâ≤
                        ],
                        'fill-extrusion-height': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'height']
                        ],
                        'fill-extrusion-base': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            15, 0,
                            15.05, ['get', 'min_height']
                        ],
                        'fill-extrusion-opacity': 0.8
                    }
                });

                console.log('üèóÔ∏è 3D Âª∫ÁØâÁâ©ÂúñÂ±§Â∑≤Ê∑ªÂä†');
            } catch (error) {
                console.error('‚ùå Ê∑ªÂä†Âª∫ÁØâÁâ©ÂúñÂ±§Â§±Êïó:', error);
                console.warn('‚ö†Ô∏è Áï∂ÂâçÂú∞ÂúñÊ®£ÂºèÂèØËÉΩ‰∏çÊîØÊè¥ 3D Âª∫ÁØâÁâ©');
            }
        }

        // ÂàáÊèõÁµ±Ë®àÈù¢Êùø
        function toggleStatsPanel() {
            const panel = document.getElementById('statsPanel');
            const icon = document.getElementById('toggleIcon');

            statsCollapsed = !statsCollapsed;

            if (statsCollapsed) {
                panel.classList.add('collapsed');
                icon.textContent = '‚ñ∂';
            } else {
                panel.classList.remove('collapsed');
                icon.textContent = '‚ñº';
                updateStats();
            }
        }

        // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
        function updateStats() {
            if (!map) return;

            const totalPopulation = CITY_DATA.reduce((sum, city) => sum + city.population, 0);
            const avgPopulation = totalPopulation / CITY_DATA.length;
            const largestCity = CITY_DATA.reduce((max, city) =>
                city.population > max.population ? city : max
            );

            // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
            document.getElementById('cityCount').textContent = CITY_DATA.length;
            document.getElementById('totalPopulation').textContent = (totalPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('avgPopulation').textContent = (avgPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('largestCity').textContent = getLocalizedCityName(largestCity);
            document.getElementById('currentZoom').textContent = map.getZoom().toFixed(1);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // È°ØÁ§∫ËºâÂÖ•ÊåáÁ§∫Âô®
        function showLoading(show, message = 'Ê≠£Âú®ËºâÂÖ•Âú∞Âúñ...') {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.querySelector('div:last-child').textContent = message;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÊôÇÂàùÂßãÂåñÂú∞Âúñ
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Ê≠£Âú®ÂàùÂßãÂåñ‰∫íÂãïÂºèÂüéÂ∏Ç‰∫∫Âè£Âú∞ÂúñÁ≥ªÁµ±...');
            initializeMap();
        });

        // ÈüøÊáâÂºèËôïÁêÜ
        window.addEventListener('resize', function () {
            if (map) {
                map.resize();
            }
        });
    </script>
</body>

</html>