<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ äº’å‹•å¼åŸå¸‚åœ°åœ– - å¤©æ°£æ•´åˆç‰ˆ</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-section h3 {
            color: #333;
            font-size: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-align: left;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .return-btn {
            position: absolute;
            top: 20px;
            left: 320px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            display: none;
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .return-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
            color: #333;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* å¤©æ°£å·¥å…·æç¤ºæ¨£å¼ */
        .weather-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e9ecef;
            z-index: 1000;
            min-width: 200px;
            pointer-events: none;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: weatherFadeIn 0.3s ease-out;
        }

        @keyframes weatherFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .weather-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .weather-icon {
            width: 40px;
            height: 40px;
            margin-right: 0.75rem;
        }

        .weather-main {
            flex: 1;
        }

        .weather-temp {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
        }

        .weather-desc {
            font-size: 0.85rem;
            color: #666;
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .weather-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #666;
        }

        .weather-item i {
            margin-right: 0.5rem;
            width: 16px;
            text-align: center;
        }

        /* å¢å¼·å½ˆçª—æ¨£å¼ */
        .mapboxgl-popup-content {
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border: none;
            max-width: 400px;
            animation: popupSlideIn 0.4s ease-out;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: -15px -15px 1rem -15px;
            border-radius: 12px 12px 0 0;
        }

        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .popup-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .popup-body {
            padding: 0 0.5rem 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .info-item {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .weather-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .weather-current {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .weather-current-icon {
            width: 60px;
            height: 60px;
            margin-right: 1rem;
        }

        .weather-current-info h3 {
            margin: 0 0 0.25rem;
            font-size: 1.8rem;
        }

        .weather-current-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .weather-details-popup {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .weather-detail-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -300px;
                transition: left 0.3s ease;
                height: 100%;
                z-index: 1000;
            }

            .sidebar.active {
                left: 0;
            }

            .return-btn {
                left: 20px;
            }

            .weather-tooltip {
                min-width: 180px;
                font-size: 0.8rem;
            }

            .popup-content {
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>æ­£åœ¨è¼‰å…¥äº’å‹•å¼åœ°åœ–ç³»çµ±...</p>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>ğŸŒ äº’å‹•å¼åŸå¸‚åœ°åœ–ç³»çµ± - å¤©æ°£æ•´åˆç‰ˆ</h1>
            <p>æ¢ç´¢å…¨çƒ25å€‹ä¸»è¦åŸå¸‚çš„äººå£è³‡è¨Šèˆ‡å³æ™‚å¤©æ°£æ•¸æ“š</p>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h2>
                </div>

                <div class="sidebar-content">
                    <!-- çµ±è¨ˆè³‡è¨Š -->
                    <div class="stats-container">
                        <h3 style="margin-bottom: 1rem;">ğŸ“Š çµ±è¨ˆè³‡è¨Š</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" id="totalCities">25</span>
                                <span class="stat-label">åŸå¸‚æ•¸é‡</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="totalPopulation">-</span>
                                <span class="stat-label">ç¸½äººå£</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="maxCity">-</span>
                                <span class="stat-label">æœ€å¤§åŸå¸‚</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="weatherStatus">è¼‰å…¥ä¸­</span>
                                <span class="stat-label">å¤©æ°£ç‹€æ…‹</span>
                            </div>
                        </div>
                    </div>

                    <!-- åœ°åœ–æ¨£å¼æ§åˆ¶ -->
                    <div class="control-section">
                        <h3>ğŸ—ºï¸ åœ°åœ–æ¨£å¼</h3>
                        <div class="button-group">
                            <button class="btn active"
                                onclick="changeMapStyle('mapbox://styles/mapbox/streets-v12')">è¡—é“åœ°åœ–</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/satellite-streets-v12')">è¡›æ˜Ÿè¡—é“</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/light-v11')">æ·ºè‰²åœ°åœ–</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/dark-v11')">æ·±è‰²åœ°åœ–</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/outdoors-v12')">æˆ¶å¤–åœ°åœ–</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/navigation-day-v1')">å°èˆªç™½å¤©</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/navigation-night-v1')">å°èˆªå¤œæ™š</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/satellite-v9')">ç´”è¡›æ˜Ÿ</button>
                        </div>
                    </div>

                    <!-- èªè¨€æ§åˆ¶ -->
                    <div class="control-section">
                        <h3>ğŸŒ åœ°åœ–èªè¨€</h3>
                        <div class="button-group">
                            <button class="btn" onclick="changeLabelLanguage('zh')">ä¸­æ–‡æ¨™ç±¤</button>
                            <button class="btn" onclick="changeLabelLanguage('en')">è‹±æ–‡æ¨™ç±¤</button>
                            <button class="btn active" onclick="changeLabelLanguage('default')">é è¨­èªè¨€</button>
                        </div>
                    </div>

                    <!-- å€åŸŸå¿«é€Ÿè·³è½‰ -->
                    <div class="control-section">
                        <h3>ğŸŒ å€åŸŸå°èˆª</h3>
                        <div class="button-group">
                            <button class="btn" onclick="flyToRegion('asia')">ğŸ¯ äºæ´²</button>
                            <button class="btn" onclick="flyToRegion('europe')">ğŸ° æ­æ´²</button>
                            <button class="btn" onclick="flyToRegion('america')">ğŸ—½ ç¾æ´²</button>
                            <button class="btn" onclick="flyToRegion('africa')">ğŸ¦ éæ´²</button>
                            <button class="btn" onclick="flyToRegion('oceania')">ğŸ„ å¤§æ´‹æ´²</button>
                        </div>
                    </div>

                    <!-- å¤©æ°£æ§åˆ¶ -->
                    <div class="control-section">
                        <h3>ğŸŒ¤ï¸ å¤©æ°£é¡¯ç¤º</h3>
                        <div class="button-group">
                            <button class="btn active" id="weatherToggle"
                                onclick="toggleWeatherDisplay()">é¡¯ç¤ºå¤©æ°£è³‡è¨Š</button>
                            <button class="btn" onclick="refreshWeatherData()">ğŸ”„ æ›´æ–°å¤©æ°£</button>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="map-container">
                <button class="return-btn" id="returnViewBtn" onclick="returnToPreviousView()">
                    â†©ï¸ è¿”å›ç¸½è¦½
                </button>
                <div id="map"></div>
            </main>
        </div>
    </div>

    <!-- å¤©æ°£å·¥å…·æç¤ºæ¨¡æ¿ -->
    <div class="weather-tooltip" id="weatherTooltip" style="display: none;">
        <div class="weather-header">
            <img class="weather-icon" id="tooltipWeatherIcon" src="" alt="">
            <div class="weather-main">
                <div class="weather-temp" id="tooltipTemp">--Â°C</div>
                <div class="weather-desc" id="tooltipDesc">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        <div class="weather-details">
            <div class="weather-item">
                <i>ğŸ’§</i>
                <span id="tooltipHumidity">--%</span>
            </div>
            <div class="weather-item">
                <i>ğŸ’¨</i>
                <span id="tooltipWind">-- km/h</span>
            </div>
        </div>
    </div>

    <script>
        // OpenWeatherMap API é…ç½®
        const WEATHER_CONFIG = {
            API_KEY: 'c56fc30a9025ff1ff2089b3eef0e7389', // è«‹æ›¿æ›ç‚ºæ‚¨çš„APIå¯†é‘°
            BASE_URL: 'https://api.openweathermap.org/data/2.5',
            ICON_URL: 'https://openweathermap.org/img/wn'
        };

        // å…¨å±€è®Šé‡
        let map;
        let previousView = null;
        let currentLanguage = 'default';
        let weatherDisplayEnabled = true;
        let weatherCache = new Map();
        let weatherTooltip;

        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlZG5hIiwiYSI6ImNtMWtqY3dkazBjdDQya3B6dWdyOGU5bHgifQ.18dLqHBax3kgzUI7Jvxllw';

        // èªè¨€é…ç½®
        const LANGUAGE_FIELDS = {
            zh: ['coalesce',
                ['get', 'name_zh-Hant'],
                ['get', 'name_zh-Hans'],
                ['get', 'name_zh'],
                ['get', 'name'],
                ['get', 'name_en']
            ],
            en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
            default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
        };

        const LANGUAGE_DISPLAY_NAMES = {
            zh: 'ä¸­æ–‡',
            en: 'English',
            default: 'é è¨­ (å¤šèª)'
        };

        // åŸå¸‚æ•¸æ“š (25å€‹å…¨çƒä¸»è¦åŸå¸‚)
        const CITY_DATA = [
            { name_zh: 'æ±äº¬', name_en: 'Tokyo', coordinates: [139.6917, 35.6895], population: 37400068, country: 'æ—¥æœ¬' },
            { name_zh: 'é›…åŠ é”', name_en: 'Jakarta', coordinates: [106.8650, -6.1751], population: 10562088, country: 'å°å°¼' },
            { name_zh: 'å¾·é‡Œ', name_en: 'Delhi', coordinates: [77.1025, 28.7041], population: 29399141, country: 'å°åº¦' },
            { name_zh: 'é¦¬å°¼æ‹‰', name_en: 'Manila', coordinates: [120.9842, 14.5995], population: 13482462, country: 'è²å¾‹è³“' },
            { name_zh: 'ä¸Šæµ·', name_en: 'Shanghai', coordinates: [121.4737, 31.2304], population: 24870895, country: 'ä¸­åœ‹' },
            { name_zh: 'è–ä¿ç¾…', name_en: 'SÃ£o Paulo', coordinates: [-46.6333, -23.5505], population: 21831000, country: 'å·´è¥¿' },
            { name_zh: 'é¦–çˆ¾', name_en: 'Seoul', coordinates: [126.9780, 37.5665], population: 9733509, country: 'éŸ“åœ‹' },
            { name_zh: 'å¢¨è¥¿å“¥åŸ', name_en: 'Mexico City', coordinates: [-99.1332, 19.4326], population: 21581000, country: 'å¢¨è¥¿å“¥' },
            { name_zh: 'é–‹ç¾…', name_en: 'Cairo', coordinates: [31.2357, 30.0444], population: 18772000, country: 'åŸƒåŠ' },
            { name_zh: 'å­Ÿè²·', name_en: 'Mumbai', coordinates: [72.8777, 19.0760], population: 19980000, country: 'å°åº¦' },
            { name_zh: 'åŒ—äº¬', name_en: 'Beijing', coordinates: [116.4074, 39.9042], population: 21542000, country: 'ä¸­åœ‹' },
            { name_zh: 'é”å¡', name_en: 'Dhaka', coordinates: [90.4125, 23.8103], population: 20284000, country: 'å­ŸåŠ æ‹‰' },
            { name_zh: 'å¤§é˜ª', name_en: 'Osaka', coordinates: [135.5023, 34.6937], population: 19222665, country: 'æ—¥æœ¬' },
            { name_zh: 'ç´ç´„', name_en: 'New York', coordinates: [-74.0059, 40.7128], population: 18819000, country: 'ç¾åœ‹' },
            { name_zh: 'å¡æ‹‰å¥‡', name_en: 'Karachi', coordinates: [67.0011, 24.8607], population: 14910352, country: 'å·´åŸºæ–¯å¦' },
            { name_zh: 'å¸ƒå®œè«¾æ–¯è‰¾åˆ©æ–¯', name_en: 'Buenos Aires', coordinates: [-58.3816, -34.6037], population: 14967000, country: 'é˜¿æ ¹å»·' },
            { name_zh: 'é„­å·', name_en: 'Zhengzhou', coordinates: [113.6254, 34.7466], population: 10120000, country: 'ä¸­åœ‹' },
            { name_zh: 'ä¼Šæ–¯å¦å ¡', name_en: 'Istanbul', coordinates: [28.9784, 41.0082], population: 14751000, country: 'åœŸè€³å…¶' },
            { name_zh: 'é‡æ…¶', name_en: 'Chongqing', coordinates: [106.9128, 29.4316], population: 14838000, country: 'ä¸­åœ‹' },
            { name_zh: 'æ‹‰å„æ–¯', name_en: 'Lagos', coordinates: [3.3792, 6.5244], population: 13463000, country: 'å¥ˆåŠåˆ©äº' },
            { name_zh: 'é¦¬å¾·é‡Œ', name_en: 'Madrid', coordinates: [-3.7038, 40.4168], population: 6155116, country: 'è¥¿ç­ç‰™' },
            { name_zh: 'å°åŒ—', name_en: 'Taipei', coordinates: [121.5654, 25.0330], population: 2700000, country: 'å°ç£' },
            { name_zh: 'é¦™æ¸¯', name_en: 'Hong Kong', coordinates: [114.1694, 22.3193], population: 7496981, country: 'é¦™æ¸¯' },
            { name_zh: 'æ–°åŠ å¡', name_en: 'Singapore', coordinates: [103.8198, 1.3521], population: 5850342, country: 'æ–°åŠ å¡' },
            { name_zh: 'å€«æ•¦', name_en: 'London', coordinates: [-0.1276, 51.5074], population: 8982000, country: 'è‹±åœ‹' }
        ];

        // å€åŸŸåæ¨™
        const REGIONS = {
            asia: { center: [116, 35], zoom: 3 },
            europe: { center: [10, 50], zoom: 3.5 },
            america: { center: [-74, 40], zoom: 2.5 },
            africa: { center: [20, 0], zoom: 2.5 },
            oceania: { center: [151, -33], zoom: 4 }
        };

        // å¤©æ°£APIå‡½æ•¸
        async function fetchWeatherData(lat, lon) {
            const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;

            // æª¢æŸ¥å¿«å– (30åˆ†é˜æœ‰æ•ˆ)
            if (weatherCache.has(cacheKey)) {
                const cached = weatherCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 30 * 60 * 1000) {
                    return cached.data;
                }
            }

            try {
                // è¨­ç½®è«‹æ±‚è¶…æ™‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ™‚

                const response = await fetch(
                    `${WEATHER_CONFIG.BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_CONFIG.API_KEY}&units=metric&lang=zh_tw`,
                    {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // å¿«å–è³‡æ–™
                weatherCache.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });

                return data;
            } catch (error) {
                console.warn(`å¤©æ°£APIè«‹æ±‚å¤±æ•— (${lat}, ${lon}):`, error.message);

                // è¿”å›æ¨¡æ“¬æ•¸æ“šä»¥ä¿æŒåŠŸèƒ½é‹ä½œ
                return {
                    main: {
                        temp: Math.random() * 30 + 5, // 5-35åº¦éš¨æ©Ÿæº«åº¦
                        humidity: Math.floor(Math.random() * 40 + 40), // 40-80%æ¿•åº¦
                        feels_like: Math.random() * 30 + 5,
                        pressure: 1013
                    },
                    weather: [{
                        description: 'è³‡æ–™è¼‰å…¥ä¸­',
                        icon: '01d'
                    }],
                    wind: {
                        speed: Math.random() * 10 + 5 // 5-15 m/s
                    },
                    visibility: 10000,
                    _isMockData: true
                };
            }
        }

        // é¡¯ç¤ºå¤©æ°£å·¥å…·æç¤º
        function showWeatherTooltip(e, cityData, weatherData) {
            if (!weatherDisplayEnabled || !weatherData) return;

            const tooltip = document.getElementById('weatherTooltip');
            const temp = Math.round(weatherData.main.temp);
            const iconCode = weatherData.weather[0].icon;

            // æ›´æ–°å·¥å…·æç¤ºå…§å®¹
            document.getElementById('tooltipTemp').textContent = `${temp}Â°C`;
            document.getElementById('tooltipDesc').textContent = weatherData.weather[0].description;
            document.getElementById('tooltipHumidity').textContent = `${weatherData.main.humidity}%`;
            document.getElementById('tooltipWind').textContent = `${Math.round(weatherData.wind?.speed * 3.6 || 0)} km/h`;
            document.getElementById('tooltipWeatherIcon').src = `${WEATHER_CONFIG.ICON_URL}/${iconCode}@2x.png`;

            // å®šä½å·¥å…·æç¤º
            const rect = map.getContainer().getBoundingClientRect();
            tooltip.style.left = (e.point.x + rect.left + 15) + 'px';
            tooltip.style.top = (e.point.y + rect.top - 80) + 'px';
            tooltip.style.display = 'block';
        }

        // éš±è—å¤©æ°£å·¥å…·æç¤º
        function hideWeatherTooltip() {
            const tooltip = document.getElementById('weatherTooltip');
            tooltip.style.display = 'none';
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            try {
                console.log('ğŸš€ é–‹å§‹åˆå§‹åŒ–åœ°åœ–...');
                showLoading(true);

                // æª¢æŸ¥ Mapbox token
                if (!mapboxgl.accessToken) {
                    console.error('âŒ Mapbox access token æœªè¨­å®š');
                    showError('Mapbox access token æœªè¨­å®š');
                    return;
                }

                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [116, 35],
                    zoom: 2.5,
                    pitch: 0,
                    bearing: 0
                });

                map.on('load', function () {
                    console.log('ğŸ—ºï¸ åœ°åœ–è¼‰å…¥å®Œæˆ');
                    try {
                        addCityData();
                        updateStatistics();
                        showLoading(false);

                        // å»¶é²è¼‰å…¥å¤©æ°£æ•¸æ“šï¼Œé¿å…é˜»å¡åœ°åœ–é¡¯ç¤º
                        setTimeout(() => {
                            loadWeatherForAllCities();
                        }, 1000);
                    } catch (error) {
                        console.error('âŒ åœ°åœ–è¼‰å…¥å¾Œè™•ç†éŒ¯èª¤:', error);
                        showError('åœ°åœ–è³‡æ–™è¼‰å…¥éŒ¯èª¤: ' + error.message);
                    }
                });

                map.on('error', function (e) {
                    console.error('âŒ åœ°åœ–è¼‰å…¥éŒ¯èª¤:', e);
                    showError('åœ°åœ–è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                });

                // æ·»åŠ æ§åˆ¶å…ƒä»¶
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

                console.log('âœ… åœ°åœ–åˆå§‹åŒ–è¨­å®šå®Œæˆ');
            } catch (error) {
                console.error('âŒ åœ°åœ–åˆå§‹åŒ–éŒ¯èª¤:', error);
                showError('åœ°åœ–åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        // æ·»åŠ åŸå¸‚æ•¸æ“šåˆ°åœ°åœ–
        function addCityData() {
            const features = CITY_DATA.map(city => ({
                type: 'Feature',
                properties: {
                    name_zh: city.name_zh,
                    name_en: city.name_en,
                    population: city.population,
                    country: city.country,
                    coordinates: city.coordinates
                },
                geometry: {
                    type: 'Point',
                    coordinates: city.coordinates
                }
            }));

            map.addSource('cities', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: features
                }
            });

            // æ·»åŠ åŸå¸‚åœ“é»åœ–å±¤
            map.addLayer({
                id: 'cities-circle',
                type: 'circle',
                source: 'cities',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        2000000, 8,
                        10000000, 12,
                        20000000, 16,
                        40000000, 24
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        2000000, '#74b9ff',
                        10000000, '#0984e3',
                        20000000, '#6c5ce7',
                        40000000, '#a29bfe'
                    ],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': 'white'
                }
            });

            // æ·»åŠ åŸå¸‚æ¨™ç±¤åœ–å±¤
            map.addLayer({
                id: 'cities-label',
                type: 'symbol',
                source: 'cities',
                layout: {
                    'text-field': LANGUAGE_FIELDS[currentLanguage],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': 11,
                    'text-anchor': 'top',
                    'text-offset': [0, 1.5],
                    'text-max-width': 8
                },
                paint: {
                    'text-color': '#333',
                    'text-halo-color': 'white',
                    'text-halo-width': 1
                }
            });

            // é¼ æ¨™æ‡¸åœäº‹ä»¶
            map.on('mouseenter', 'cities-circle', async (e) => {
                map.getCanvas().style.cursor = 'pointer';

                const feature = e.features[0];
                const coordinates = feature.geometry.coordinates;
                const cityData = CITY_DATA.find(city =>
                    city.coordinates[0] === coordinates[0] &&
                    city.coordinates[1] === coordinates[1]
                );

                if (weatherDisplayEnabled && cityData) {
                    const weatherData = await fetchWeatherData(coordinates[1], coordinates[0]);
                    showWeatherTooltip(e, cityData, weatherData);
                }
            });

            map.on('mouseleave', 'cities-circle', () => {
                map.getCanvas().style.cursor = '';
                hideWeatherTooltip();
            });

            // é»æ“Šäº‹ä»¶
            map.on('click', 'cities-circle', onCityClick);

            console.log('ğŸ™ï¸ åŸå¸‚æ•¸æ“šè¼‰å…¥å®Œæˆ');
        }

        // åŸå¸‚é»æ“Šè™•ç†
        async function onCityClick(e) {
            const feature = e.features[0];
            const coordinates = feature.geometry.coordinates.slice();
            const properties = feature.properties;

            // å„²å­˜ç•¶å‰è¦–åœ–
            if (!previousView) {
                previousView = {
                    center: map.getCenter(),
                    zoom: map.getZoom(),
                    pitch: map.getPitch(),
                    bearing: map.getBearing()
                };

                document.getElementById('returnViewBtn').style.display = 'block';
            }

            // ç¢ºä¿æ‰€æœ‰ç¾æœ‰å½ˆçª—éƒ½è¢«é—œé–‰
            const existingPopups = document.querySelectorAll('.mapboxgl-popup');
            existingPopups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('æ¸…ç†å½ˆçª—æ™‚å‡ºç¾éŒ¯èª¤:', error);
                }
            });

            // ç²å–å¤©æ°£è³‡æ–™
            const weatherData = await fetchWeatherData(coordinates[1], coordinates[0]);

            // ç¸®æ”¾åˆ°åŸå¸‚
            map.flyTo({
                center: coordinates,
                zoom: 10,
                pitch: 45,
                bearing: 0,
                duration: 2000,
                curve: 1.5,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 3);
                }
            });

            // å‰µå»ºå½ˆçª—å…§å®¹
            const popupContent = createPopupContent(properties, weatherData);

            setTimeout(() => {
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    focusAfterOpen: false,
                    maxWidth: '400px'
                })
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);

                // å»¶é²æ·»åŠ äº‹ä»¶ç›£è½å™¨
                setTimeout(() => {
                    const closeButton = document.querySelector('.close-btn');
                    if (closeButton) {
                        closeButton.onclick = function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            popup.remove();
                            returnToPreviousView();
                        };
                    }
                }, 100);
            }, 500);

            console.log(`ğŸ¯ é»æ“ŠåŸå¸‚: ${properties.name_zh || properties.name_en}`);
        }

        // å‰µå»ºå½ˆçª—å…§å®¹
        function createPopupContent(properties, weatherData) {
            const cityName = properties.name_zh || properties.name_en;
            const population = properties.population?.toLocaleString() || 'N/A';

            let weatherSection = '';
            if (weatherData && weatherDisplayEnabled) {
                const temp = Math.round(weatherData.main.temp);
                const feelsLike = Math.round(weatherData.main.feels_like);
                const humidity = weatherData.main.humidity;
                const windSpeed = Math.round((weatherData.wind?.speed || 0) * 3.6);
                const pressure = weatherData.main.pressure;
                const visibility = Math.round((weatherData.visibility || 0) / 1000);
                const iconCode = weatherData.weather[0].icon;
                const description = weatherData.weather[0].description;

                weatherSection = `
                    <div class="weather-section">
                        <div class="weather-current">
                            <img class="weather-current-icon" src="${WEATHER_CONFIG.ICON_URL}/${iconCode}@2x.png" alt="${description}">
                            <div class="weather-current-info">
                                <h3>${temp}Â°C</h3>
                                <p>${description}</p>
                                <p>é«”æ„Ÿæº«åº¦: ${feelsLike}Â°C</p>
                            </div>
                        </div>
                        <div class="weather-details-popup">
                            <div class="weather-detail-item">
                                <div>ğŸ’§ æ¿•åº¦</div>
                                <div><strong>${humidity}%</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>ğŸ’¨ é¢¨é€Ÿ</div>
                                <div><strong>${windSpeed} km/h</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>ğŸŒ¡ï¸ æ°£å£“</div>
                                <div><strong>${pressure} hPa</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>ğŸ‘ï¸ èƒ½è¦‹åº¦</div>
                                <div><strong>${visibility} km</strong></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="popup-header">
                    <button class="close-btn">Ã—</button>
                    <div class="popup-title">${cityName}</div>
                    <div class="popup-subtitle">${properties.country}</div>
                </div>
                <div class="popup-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-value">${population}</span>
                            <div class="info-label">äººå£æ•¸é‡</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${properties.coordinates[1].toFixed(4)}Â°N</span>
                            <div class="info-label">ç·¯åº¦</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${properties.coordinates[0].toFixed(4)}Â°E</span>
                            <div class="info-label">ç¶“åº¦</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${getCurrentTime()}</span>
                            <div class="info-label">æŸ¥è©¢æ™‚é–“</div>
                        </div>
                    </div>
                    ${weatherSection}
                </div>
            `;
        }

        // è¼‰å…¥æ‰€æœ‰åŸå¸‚çš„å¤©æ°£æ•¸æ“š
        async function loadWeatherForAllCities() {
            try {
                console.log('ğŸŒ¤ï¸ é–‹å§‹è¼‰å…¥å¤©æ°£æ•¸æ“š...');
                let loadedCount = 0;

                // æª¢æŸ¥å¤©æ°£åŠŸèƒ½æ˜¯å¦å•Ÿç”¨
                if (!weatherDisplayEnabled) {
                    document.getElementById('weatherStatus').textContent = 'å·²é—œé–‰';
                    return;
                }

                document.getElementById('weatherStatus').textContent = 'è¼‰å…¥ä¸­';

                for (const city of CITY_DATA) {
                    try {
                        await fetchWeatherData(city.coordinates[1], city.coordinates[0]);
                        loadedCount++;

                        // æ›´æ–°çµ±è¨ˆç‹€æ…‹
                        const statusElement = document.getElementById('weatherStatus');
                        if (statusElement) {
                            statusElement.textContent = `${loadedCount}/${CITY_DATA.length}`;
                        }
                    } catch (error) {
                        console.warn(`è¼‰å…¥ ${city.name_zh} å¤©æ°£è³‡æ–™å¤±æ•—:`, error);
                    }

                    // çŸ­æš«å»¶é²é¿å…APIé™åˆ¶
                    await new Promise(resolve => setTimeout(resolve, 150));
                }

                const statusElement = document.getElementById('weatherStatus');
                if (statusElement) {
                    statusElement.textContent = loadedCount > 0 ? `${loadedCount} å€‹åŸå¸‚` : 'è¼‰å…¥å¤±æ•—';
                }
                console.log(`âœ… å¤©æ°£æ•¸æ“šè¼‰å…¥å®Œæˆ: ${loadedCount}/${CITY_DATA.length}`);
            } catch (error) {
                console.error('âŒ å¤©æ°£æ•¸æ“šè¼‰å…¥éŒ¯èª¤:', error);
                const statusElement = document.getElementById('weatherStatus');
                if (statusElement) {
                    statusElement.textContent = 'è¼‰å…¥å¤±æ•—';
                }
            }
        }

        // è¿”å›ä¹‹å‰çš„è¦–åœ–
        function returnToPreviousView() {
            if (!map || !previousView) {
                console.log('âš ï¸  æ²’æœ‰å„²å­˜çš„è¦–åœ–ç‹€æ…‹');
                return;
            }

            console.log('ğŸ”™ è¿”å›ä¹‹å‰çš„è¦–åœ–');

            // ç¢ºä¿æ‰€æœ‰å½ˆçª—éƒ½è¢«é—œé–‰
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('æ¸…ç†å½ˆçª—æ™‚å‡ºç¾éŒ¯èª¤:', error);
                }
            });

            map.flyTo({
                center: [previousView.center.lng, previousView.center.lat],
                zoom: previousView.zoom,
                pitch: previousView.pitch,
                bearing: previousView.bearing,
                duration: 1200,
                curve: 1.1,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2);
                }
            });

            previousView = null;
            document.getElementById('returnViewBtn').style.display = 'none';
        }

        // åˆ‡æ›åœ°åœ–æ¨£å¼
        function changeMapStyle(styleUrl) {
            if (!map) return;

            map.setStyle(styleUrl);

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.control-section .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // é‡æ–°æ·»åŠ æ•¸æ“šå±¤
            map.on('styledata', function () {
                if (map.isStyleLoaded()) {
                    addCityData();
                }
            });

            console.log('ğŸ¨ åœ°åœ–æ¨£å¼å·²æ›´æ”¹:', styleUrl);
        }

        // åˆ‡æ›æ¨™ç±¤èªè¨€
        function changeLabelLanguage(language) {
            if (!map || !map.getLayer('cities-label')) return;

            currentLanguage = language;

            map.setLayoutProperty('cities-label', 'text-field', LANGUAGE_FIELDS[language]);

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.control-section:nth-child(3) .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            console.log('ğŸŒ æ¨™ç±¤èªè¨€å·²åˆ‡æ›:', LANGUAGE_DISPLAY_NAMES[language]);
        }

        // é£›è¡Œåˆ°ç‰¹å®šå€åŸŸ
        function flyToRegion(region) {
            if (!map || !REGIONS[region]) return;

            const regionData = REGIONS[region];

            map.flyTo({
                center: regionData.center,
                zoom: regionData.zoom,
                duration: 2000,
                curve: 1.2,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2);
                }
            });

            console.log('âœˆï¸ é£›è¡Œåˆ°å€åŸŸ:', region);
        }

        // åˆ‡æ›å¤©æ°£é¡¯ç¤º
        function toggleWeatherDisplay() {
            weatherDisplayEnabled = !weatherDisplayEnabled;
            const button = document.getElementById('weatherToggle');

            if (weatherDisplayEnabled) {
                button.textContent = 'é¡¯ç¤ºå¤©æ°£è³‡è¨Š';
                button.classList.add('active');
            } else {
                button.textContent = 'éš±è—å¤©æ°£è³‡è¨Š';
                button.classList.remove('active');
                hideWeatherTooltip();
            }

            console.log('ğŸŒ¤ï¸ å¤©æ°£é¡¯ç¤º:', weatherDisplayEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰');
        }

        // åˆ·æ–°å¤©æ°£æ•¸æ“š
        function refreshWeatherData() {
            weatherCache.clear();
            loadWeatherForAllCities();
            console.log('ğŸ”„ å¤©æ°£æ•¸æ“šå·²åˆ·æ–°');
        }

        // æ›´æ–°çµ±è¨ˆè³‡è¨Š
        function updateStatistics() {
            const totalPopulation = CITY_DATA.reduce((sum, city) => sum + city.population, 0);
            const maxCity = CITY_DATA.reduce((max, city) =>
                city.population > max.population ? city : max
            );

            document.getElementById('totalPopulation').textContent = (totalPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('maxCity').textContent = maxCity.name_zh || maxCity.name_en;
        }

        // é¡¯ç¤º/éš±è—è¼‰å…¥ç•«é¢
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
        }

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        function showError(message) {
            showLoading(false);
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div class="loading-content">
                        <div style="color: #e74c3c; font-size: 2rem; margin-bottom: 1rem;">âš ï¸</div>
                        <p style="color: #e74c3c; font-weight: bold;">è¼‰å…¥éŒ¯èª¤</p>
                        <p style="color: #666; margin-top: 0.5rem;">${message}</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            é‡æ–°è¼‰å…¥
                        </button>
                    </div>
                `;
                loadingOverlay.style.display = 'flex';
            }
        }

        // ç²å–ç•¶å‰æ™‚é–“
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // åˆå§‹åŒ–æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function () {
            console.log('ğŸš€ æ‡‰ç”¨ç¨‹å¼é–‹å§‹åˆå§‹åŒ–...');

            // è¨­ç½®åˆå§‹è¼‰å…¥è¶…æ™‚
            const loadingTimeout = setTimeout(() => {
                console.warn('âš ï¸ è¼‰å…¥è¶…æ™‚ï¼Œå˜—è©¦é‡æ–°è¼‰å…¥...');
                showError('è¼‰å…¥è¶…æ™‚ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢');
            }, 10000); // 10ç§’è¶…æ™‚

            try {
                initializeMap();

                // å¦‚æœåˆå§‹åŒ–æˆåŠŸï¼Œæ¸…é™¤è¶…æ™‚
                map.on('load', () => {
                    clearTimeout(loadingTimeout);
                });
            } catch (error) {
                clearTimeout(loadingTimeout);
                console.error('âŒ åˆå§‹åŒ–éŒ¯èª¤:', error);
                showError('æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–å¤±æ•—');
            }
        });

        // å…¨åŸŸéŒ¯èª¤è™•ç†
        window.addEventListener('error', function (e) {
            console.error('ğŸš¨ æ‡‰ç”¨ç¨‹å¼éŒ¯èª¤:', e.error);
            showError('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: ' + e.error.message);
        });

        // Promise éŒ¯èª¤è™•ç†
        window.addEventListener('unhandledrejection', function (e) {
            console.error('ğŸš¨ æœªè™•ç†çš„ Promise éŒ¯èª¤:', e.reason);
            // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œé¿å…å¤©æ°£APIéŒ¯èª¤å½±éŸ¿ä½¿ç”¨è€…é«”é©—
            console.warn('Promise éŒ¯èª¤å·²è¨˜éŒ„ä½†ä¸ä¸­æ–·æ‡‰ç”¨ç¨‹å¼');
        });
    </script>
</body>

</html>