<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç ‰∫íÂãïÂºèÂüéÂ∏ÇÂú∞Âúñ - Â§©Ê∞£Êï¥ÂêàÁâà</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            animation: fadeIn 1s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
            }

            to {
                transform: translateY(0);
            }
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            z-index: 10;
            animation: slideInLeft 0.8s ease-out;
        }

        @keyframes slideInLeft {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .sidebar-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .control-section {
            margin-bottom: 2rem;
        }

        .control-section h3 {
            color: #333;
            font-size: 1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-align: left;
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e9ecef;
        }

        .btn:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .return-btn {
            position: absolute;
            top: 20px;
            left: 320px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            display: none;
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            from {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }

            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .return-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.5s ease-out;
        }

        .loading-content {
            text-align: center;
            color: #333;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            animation: slideInRight 1s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        /* Â§©Ê∞£Â∑•ÂÖ∑ÊèêÁ§∫Ê®£Âºè */
        .weather-tooltip {
            position: absolute;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid #e9ecef;
            z-index: 1000;
            min-width: 200px;
            pointer-events: none;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: weatherFadeIn 0.3s ease-out;
        }

        @keyframes weatherFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .weather-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e9ecef;
        }

        .weather-icon {
            width: 40px;
            height: 40px;
            margin-right: 0.75rem;
        }

        .weather-main {
            flex: 1;
        }

        .weather-temp {
            font-size: 1.4rem;
            font-weight: bold;
            color: #333;
        }

        .weather-desc {
            font-size: 0.85rem;
            color: #666;
            text-transform: capitalize;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .weather-item {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #666;
        }

        .weather-item i {
            margin-right: 0.5rem;
            width: 16px;
            text-align: center;
        }

        /* Â¢ûÂº∑ÂΩàÁ™óÊ®£Âºè */
        .mapboxgl-popup-content {
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border: none;
            max-width: 400px;
            animation: popupSlideIn 0.4s ease-out;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .popup-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            margin: -15px -15px 1rem -15px;
            border-radius: 12px 12px 0 0;
        }

        .popup-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .popup-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .popup-body {
            padding: 0 0.5rem 0.5rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .info-item {
            text-align: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            display: block;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .weather-section {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .weather-current {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .weather-current-icon {
            width: 60px;
            height: 60px;
            margin-right: 1rem;
        }

        .weather-current-info h3 {
            margin: 0 0 0.25rem;
            font-size: 1.8rem;
        }

        .weather-current-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .weather-details-popup {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .weather-detail-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        .close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -300px;
                transition: left 0.3s ease;
                height: 100%;
                z-index: 1000;
            }

            .sidebar.active {
                left: 0;
            }

            .return-btn {
                left: 20px;
            }

            .weather-tooltip {
                min-width: 180px;
                font-size: 0.8rem;
            }

            .popup-content {
                max-width: 300px;
            }
        }
    </style>
</head>

<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Ê≠£Âú®ËºâÂÖ•‰∫íÂãïÂºèÂú∞ÂúñÁ≥ªÁµ±...</p>
        </div>
    </div>

    <div class="container">
        <header class="header">
            <h1>üåç ‰∫íÂãïÂºèÂüéÂ∏ÇÂú∞ÂúñÁ≥ªÁµ± - Â§©Ê∞£Êï¥ÂêàÁâà</h1>
            <p>Êé¢Á¥¢ÂÖ®ÁêÉ25ÂÄã‰∏ªË¶ÅÂüéÂ∏ÇÁöÑ‰∫∫Âè£Ë≥áË®äËàáÂç≥ÊôÇÂ§©Ê∞£Êï∏Êìö</p>
        </header>

        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>üéõÔ∏è ÊéßÂà∂Èù¢Êùø</h2>
                </div>

                <div class="sidebar-content">
                    <!-- Áµ±Ë®àË≥áË®ä -->
                    <div class="stats-container">
                        <h3 style="margin-bottom: 1rem;">üìä Áµ±Ë®àË≥áË®ä</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" id="totalCities">25</span>
                                <span class="stat-label">ÂüéÂ∏ÇÊï∏Èáè</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="totalPopulation">-</span>
                                <span class="stat-label">Á∏Ω‰∫∫Âè£</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="maxCity">-</span>
                                <span class="stat-label">ÊúÄÂ§ßÂüéÂ∏Ç</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="weatherStatus">ËºâÂÖ•‰∏≠</span>
                                <span class="stat-label">Â§©Ê∞£ÁãÄÊÖã</span>
                            </div>
                        </div>
                    </div>

                    <!-- Âú∞ÂúñÊ®£ÂºèÊéßÂà∂ -->
                    <div class="control-section">
                        <h3>üó∫Ô∏è Âú∞ÂúñÊ®£Âºè</h3>
                        <div class="button-group">
                            <button class="btn active"
                                onclick="changeMapStyle('mapbox://styles/mapbox/streets-v12')">Ë°óÈÅìÂú∞Âúñ</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/satellite-streets-v12')">Ë°õÊòüË°óÈÅì</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/light-v11')">Ê∑∫Ëâ≤Âú∞Âúñ</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/dark-v11')">Ê∑±Ëâ≤Âú∞Âúñ</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/outdoors-v12')">Êà∂Â§ñÂú∞Âúñ</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/navigation-day-v1')">Â∞éËà™ÁôΩÂ§©</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/navigation-night-v1')">Â∞éËà™Â§úÊôö</button>
                            <button class="btn"
                                onclick="changeMapStyle('mapbox://styles/mapbox/satellite-v9')">Á¥îË°õÊòü</button>
                        </div>
                    </div>

                    <!-- Ë™ûË®ÄÊéßÂà∂ -->
                    <div class="control-section">
                        <h3>üåê Âú∞ÂúñË™ûË®Ä</h3>
                        <div class="button-group">
                            <button class="btn" onclick="changeLabelLanguage('zh')">‰∏≠ÊñáÊ®ôÁ±§</button>
                            <button class="btn" onclick="changeLabelLanguage('en')">Ëã±ÊñáÊ®ôÁ±§</button>
                            <button class="btn active" onclick="changeLabelLanguage('default')">È†êË®≠Ë™ûË®Ä</button>
                        </div>
                    </div>

                    <!-- ÂçÄÂüüÂø´ÈÄüË∑≥ËΩâ -->
                    <div class="control-section">
                        <h3>üåè ÂçÄÂüüÂ∞éËà™</h3>
                        <div class="button-group">
                            <button class="btn" onclick="flyToRegion('asia')">üèØ ‰∫ûÊ¥≤</button>
                            <button class="btn" onclick="flyToRegion('europe')">üè∞ Ê≠êÊ¥≤</button>
                            <button class="btn" onclick="flyToRegion('america')">üóΩ ÁæéÊ¥≤</button>
                            <button class="btn" onclick="flyToRegion('africa')">ü¶Å ÈùûÊ¥≤</button>
                            <button class="btn" onclick="flyToRegion('oceania')">üèÑ Â§ßÊ¥ãÊ¥≤</button>
                        </div>
                    </div>

                    <!-- Â§©Ê∞£ÊéßÂà∂ -->
                    <div class="control-section">
                        <h3>üå§Ô∏è Â§©Ê∞£È°ØÁ§∫</h3>
                        <div class="button-group">
                            <button class="btn active" id="weatherToggle"
                                onclick="toggleWeatherDisplay()">È°ØÁ§∫Â§©Ê∞£Ë≥áË®ä</button>
                            <button class="btn" onclick="refreshWeatherData()">üîÑ Êõ¥Êñ∞Â§©Ê∞£</button>
                        </div>
                    </div>
                </div>
            </aside>

            <main class="map-container">
                <button class="return-btn" id="returnViewBtn" onclick="returnToPreviousView()">
                    ‚Ü©Ô∏è ËøîÂõûÁ∏ΩË¶Ω
                </button>
                <div id="map"></div>
            </main>
        </div>
    </div>

    <!-- Â§©Ê∞£Â∑•ÂÖ∑ÊèêÁ§∫Ê®°Êùø -->
    <div class="weather-tooltip" id="weatherTooltip" style="display: none;">
        <div class="weather-header">
            <img class="weather-icon" id="tooltipWeatherIcon" src="" alt="">
            <div class="weather-main">
                <div class="weather-temp" id="tooltipTemp">--¬∞C</div>
                <div class="weather-desc" id="tooltipDesc">ËºâÂÖ•‰∏≠...</div>
            </div>
        </div>
        <div class="weather-details">
            <div class="weather-item">
                <i>üíß</i>
                <span id="tooltipHumidity">--%</span>
            </div>
            <div class="weather-item">
                <i>üí®</i>
                <span id="tooltipWind">-- km/h</span>
            </div>
        </div>
    </div>

    <script>
        // OpenWeatherMap API ÈÖçÁΩÆ
        const WEATHER_CONFIG = {
            API_KEY: 'c56fc30a9025ff1ff2089b3eef0e7389', // Ë´ãÊõøÊèõÁÇ∫ÊÇ®ÁöÑAPIÂØÜÈë∞
            BASE_URL: 'https://api.openweathermap.org/data/2.5',
            ICON_URL: 'https://openweathermap.org/img/wn'
        };

        // ÂÖ®Â±ÄËÆäÈáè
        let map;
        let previousView = null;
        let currentLanguage = 'default';
        let weatherDisplayEnabled = true;
        let weatherCache = new Map();
        let weatherTooltip;

        // Mapbox Access Token
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlZG5hIiwiYSI6ImNtMWtqY3dkazBjdDQya3B6dWdyOGU5bHgifQ.18dLqHBax3kgzUI7Jvxllw';

        // Ë™ûË®ÄÈÖçÁΩÆ
        const LANGUAGE_FIELDS = {
            zh: ['coalesce',
                ['get', 'name_zh-Hant'],
                ['get', 'name_zh-Hans'],
                ['get', 'name_zh'],
                ['get', 'name'],
                ['get', 'name_en']
            ],
            en: ['coalesce', ['get', 'name_en'], ['get', 'name'], ['get', 'name_zh']],
            default: ['coalesce', ['get', 'name'], ['get', 'name_en'], ['get', 'name_zh']]
        };

        const LANGUAGE_DISPLAY_NAMES = {
            zh: '‰∏≠Êñá',
            en: 'English',
            default: 'È†êË®≠ (Â§öË™û)'
        };

        // ÂüéÂ∏ÇÊï∏Êìö (25ÂÄãÂÖ®ÁêÉ‰∏ªË¶ÅÂüéÂ∏Ç)
        const CITY_DATA = [
            { name_zh: 'Êù±‰∫¨', name_en: 'Tokyo', coordinates: [139.6917, 35.6895], population: 37400068, country: 'Êó•Êú¨' },
            { name_zh: 'ÈõÖÂä†ÈÅî', name_en: 'Jakarta', coordinates: [106.8650, -6.1751], population: 10562088, country: 'Âç∞Â∞º' },
            { name_zh: 'Âæ∑Èáå', name_en: 'Delhi', coordinates: [77.1025, 28.7041], population: 29399141, country: 'Âç∞Â∫¶' },
            { name_zh: 'È¶¨Â∞ºÊãâ', name_en: 'Manila', coordinates: [120.9842, 14.5995], population: 13482462, country: 'Ëè≤ÂæãË≥ì' },
            { name_zh: '‰∏äÊµ∑', name_en: 'Shanghai', coordinates: [121.4737, 31.2304], population: 24870895, country: '‰∏≠Âúã' },
            { name_zh: 'ËÅñ‰øùÁæÖ', name_en: 'S√£o Paulo', coordinates: [-46.6333, -23.5505], population: 21831000, country: 'Â∑¥Ë•ø' },
            { name_zh: 'È¶ñÁàæ', name_en: 'Seoul', coordinates: [126.9780, 37.5665], population: 9733509, country: 'ÈüìÂúã' },
            { name_zh: 'Â¢®Ë•øÂì•Âüé', name_en: 'Mexico City', coordinates: [-99.1332, 19.4326], population: 21581000, country: 'Â¢®Ë•øÂì•' },
            { name_zh: 'ÈñãÁæÖ', name_en: 'Cairo', coordinates: [31.2357, 30.0444], population: 18772000, country: 'ÂüÉÂèä' },
            { name_zh: 'Â≠üË≤∑', name_en: 'Mumbai', coordinates: [72.8777, 19.0760], population: 19980000, country: 'Âç∞Â∫¶' },
            { name_zh: 'Âåó‰∫¨', name_en: 'Beijing', coordinates: [116.4074, 39.9042], population: 21542000, country: '‰∏≠Âúã' },
            { name_zh: 'ÈÅîÂç°', name_en: 'Dhaka', coordinates: [90.4125, 23.8103], population: 20284000, country: 'Â≠üÂä†Êãâ' },
            { name_zh: 'Â§ßÈò™', name_en: 'Osaka', coordinates: [135.5023, 34.6937], population: 19222665, country: 'Êó•Êú¨' },
            { name_zh: 'Á¥êÁ¥Ñ', name_en: 'New York', coordinates: [-74.0059, 40.7128], population: 18819000, country: 'ÁæéÂúã' },
            { name_zh: 'Âç°ÊãâÂ•á', name_en: 'Karachi', coordinates: [67.0011, 24.8607], population: 14910352, country: 'Â∑¥Âü∫ÊñØÂù¶' },
            { name_zh: 'Â∏ÉÂÆúË´æÊñØËâæÂà©ÊñØ', name_en: 'Buenos Aires', coordinates: [-58.3816, -34.6037], population: 14967000, country: 'ÈòøÊ†πÂª∑' },
            { name_zh: 'ÈÑ≠Â∑û', name_en: 'Zhengzhou', coordinates: [113.6254, 34.7466], population: 10120000, country: '‰∏≠Âúã' },
            { name_zh: '‰ºäÊñØÂù¶Â†°', name_en: 'Istanbul', coordinates: [28.9784, 41.0082], population: 14751000, country: 'ÂúüËÄ≥ÂÖ∂' },
            { name_zh: 'ÈáçÊÖ∂', name_en: 'Chongqing', coordinates: [106.9128, 29.4316], population: 14838000, country: '‰∏≠Âúã' },
            { name_zh: 'ÊãâÂêÑÊñØ', name_en: 'Lagos', coordinates: [3.3792, 6.5244], population: 13463000, country: 'Â•àÂèäÂà©‰∫û' },
            { name_zh: 'È¶¨Âæ∑Èáå', name_en: 'Madrid', coordinates: [-3.7038, 40.4168], population: 6155116, country: 'Ë•øÁè≠Áâô' },
            { name_zh: 'Âè∞Âåó', name_en: 'Taipei', coordinates: [121.5654, 25.0330], population: 2700000, country: 'Âè∞ÁÅ£' },
            { name_zh: 'È¶ôÊ∏Ø', name_en: 'Hong Kong', coordinates: [114.1694, 22.3193], population: 7496981, country: 'È¶ôÊ∏Ø' },
            { name_zh: 'Êñ∞Âä†Âù°', name_en: 'Singapore', coordinates: [103.8198, 1.3521], population: 5850342, country: 'Êñ∞Âä†Âù°' },
            { name_zh: 'ÂÄ´Êï¶', name_en: 'London', coordinates: [-0.1276, 51.5074], population: 8982000, country: 'Ëã±Âúã' }
        ];

        // ÂçÄÂüüÂùêÊ®ô
        const REGIONS = {
            asia: { center: [116, 35], zoom: 3 },
            europe: { center: [10, 50], zoom: 3.5 },
            america: { center: [-74, 40], zoom: 2.5 },
            africa: { center: [20, 0], zoom: 2.5 },
            oceania: { center: [151, -33], zoom: 4 }
        };

        // Â§©Ê∞£APIÂáΩÊï∏
        async function fetchWeatherData(lat, lon) {
            const cacheKey = `${lat.toFixed(2)},${lon.toFixed(2)}`;

            // Ê™¢Êü•Âø´Âèñ (30ÂàÜÈêòÊúâÊïà)
            if (weatherCache.has(cacheKey)) {
                const cached = weatherCache.get(cacheKey);
                if (Date.now() - cached.timestamp < 30 * 60 * 1000) {
                    return cached.data;
                }
            }

            try {
                // Ë®≠ÁΩÆË´ãÊ±ÇË∂ÖÊôÇ
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5ÁßíË∂ÖÊôÇ

                const response = await fetch(
                    `${WEATHER_CONFIG.BASE_URL}/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_CONFIG.API_KEY}&units=metric&lang=zh_tw`,
                    {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json'
                        }
                    }
                );

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Âø´ÂèñË≥áÊñô
                weatherCache.set(cacheKey, {
                    data: data,
                    timestamp: Date.now()
                });

                return data;
            } catch (error) {
                console.warn(`Â§©Ê∞£APIË´ãÊ±ÇÂ§±Êïó (${lat}, ${lon}):`, error.message);

                // ËøîÂõûÊ®°Êì¨Êï∏Êìö‰ª•‰øùÊåÅÂäüËÉΩÈÅã‰Ωú
                return {
                    main: {
                        temp: Math.random() * 30 + 5, // 5-35Â∫¶Èö®Ê©üÊ∫´Â∫¶
                        humidity: Math.floor(Math.random() * 40 + 40), // 40-80%ÊøïÂ∫¶
                        feels_like: Math.random() * 30 + 5,
                        pressure: 1013
                    },
                    weather: [{
                        description: 'Ë≥áÊñôËºâÂÖ•‰∏≠',
                        icon: '01d'
                    }],
                    wind: {
                        speed: Math.random() * 10 + 5 // 5-15 m/s
                    },
                    visibility: 10000,
                    _isMockData: true
                };
            }
        }

        // È°ØÁ§∫Â§©Ê∞£Â∑•ÂÖ∑ÊèêÁ§∫
        function showWeatherTooltip(e, cityData, weatherData) {
            if (!weatherDisplayEnabled || !weatherData) return;

            const tooltip = document.getElementById('weatherTooltip');
            const temp = Math.round(weatherData.main.temp);
            const iconCode = weatherData.weather[0].icon;

            // Êõ¥Êñ∞Â∑•ÂÖ∑ÊèêÁ§∫ÂÖßÂÆπ
            document.getElementById('tooltipTemp').textContent = `${temp}¬∞C`;
            document.getElementById('tooltipDesc').textContent = weatherData.weather[0].description;
            document.getElementById('tooltipHumidity').textContent = `${weatherData.main.humidity}%`;
            document.getElementById('tooltipWind').textContent = `${Math.round(weatherData.wind?.speed * 3.6 || 0)} km/h`;
            document.getElementById('tooltipWeatherIcon').src = `${WEATHER_CONFIG.ICON_URL}/${iconCode}@2x.png`;

            // ÂÆö‰ΩçÂ∑•ÂÖ∑ÊèêÁ§∫
            const rect = map.getContainer().getBoundingClientRect();
            tooltip.style.left = (e.point.x + rect.left + 15) + 'px';
            tooltip.style.top = (e.point.y + rect.top - 80) + 'px';
            tooltip.style.display = 'block';
        }

        // Èö±ËóèÂ§©Ê∞£Â∑•ÂÖ∑ÊèêÁ§∫
        function hideWeatherTooltip() {
            const tooltip = document.getElementById('weatherTooltip');
            tooltip.style.display = 'none';
        }

        // ÂàùÂßãÂåñÂú∞Âúñ
        function initializeMap() {
            try {
                console.log('üöÄ ÈñãÂßãÂàùÂßãÂåñÂú∞Âúñ...');
                showLoading(true);

                // Ê™¢Êü• Mapbox token
                if (!mapboxgl.accessToken) {
                    console.error('‚ùå Mapbox access token Êú™Ë®≠ÂÆö');
                    showError('Mapbox access token Êú™Ë®≠ÂÆö');
                    return;
                }

                map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/mapbox/streets-v12',
                    center: [116, 35],
                    zoom: 2.5,
                    pitch: 0,
                    bearing: 0
                });

                map.on('load', function () {
                    console.log('üó∫Ô∏è Âú∞ÂúñËºâÂÖ•ÂÆåÊàê');
                    try {
                        addCityData();
                        updateStatistics();
                        showLoading(false);

                        // Âª∂ÈÅ≤ËºâÂÖ•Â§©Ê∞£Êï∏ÊìöÔºåÈÅøÂÖçÈòªÂ°ûÂú∞ÂúñÈ°ØÁ§∫
                        setTimeout(() => {
                            loadWeatherForAllCities();
                        }, 1000);
                    } catch (error) {
                        console.error('‚ùå Âú∞ÂúñËºâÂÖ•ÂæåËôïÁêÜÈåØË™§:', error);
                        showError('Âú∞ÂúñË≥áÊñôËºâÂÖ•ÈåØË™§: ' + error.message);
                    }
                });

                map.on('error', function (e) {
                    console.error('‚ùå Âú∞ÂúñËºâÂÖ•ÈåØË™§:', e);
                    showError('Âú∞ÂúñËºâÂÖ•Â§±ÊïóÔºåË´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Êé•');
                });

                // Ê∑ªÂä†ÊéßÂà∂ÂÖÉ‰ª∂
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
                map.addControl(new mapboxgl.FullscreenControl(), 'top-right');

                console.log('‚úÖ Âú∞ÂúñÂàùÂßãÂåñË®≠ÂÆöÂÆåÊàê');
            } catch (error) {
                console.error('‚ùå Âú∞ÂúñÂàùÂßãÂåñÈåØË™§:', error);
                showError('Âú∞ÂúñÂàùÂßãÂåñÂ§±Êïó: ' + error.message);
            }
        }

        // Ê∑ªÂä†ÂüéÂ∏ÇÊï∏ÊìöÂà∞Âú∞Âúñ
        function addCityData() {
            const features = CITY_DATA.map(city => ({
                type: 'Feature',
                properties: {
                    name_zh: city.name_zh,
                    name_en: city.name_en,
                    population: city.population,
                    country: city.country,
                    coordinates: city.coordinates
                },
                geometry: {
                    type: 'Point',
                    coordinates: city.coordinates
                }
            }));

            map.addSource('cities', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: features
                }
            });

            // Ê∑ªÂä†ÂüéÂ∏ÇÂúìÈªûÂúñÂ±§
            map.addLayer({
                id: 'cities-circle',
                type: 'circle',
                source: 'cities',
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        2000000, 8,
                        10000000, 12,
                        20000000, 16,
                        40000000, 24
                    ],
                    'circle-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'population'],
                        2000000, '#74b9ff',
                        10000000, '#0984e3',
                        20000000, '#6c5ce7',
                        40000000, '#a29bfe'
                    ],
                    'circle-opacity': 0.8,
                    'circle-stroke-width': 2,
                    'circle-stroke-color': 'white'
                }
            });

            // Ê∑ªÂä†ÂüéÂ∏ÇÊ®ôÁ±§ÂúñÂ±§
            map.addLayer({
                id: 'cities-label',
                type: 'symbol',
                source: 'cities',
                layout: {
                    'text-field': LANGUAGE_FIELDS[currentLanguage],
                    'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                    'text-size': 11,
                    'text-anchor': 'top',
                    'text-offset': [0, 1.5],
                    'text-max-width': 8
                },
                paint: {
                    'text-color': '#333',
                    'text-halo-color': 'white',
                    'text-halo-width': 1
                }
            });

            // Èº†Ê®ôÊá∏ÂÅú‰∫ã‰ª∂
            map.on('mouseenter', 'cities-circle', async (e) => {
                map.getCanvas().style.cursor = 'pointer';

                const feature = e.features[0];
                const coordinates = feature.geometry.coordinates;
                const cityData = CITY_DATA.find(city =>
                    city.coordinates[0] === coordinates[0] &&
                    city.coordinates[1] === coordinates[1]
                );

                if (weatherDisplayEnabled && cityData) {
                    const weatherData = await fetchWeatherData(coordinates[1], coordinates[0]);
                    showWeatherTooltip(e, cityData, weatherData);
                }
            });

            map.on('mouseleave', 'cities-circle', () => {
                map.getCanvas().style.cursor = '';
                hideWeatherTooltip();
            });

            // ÈªûÊìä‰∫ã‰ª∂
            map.on('click', 'cities-circle', onCityClick);

            console.log('üèôÔ∏è ÂüéÂ∏ÇÊï∏ÊìöËºâÂÖ•ÂÆåÊàê');
        }

        // ÂüéÂ∏ÇÈªûÊìäËôïÁêÜ
        async function onCityClick(e) {
            const feature = e.features[0];
            const coordinates = feature.geometry.coordinates.slice();
            const properties = feature.properties;

            // ÂÑ≤Â≠òÁï∂ÂâçË¶ñÂúñ
            if (!previousView) {
                previousView = {
                    center: map.getCenter(),
                    zoom: map.getZoom(),
                    pitch: map.getPitch(),
                    bearing: map.getBearing()
                };

                document.getElementById('returnViewBtn').style.display = 'block';
            }

            // Á¢∫‰øùÊâÄÊúâÁèæÊúâÂΩàÁ™óÈÉΩË¢´ÈóúÈñâ
            const existingPopups = document.querySelectorAll('.mapboxgl-popup');
            existingPopups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('Ê∏ÖÁêÜÂΩàÁ™óÊôÇÂá∫ÁèæÈåØË™§:', error);
                }
            });

            // Áç≤ÂèñÂ§©Ê∞£Ë≥áÊñô
            const weatherData = await fetchWeatherData(coordinates[1], coordinates[0]);

            // Á∏ÆÊîæÂà∞ÂüéÂ∏Ç
            map.flyTo({
                center: coordinates,
                zoom: 10,
                pitch: 45,
                bearing: 0,
                duration: 2000,
                curve: 1.5,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 3);
                }
            });

            // ÂâµÂª∫ÂΩàÁ™óÂÖßÂÆπ
            const popupContent = createPopupContent(properties, weatherData);

            setTimeout(() => {
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    focusAfterOpen: false,
                    maxWidth: '400px'
                })
                    .setLngLat(coordinates)
                    .setHTML(popupContent)
                    .addTo(map);

                // Âª∂ÈÅ≤Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®
                setTimeout(() => {
                    const closeButton = document.querySelector('.close-btn');
                    if (closeButton) {
                        closeButton.onclick = function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            popup.remove();
                            returnToPreviousView();
                        };
                    }
                }, 100);
            }, 500);

            console.log(`üéØ ÈªûÊìäÂüéÂ∏Ç: ${properties.name_zh || properties.name_en}`);
        }

        // ÂâµÂª∫ÂΩàÁ™óÂÖßÂÆπ
        function createPopupContent(properties, weatherData) {
            const cityName = properties.name_zh || properties.name_en;
            const population = properties.population?.toLocaleString() || 'N/A';

            let weatherSection = '';
            if (weatherData && weatherDisplayEnabled) {
                const temp = Math.round(weatherData.main.temp);
                const feelsLike = Math.round(weatherData.main.feels_like);
                const humidity = weatherData.main.humidity;
                const windSpeed = Math.round((weatherData.wind?.speed || 0) * 3.6);
                const pressure = weatherData.main.pressure;
                const visibility = Math.round((weatherData.visibility || 0) / 1000);
                const iconCode = weatherData.weather[0].icon;
                const description = weatherData.weather[0].description;

                weatherSection = `
                    <div class="weather-section">
                        <div class="weather-current">
                            <img class="weather-current-icon" src="${WEATHER_CONFIG.ICON_URL}/${iconCode}@2x.png" alt="${description}">
                            <div class="weather-current-info">
                                <h3>${temp}¬∞C</h3>
                                <p>${description}</p>
                                <p>È´îÊÑüÊ∫´Â∫¶: ${feelsLike}¬∞C</p>
                            </div>
                        </div>
                        <div class="weather-details-popup">
                            <div class="weather-detail-item">
                                <div>üíß ÊøïÂ∫¶</div>
                                <div><strong>${humidity}%</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>üí® È¢®ÈÄü</div>
                                <div><strong>${windSpeed} km/h</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>üå°Ô∏è Ê∞£Â£ì</div>
                                <div><strong>${pressure} hPa</strong></div>
                            </div>
                            <div class="weather-detail-item">
                                <div>üëÅÔ∏è ËÉΩË¶ãÂ∫¶</div>
                                <div><strong>${visibility} km</strong></div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="popup-header">
                    <button class="close-btn">√ó</button>
                    <div class="popup-title">${cityName}</div>
                    <div class="popup-subtitle">${properties.country}</div>
                </div>
                <div class="popup-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-value">${population}</span>
                            <div class="info-label">‰∫∫Âè£Êï∏Èáè</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${properties.coordinates[1].toFixed(4)}¬∞N</span>
                            <div class="info-label">Á∑ØÂ∫¶</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${properties.coordinates[0].toFixed(4)}¬∞E</span>
                            <div class="info-label">Á∂ìÂ∫¶</div>
                        </div>
                        <div class="info-item">
                            <span class="info-value">${getCurrentTime()}</span>
                            <div class="info-label">Êü•Ë©¢ÊôÇÈñì</div>
                        </div>
                    </div>
                    ${weatherSection}
                </div>
            `;
        }

        // ËºâÂÖ•ÊâÄÊúâÂüéÂ∏ÇÁöÑÂ§©Ê∞£Êï∏Êìö
        async function loadWeatherForAllCities() {
            try {
                console.log('üå§Ô∏è ÈñãÂßãËºâÂÖ•Â§©Ê∞£Êï∏Êìö...');
                let loadedCount = 0;

                // Ê™¢Êü•Â§©Ê∞£ÂäüËÉΩÊòØÂê¶ÂïüÁî®
                if (!weatherDisplayEnabled) {
                    document.getElementById('weatherStatus').textContent = 'Â∑≤ÈóúÈñâ';
                    return;
                }

                document.getElementById('weatherStatus').textContent = 'ËºâÂÖ•‰∏≠';

                for (const city of CITY_DATA) {
                    try {
                        await fetchWeatherData(city.coordinates[1], city.coordinates[0]);
                        loadedCount++;

                        // Êõ¥Êñ∞Áµ±Ë®àÁãÄÊÖã
                        const statusElement = document.getElementById('weatherStatus');
                        if (statusElement) {
                            statusElement.textContent = `${loadedCount}/${CITY_DATA.length}`;
                        }
                    } catch (error) {
                        console.warn(`ËºâÂÖ• ${city.name_zh} Â§©Ê∞£Ë≥áÊñôÂ§±Êïó:`, error);
                    }

                    // Áü≠Êö´Âª∂ÈÅ≤ÈÅøÂÖçAPIÈôêÂà∂
                    await new Promise(resolve => setTimeout(resolve, 150));
                }

                const statusElement = document.getElementById('weatherStatus');
                if (statusElement) {
                    statusElement.textContent = loadedCount > 0 ? `${loadedCount} ÂÄãÂüéÂ∏Ç` : 'ËºâÂÖ•Â§±Êïó';
                }
                console.log(`‚úÖ Â§©Ê∞£Êï∏ÊìöËºâÂÖ•ÂÆåÊàê: ${loadedCount}/${CITY_DATA.length}`);
            } catch (error) {
                console.error('‚ùå Â§©Ê∞£Êï∏ÊìöËºâÂÖ•ÈåØË™§:', error);
                const statusElement = document.getElementById('weatherStatus');
                if (statusElement) {
                    statusElement.textContent = 'ËºâÂÖ•Â§±Êïó';
                }
            }
        }

        // ËøîÂõû‰πãÂâçÁöÑË¶ñÂúñ
        function returnToPreviousView() {
            if (!map || !previousView) {
                console.log('‚ö†Ô∏è  Ê≤íÊúâÂÑ≤Â≠òÁöÑË¶ñÂúñÁãÄÊÖã');
                return;
            }

            console.log('üîô ËøîÂõû‰πãÂâçÁöÑË¶ñÂúñ');

            // Á¢∫‰øùÊâÄÊúâÂΩàÁ™óÈÉΩË¢´ÈóúÈñâ
            const popups = document.querySelectorAll('.mapboxgl-popup');
            popups.forEach(popup => {
                try {
                    popup.remove();
                } catch (error) {
                    console.warn('Ê∏ÖÁêÜÂΩàÁ™óÊôÇÂá∫ÁèæÈåØË™§:', error);
                }
            });

            map.flyTo({
                center: [previousView.center.lng, previousView.center.lat],
                zoom: previousView.zoom,
                pitch: previousView.pitch,
                bearing: previousView.bearing,
                duration: 1200,
                curve: 1.1,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2);
                }
            });

            previousView = null;
            document.getElementById('returnViewBtn').style.display = 'none';
        }

        // ÂàáÊèõÂú∞ÂúñÊ®£Âºè
        function changeMapStyle(styleUrl) {
            if (!map) return;

            map.setStyle(styleUrl);

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.control-section .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // ÈáçÊñ∞Ê∑ªÂä†Êï∏ÊìöÂ±§
            map.on('styledata', function () {
                if (map.isStyleLoaded()) {
                    addCityData();
                }
            });

            console.log('üé® Âú∞ÂúñÊ®£ÂºèÂ∑≤Êõ¥Êîπ:', styleUrl);
        }

        // ÂàáÊèõÊ®ôÁ±§Ë™ûË®Ä
        function changeLabelLanguage(language) {
            if (!map || !map.getLayer('cities-label')) return;

            currentLanguage = language;

            map.setLayoutProperty('cities-label', 'text-field', LANGUAGE_FIELDS[language]);

            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.querySelectorAll('.control-section:nth-child(3) .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            console.log('üåê Ê®ôÁ±§Ë™ûË®ÄÂ∑≤ÂàáÊèõ:', LANGUAGE_DISPLAY_NAMES[language]);
        }

        // È£õË°åÂà∞ÁâπÂÆöÂçÄÂüü
        function flyToRegion(region) {
            if (!map || !REGIONS[region]) return;

            const regionData = REGIONS[region];

            map.flyTo({
                center: regionData.center,
                zoom: regionData.zoom,
                duration: 2000,
                curve: 1.2,
                easing: function (t) {
                    return 1 - Math.pow(1 - t, 2);
                }
            });

            console.log('‚úàÔ∏è È£õË°åÂà∞ÂçÄÂüü:', region);
        }

        // ÂàáÊèõÂ§©Ê∞£È°ØÁ§∫
        function toggleWeatherDisplay() {
            weatherDisplayEnabled = !weatherDisplayEnabled;
            const button = document.getElementById('weatherToggle');

            if (weatherDisplayEnabled) {
                button.textContent = 'È°ØÁ§∫Â§©Ê∞£Ë≥áË®ä';
                button.classList.add('active');
            } else {
                button.textContent = 'Èö±ËóèÂ§©Ê∞£Ë≥áË®ä';
                button.classList.remove('active');
                hideWeatherTooltip();
            }

            console.log('üå§Ô∏è Â§©Ê∞£È°ØÁ§∫:', weatherDisplayEnabled ? 'ÈñãÂïü' : 'ÈóúÈñâ');
        }

        // Âà∑Êñ∞Â§©Ê∞£Êï∏Êìö
        function refreshWeatherData() {
            weatherCache.clear();
            loadWeatherForAllCities();
            console.log('üîÑ Â§©Ê∞£Êï∏ÊìöÂ∑≤Âà∑Êñ∞');
        }

        // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
        function updateStatistics() {
            const totalPopulation = CITY_DATA.reduce((sum, city) => sum + city.population, 0);
            const maxCity = CITY_DATA.reduce((max, city) =>
                city.population > max.population ? city : max
            );

            document.getElementById('totalPopulation').textContent = (totalPopulation / 1000000).toFixed(1) + 'M';
            document.getElementById('maxCity').textContent = maxCity.name_zh || maxCity.name_en;
        }

        // È°ØÁ§∫/Èö±ËóèËºâÂÖ•Áï´Èù¢
        function showLoading(show) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = show ? 'flex' : 'none';
            }
        }

        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            showLoading(false);
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.innerHTML = `
                    <div class="loading-content">
                        <div style="color: #e74c3c; font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <p style="color: #e74c3c; font-weight: bold;">ËºâÂÖ•ÈåØË™§</p>
                        <p style="color: #666; margin-top: 0.5rem;">${message}</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ÈáçÊñ∞ËºâÂÖ•
                        </button>
                    </div>
                `;
                loadingOverlay.style.display = 'flex';
            }
        }

        // Áç≤ÂèñÁï∂ÂâçÊôÇÈñì
        function getCurrentTime() {
            return new Date().toLocaleTimeString('zh-TW', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ÂàùÂßãÂåñÊáâÁî®
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ ÊáâÁî®Á®ãÂºèÈñãÂßãÂàùÂßãÂåñ...');

            // Ë®≠ÁΩÆÂàùÂßãËºâÂÖ•Ë∂ÖÊôÇ
            const loadingTimeout = setTimeout(() => {
                console.warn('‚ö†Ô∏è ËºâÂÖ•Ë∂ÖÊôÇÔºåÂòóË©¶ÈáçÊñ∞ËºâÂÖ•...');
                showError('ËºâÂÖ•Ë∂ÖÊôÇÔºåË´ãÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢');
            }, 10000); // 10ÁßíË∂ÖÊôÇ

            try {
                initializeMap();

                // Â¶ÇÊûúÂàùÂßãÂåñÊàêÂäüÔºåÊ∏ÖÈô§Ë∂ÖÊôÇ
                map.on('load', () => {
                    clearTimeout(loadingTimeout);
                });
            } catch (error) {
                clearTimeout(loadingTimeout);
                console.error('‚ùå ÂàùÂßãÂåñÈåØË™§:', error);
                showError('ÊáâÁî®Á®ãÂºèÂàùÂßãÂåñÂ§±Êïó');
            }
        });

        // ÂÖ®ÂüüÈåØË™§ËôïÁêÜ
        window.addEventListener('error', function (e) {
            console.error('üö® ÊáâÁî®Á®ãÂºèÈåØË™§:', e.error);
            showError('ÁôºÁîüÊú™È†êÊúüÁöÑÈåØË™§: ' + e.error.message);
        });

        // Promise ÈåØË™§ËôïÁêÜ
        window.addEventListener('unhandledrejection', function (e) {
            console.error('üö® Êú™ËôïÁêÜÁöÑ Promise ÈåØË™§:', e.reason);
            // ‰∏çÈ°ØÁ§∫ÈåØË™§Ë®äÊÅØÔºåÈÅøÂÖçÂ§©Ê∞£APIÈåØË™§ÂΩ±Èüø‰ΩøÁî®ËÄÖÈ´îÈ©ó
            console.warn('Promise ÈåØË™§Â∑≤Ë®òÈåÑ‰ΩÜ‰∏ç‰∏≠Êñ∑ÊáâÁî®Á®ãÂºè');
        });
    </script>
</body>

</html>