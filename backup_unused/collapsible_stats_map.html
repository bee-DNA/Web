<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç ÂèØÊî∂Á¥çÁµ±Ë®àÈù¢ÊùøÂú∞ÂúñÁ≥ªÁµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar.collapsed {
            transform: translateX(-310px);
        }

        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0 8px 8px 0;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .sidebar-toggle:hover {
            transform: translateY(-50%) translateX(2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .sidebar-toggle .toggle-icon {
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle .toggle-icon {
            transform: rotate(180deg);
        }

        .panel {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* ÂèØÊî∂Á¥çÁµ±Ë®àÈù¢ÊùøÊ®£Âºè */
        .collapsible-stats {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #28a745;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .stats-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .stats-header:hover {
            background: linear-gradient(135deg, #218838 0%, #1e8a7a 100%);
        }

        .stats-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stats-toggle {
            font-size: 1.2rem;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
        }

        .stats-toggle::before {
            content: "üìä";
            margin-right: 8px;
        }

        .stats-toggle::after {
            content: "‚ñº";
            margin-left: 8px;
        }

        .collapsible-stats.collapsed .stats-toggle {
            transform: rotate(-90deg);
        }

        .stats-content {
            max-height: 500px;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 0 1.5rem;
        }

        .collapsible-stats.collapsed .stats-content {
            max-height: 0;
            padding: 0 1.5rem;
        }

        .stats-inner {
            padding: 1.5rem 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .stat-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stat-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stat-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .stat-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .stat-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .stat-item:nth-child(6) {
            animation-delay: 0.6s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collapsible-stats.collapsed .stat-item {
            animation: none;
            opacity: 0;
            transform: translateY(10px);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(5px);
            padding-left: 0.5rem;
            border-radius: 4px;
        }

        .stat-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .stat-label::before {
            content: "üìç";
            margin-right: 8px;
            font-size: 1rem;
        }

        .stat-item:nth-child(1) .stat-label::before {
            content: "üîç";
        }

        .stat-item:nth-child(2) .stat-label::before {
            content: "üìç";
        }

        .stat-item:nth-child(3) .stat-label::before {
            content: "üìä";
        }

        .stat-item:nth-child(4) .stat-label::before {
            content: "üé®";
        }

        .stat-item:nth-child(5) .stat-label::before {
            content: "üåê";
        }

        .stat-item:nth-child(6) .stat-label::before {
            content: "‚öôÔ∏è";
        }

        .stat-value {
            font-weight: 600;
            color: #28a745;
            font-size: 0.95rem;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            min-width: 80px;
            text-align: center;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            border: 2px solid transparent;
        }

        .stat-value.updating {
            animation: pulse 0.8s ease-in-out;
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
            transform: scale(1.02);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
        }

        /* Ëá™ÂãïÊî∂Á¥çÊåáÁ§∫Âô® */
        .auto-collapse-indicator {
            position: absolute;
            top: 10px;
            right: 60px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            color: #28a745;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auto-collapse-indicator.active {
            opacity: 1;
        }

        /* Êõ¥Êñ∞Ë®àÊï∏Âô® */
        .update-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .map-container {
            flex: 1;
            position: relative;
            transition: margin-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar.collapsed+.map-container {
            margin-left: -310px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select,
        button,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Ê®ôÈ°å -->
        <div class="header">
            <h1>üåç ÂèØÊî∂Á¥çÁµ±Ë®àÈù¢ÊùøÂú∞ÂúñÁ≥ªÁµ±</h1>
            <p>Êô∫ËÉΩÊî∂Á¥çÁµ±Ë®àÈù¢ÊùøÔºåÂ±ïÈñãÊôÇËá™ÂãïÊõ¥Êñ∞Êï∏ÊìöÔºåÂÖ∑ÂÇôÊµÅÊö¢ÂãïÁï´ÊïàÊûú</p>
        </div>

        <div class="main-content">
            <!-- ÂÅ¥ÈÇäÊ¨Ñ -->
            <div class="sidebar" id="sidebar">
                <!-- ÂÅ¥ÈÇäÊ¨ÑÂàáÊèõÊåâÈàï -->
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <span class="toggle-icon">‚óÄ</span>
                </button>

                <!-- ÂèØÊî∂Á¥çÁµ±Ë®àÈù¢Êùø -->
                <div class="collapsible-stats" id="collapsibleStats">
                    <div class="stats-header" onclick="toggleStats()">
                        <h3>ÂØ¶ÊôÇÂú∞ÂúñÁµ±Ë®à</h3>
                        <div class="stats-toggle"></div>
                    </div>

                    <div class="stats-content">
                        <div class="stats-inner">
                            <div class="stat-item">
                                <span class="stat-label">Áï∂ÂâçÁ∏ÆÊîæÁ¥öÂà•</span>
                                <span class="stat-value" id="currentZoom">ËºâÂÖ•‰∏≠...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">‰∏≠ÂøÉÂ∫ßÊ®ô</span>
                                <span class="stat-value" id="centerCoords">ËºâÂÖ•‰∏≠...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">ËºâÂÖ•ÁöÑÊï∏ÊìöÈªû</span>
                                <span class="stat-value" id="dataPoints">0</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">Âú∞ÂúñÊ®£Âºè</span>
                                <span class="stat-value" id="currentStyle">ËºâÂÖ•‰∏≠...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">Ê®ôÁ±§Ë™ûË®Ä</span>
                                <span class="stat-value" id="currentLabelLanguage">‰∏≠Êñá</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">Êï∏ÊìöÈªûÊ®£Âºè</span>
                                <span class="stat-value" id="currentPointStyle">‰æùÊï∏ÊìöÂ§ßÂ∞è</span>
                            </div>
                        </div>

                        <!-- Êõ¥Êñ∞Ë®àÊï∏Âô® -->
                        <div class="update-counter">
                            Êõ¥Êñ∞: <span id="updateCounter">0</span> Ê¨°
                        </div>
                    </div>

                    <!-- Ëá™ÂãïÊî∂Á¥çÊåáÁ§∫Âô® -->
                    <div class="auto-collapse-indicator" id="autoCollapseIndicator">
                        <span id="autoCollapseCountdown">5</span>ÁßíÂæåËá™ÂãïÊî∂Á¥ç
                    </div>
                </div>

                <!-- ÊéßÂà∂Èù¢Êùø -->
                <div class="panel">
                    <h3>üéõÔ∏è Âú∞ÂúñÊéßÂà∂</h3>

                    <div class="control-group">
                        <label for="mapStyle">Âú∞ÂúñÊ®£Âºè:</label>
                        <select id="mapStyle">
                            <option value="osm">OpenStreetMap</option>
                            <option value="osm-dark">OpenStreetMap Ê∑±Ëâ≤</option>
                            <option value="carto-positron">CartoDB Êòé‰∫ÆÁâà</option>
                            <option value="carto-darkmatter">CartoDB Ê∑±Ëâ≤Áâà</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="autoCollapseTime">Ëá™ÂãïÊî∂Á¥çÊôÇÈñì:</label>
                        <select id="autoCollapseTime">
                            <option value="3">3ÁßíÂæåÊî∂Á¥ç</option>
                            <option value="5" selected>5ÁßíÂæåÊî∂Á¥ç</option>
                            <option value="8">8ÁßíÂæåÊî∂Á¥ç</option>
                            <option value="10">10ÁßíÂæåÊî∂Á¥ç</option>
                            <option value="0">ÈóúÈñâËá™ÂãïÊî∂Á¥ç</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button onclick="resetToTaiwan()">üáπüáº ÂõûÂà∞Âè∞ÁÅ£</button>
                    </div>

                    <div class="control-group">
                        <button onclick="generateRandomData()">üé≤ ÁîüÊàêÈö®Ê©üÊï∏Êìö</button>
                    </div>
                </div>
            </div>

            <!-- Âú∞ÂúñÂÆπÂô® -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let map;
        let currentCityGeoJSON = null;
        let statsCollapsed = false;
        let sidebarCollapsed = false;
        let autoCollapseTimer = null;
        let autoCollapseTime = 5; // È†êË®≠5Áßí
        let updateCounter = 0;

        // Âú∞ÂúñÊ®£ÂºèÈÖçÁΩÆ
        const MAP_STYLES = {
            'osm': {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            'osm-dark': {
                version: 8,
                sources: {
                    'osm-dark': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors, ¬© CartoDB'
                    }
                },
                layers: [{
                    id: 'osm-dark',
                    type: 'raster',
                    source: 'osm-dark'
                }]
            },
            'carto-positron': {
                version: 8,
                sources: {
                    'carto-positron': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors, ¬© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-positron',
                    type: 'raster',
                    source: 'carto-positron'
                }]
            },
            'carto-darkmatter': {
                version: 8,
                sources: {
                    'carto-darkmatter': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: '¬© OpenStreetMap contributors, ¬© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-darkmatter',
                    type: 'raster',
                    source: 'carto-darkmatter'
                }]
            }
        };

        // ÂàùÂßãÂåñÂú∞Âúñ
        function initializeMap() {
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: MAP_STYLES['osm'],
                    center: [121.5654, 25.0330], // Âè∞Âåó
                    zoom: 10,
                    pitch: 0,
                    bearing: 0
                });

                map.on('load', () => {
                    console.log('‚úÖ Âú∞ÂúñËºâÂÖ•ÂÆåÊàê');
                    loadInitialData();
                    bindControlEvents();
                    updateMapStats();

                    // Á∂ÅÂÆöÂú∞ÂúñÁßªÂãï‰∫ã‰ª∂
                    map.on('move', updateMapStats);
                    map.on('zoom', updateMapStats);
                });

                map.on('error', (e) => {
                    console.error('‚ùå Âú∞ÂúñËºâÂÖ•ÈåØË™§:', e);
                });

            } catch (error) {
                console.error('‚ùå Âú∞ÂúñÂàùÂßãÂåñÂ§±Êïó:', error);
            }
        }

        // ÂàáÊèõÁµ±Ë®àÈù¢Êùø
        function toggleStats() {
            const statsPanel = document.getElementById('collapsibleStats');
            const indicator = document.getElementById('autoCollapseIndicator');

            statsCollapsed = !statsCollapsed;

            if (statsCollapsed) {
                // Êî∂Á¥çÁãÄÊÖã
                statsPanel.classList.add('collapsed');
                indicator.classList.remove('active');
                clearTimeout(autoCollapseTimer);
                console.log('üìä Áµ±Ë®àÈù¢ÊùøÂ∑≤Êî∂Á¥ç');
            } else {
                // Â±ïÈñãÁãÄÊÖã
                statsPanel.classList.remove('collapsed');

                // Â±ïÈñãÊôÇÁ´ãÂç≥Êõ¥Êñ∞ÊâÄÊúâÊï∏Êìö
                setTimeout(() => {
                    updateMapStats(true); // Âº∑Âà∂Êõ¥Êñ∞ÊâÄÊúâÊï∏Êìö
                }, 100);

                // ÂïüÂãïËá™ÂãïÊî∂Á¥ç
                if (autoCollapseTime > 0) {
                    startAutoCollapse();
                }

                console.log('üìä Áµ±Ë®àÈù¢ÊùøÂ∑≤Â±ïÈñãÔºåËá™ÂãïÊõ¥Êñ∞Êï∏Êìö');
            }
        }

        // ÈñãÂßãËá™ÂãïÊî∂Á¥çÂÄíË®àÊôÇ
        function startAutoCollapse() {
            const indicator = document.getElementById('autoCollapseIndicator');
            const countdownElement = document.getElementById('autoCollapseCountdown');

            let timeLeft = autoCollapseTime;

            indicator.classList.add('active');
            countdownElement.textContent = timeLeft;

            const countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    indicator.classList.remove('active');

                    // Ëá™ÂãïÊî∂Á¥ç
                    if (!statsCollapsed) {
                        toggleStats();
                    }
                }
            }, 1000);

            // ÂÑ≤Â≠òÂÆöÊôÇÂô®‰ª•‰æøÂèñÊ∂à
            autoCollapseTimer = countdownInterval;
        }

        // ÂàáÊèõÂÅ¥ÈÇäÊ¨Ñ
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;

            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
            } else {
                sidebar.classList.remove('collapsed');
            }
        }

        // Êõ¥Êñ∞Âú∞ÂúñÁµ±Ë®à
        function updateMapStats(forceUpdate = false) {
            if (!map) return;

            updateCounter++;
            document.getElementById('updateCounter').textContent = updateCounter;

            try {
                const center = map.getCenter();
                const zoom = map.getZoom();

                // Â¶ÇÊûúÊòØÂº∑Âà∂Êõ¥Êñ∞ÔºàÂ±ïÈñãÊôÇÔºâÔºåÊ∑ªÂä†ÂãïÁï´ÊïàÊûú
                if (forceUpdate) {
                    const elements = ['currentZoom', 'centerCoords', 'dataPoints', 'currentStyle', 'currentLabelLanguage', 'currentPointStyle'];
                    elements.forEach((id, index) => {
                        const element = document.getElementById(id);
                        if (element) {
                            setTimeout(() => {
                                element.classList.add('updating');
                                setTimeout(() => element.classList.remove('updating'), 800);
                            }, index * 100);
                        }
                    });
                }

                // Êõ¥Êñ∞Êï∏ÂÄº
                updateElement('currentZoom', `${zoom.toFixed(2)}¬∞`);
                updateElement('centerCoords', `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
                updateElement('dataPoints', currentCityGeoJSON ? currentCityGeoJSON.features.length : '0');

                // Êõ¥Êñ∞Ê®£ÂºèÂêçÁ®±
                const styleSelect = document.getElementById('mapStyle');
                if (styleSelect && styleSelect.selectedIndex >= 0) {
                    const selectedOption = styleSelect.options[styleSelect.selectedIndex];
                    updateElement('currentStyle', selectedOption.text);
                }

                updateElement('currentLabelLanguage', '‰∏≠Êñá');
                updateElement('currentPointStyle', '‰æùÊï∏ÊìöÂ§ßÂ∞è');

            } catch (error) {
                console.warn('‚ö†Ô∏è Êõ¥Êñ∞Áµ±Ë®àÊôÇÁôºÁîüÈåØË™§:', error);
            }
        }

        // ÂÆâÂÖ®Êõ¥Êñ∞ÂÖÉÁ¥†ÂÖßÂÆπ
        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element && element.textContent !== content) {
                element.textContent = content;
            }
        }

        // Á∂ÅÂÆöÊéßÂà∂‰∫ã‰ª∂
        function bindControlEvents() {
            // Âú∞ÂúñÊ®£ÂºèÂàáÊèõ
            const styleSelect = document.getElementById('mapStyle');
            styleSelect.addEventListener('change', (e) => {
                const style = MAP_STYLES[e.target.value];
                if (style) {
                    map.setStyle(style);
                    console.log(`üé® Âú∞ÂúñÊ®£ÂºèÂ∑≤ÂàáÊèõËá≥: ${e.target.value}`);
                    setTimeout(() => updateMapStats(true), 1000); // Ê®£ÂºèËºâÂÖ•ÂæåÊõ¥Êñ∞Áµ±Ë®à
                }
            });

            // Ëá™ÂãïÊî∂Á¥çÊôÇÈñìË®≠ÂÆö
            const autoCollapseSelect = document.getElementById('autoCollapseTime');
            autoCollapseSelect.addEventListener('change', (e) => {
                autoCollapseTime = parseInt(e.target.value);
                console.log(`‚è∞ Ëá™ÂãïÊî∂Á¥çÊôÇÈñìË®≠ÂÆöÁÇ∫: ${autoCollapseTime}Áßí`);

                // Â¶ÇÊûúÁµ±Ë®àÈù¢ÊùøÊòØÂ±ïÈñãÁãÄÊÖãÔºåÈáçÊñ∞ÈñãÂßãÂÄíË®àÊôÇ
                if (!statsCollapsed && autoCollapseTime > 0) {
                    clearTimeout(autoCollapseTimer);
                    startAutoCollapse();
                } else if (autoCollapseTime === 0) {
                    // ÈóúÈñâËá™ÂãïÊî∂Á¥ç
                    clearTimeout(autoCollapseTimer);
                    document.getElementById('autoCollapseIndicator').classList.remove('active');
                }
            });
        }

        // ËºâÂÖ•ÂàùÂßãÊï∏Êìö
        function loadInitialData() {
            generateRandomData();
        }

        // ÁîüÊàêÈö®Ê©üÊï∏Êìö
        function generateRandomData() {
            const cities = [
                { name: 'Âè∞Âåó', coords: [121.5654, 25.0330] },
                { name: 'Âè∞‰∏≠', coords: [120.6736, 24.1477] },
                { name: 'È´òÈõÑ', coords: [120.3014, 22.6273] },
                { name: 'Âè∞Âçó', coords: [120.2513, 22.9917] },
                { name: 'Êñ∞Á´π', coords: [120.9647, 24.8138] },
                { name: 'Âü∫ÈöÜ', coords: [121.7081, 25.1276] },
                { name: 'Ê°ÉÂúí', coords: [121.2168, 24.9936] },
                { name: 'ÂòâÁæ©', coords: [120.4473, 23.4801] },
                { name: 'ÂÆúËò≠', coords: [121.7195, 24.7021] },
                { name: 'Ëä±ËìÆ', coords: [121.6015, 23.9927] }
            ];

            const features = cities.map((city, index) => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: city.coords
                },
                properties: {
                    name: city.name,
                    value: Math.floor(Math.random() * 100),
                    size: Math.floor(Math.random() * 15) + 8
                }
            }));

            currentCityGeoJSON = {
                type: 'FeatureCollection',
                features: features
            };

            // Ê∑ªÂä†Âà∞Âú∞Âúñ
            if (map.getSource('cities')) {
                map.getSource('cities').setData(currentCityGeoJSON);
            } else {
                map.addSource('cities', {
                    type: 'geojson',
                    data: currentCityGeoJSON
                });

                map.addLayer({
                    id: 'cities',
                    type: 'circle',
                    source: 'cities',
                    paint: {
                        'circle-radius': ['get', 'size'],
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'value'],
                            0, '#3498db',
                            25, '#2ecc71',
                            50, '#f39c12',
                            75, '#e74c3c',
                            100, '#9b59b6'
                        ],
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });
            }

            updateMapStats(true);
            console.log(`üé≤ Â∑≤ÁîüÊàê ${cities.length} ÂÄãÈö®Ê©üÊï∏ÊìöÈªû`);
        }

        // ÂõûÂà∞Âè∞ÁÅ£
        function resetToTaiwan() {
            if (map) {
                map.flyTo({
                    center: [121.5654, 25.0330],
                    zoom: 7,
                    duration: 2000
                });
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Ê≠£Âú®ÂàùÂßãÂåñÂèØÊî∂Á¥çÁµ±Ë®àÈù¢ÊùøÂú∞ÂúñÁ≥ªÁµ±...');
            initializeMap();
        });

        // ÈçµÁõ§Âø´Êç∑Èçµ
        document.addEventListener('keydown', (e) => {
            // Êåâ 'S' ÈçµÂàáÊèõÁµ±Ë®àÈù¢Êùø
            if (e.key.toLowerCase() === 's' && !e.ctrlKey && !e.altKey) {
                toggleStats();
                e.preventDefault();
            }

            // Êåâ 'Tab' ÈçµÂàáÊèõÂÅ¥ÈÇäÊ¨Ñ
            if (e.key === 'Tab' && e.ctrlKey) {
                toggleSidebar();
                e.preventDefault();
            }
        });

        // ÊªëÈº†Êá∏ÂÅúÊö´ÂÅúËá™ÂãïÊî∂Á¥ç
        document.getElementById('collapsibleStats').addEventListener('mouseenter', () => {
            if (autoCollapseTimer) {
                clearTimeout(autoCollapseTimer);
                document.getElementById('autoCollapseIndicator').classList.remove('active');
            }
        });

        document.getElementById('collapsibleStats').addEventListener('mouseleave', () => {
            if (!statsCollapsed && autoCollapseTime > 0) {
                startAutoCollapse();
            }
        });
    </script>
</body>

</html>