<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ å¯æ”¶ç´çµ±è¨ˆé¢æ¿åœ°åœ–ç³»çµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar.collapsed {
            transform: translateX(-310px);
        }

        .sidebar-toggle {
            position: absolute;
            right: -40px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0 8px 8px 0;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 101;
        }

        .sidebar-toggle:hover {
            transform: translateY(-50%) translateX(2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .sidebar-toggle .toggle-icon {
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed .sidebar-toggle .toggle-icon {
            transform: rotate(180deg);
        }

        .panel {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* å¯æ”¶ç´çµ±è¨ˆé¢æ¿æ¨£å¼ */
        .collapsible-stats {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #28a745;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .stats-header {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            user-select: none;
        }

        .stats-header:hover {
            background: linear-gradient(135deg, #218838 0%, #1e8a7a 100%);
        }

        .stats-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stats-toggle {
            font-size: 1.2rem;
            transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
        }

        .stats-toggle::before {
            content: "ğŸ“Š";
            margin-right: 8px;
        }

        .stats-toggle::after {
            content: "â–¼";
            margin-left: 8px;
        }

        .collapsible-stats.collapsed .stats-toggle {
            transform: rotate(-90deg);
        }

        .stats-content {
            max-height: 500px;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
            padding: 0 1.5rem;
        }

        .collapsible-stats.collapsed .stats-content {
            max-height: 0;
            padding: 0 1.5rem;
        }

        .stats-inner {
            padding: 1.5rem 0;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeInUp 0.6s ease forwards;
        }

        .stat-item:nth-child(1) {
            animation-delay: 0.1s;
        }

        .stat-item:nth-child(2) {
            animation-delay: 0.2s;
        }

        .stat-item:nth-child(3) {
            animation-delay: 0.3s;
        }

        .stat-item:nth-child(4) {
            animation-delay: 0.4s;
        }

        .stat-item:nth-child(5) {
            animation-delay: 0.5s;
        }

        .stat-item:nth-child(6) {
            animation-delay: 0.6s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .collapsible-stats.collapsed .stat-item {
            animation: none;
            opacity: 0;
            transform: translateY(10px);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(5px);
            padding-left: 0.5rem;
            border-radius: 4px;
        }

        .stat-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
        }

        .stat-label::before {
            content: "ğŸ“";
            margin-right: 8px;
            font-size: 1rem;
        }

        .stat-item:nth-child(1) .stat-label::before {
            content: "ğŸ”";
        }

        .stat-item:nth-child(2) .stat-label::before {
            content: "ğŸ“";
        }

        .stat-item:nth-child(3) .stat-label::before {
            content: "ğŸ“Š";
        }

        .stat-item:nth-child(4) .stat-label::before {
            content: "ğŸ¨";
        }

        .stat-item:nth-child(5) .stat-label::before {
            content: "ğŸŒ";
        }

        .stat-item:nth-child(6) .stat-label::before {
            content: "âš™ï¸";
        }

        .stat-value {
            font-weight: 600;
            color: #28a745;
            font-size: 0.95rem;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            min-width: 80px;
            text-align: center;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            border: 2px solid transparent;
        }

        .stat-value.updating {
            animation: pulse 0.8s ease-in-out;
            background: rgba(40, 167, 69, 0.2);
            border-color: #28a745;
            transform: scale(1.02);
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
        }

        /* è‡ªå‹•æ”¶ç´æŒ‡ç¤ºå™¨ */
        .auto-collapse-indicator {
            position: absolute;
            top: 10px;
            right: 60px;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            color: #28a745;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auto-collapse-indicator.active {
            opacity: 1;
        }

        /* æ›´æ–°è¨ˆæ•¸å™¨ */
        .update-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .map-container {
            flex: 1;
            position: relative;
            transition: margin-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .sidebar.collapsed+.map-container {
            margin-left: -310px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select,
        button,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <h1>ğŸŒ å¯æ”¶ç´çµ±è¨ˆé¢æ¿åœ°åœ–ç³»çµ±</h1>
            <p>æ™ºèƒ½æ”¶ç´çµ±è¨ˆé¢æ¿ï¼Œå±•é–‹æ™‚è‡ªå‹•æ›´æ–°æ•¸æ“šï¼Œå…·å‚™æµæš¢å‹•ç•«æ•ˆæœ</p>
        </div>

        <div class="main-content">
            <!-- å´é‚Šæ¬„ -->
            <div class="sidebar" id="sidebar">
                <!-- å´é‚Šæ¬„åˆ‡æ›æŒ‰éˆ• -->
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <span class="toggle-icon">â—€</span>
                </button>

                <!-- å¯æ”¶ç´çµ±è¨ˆé¢æ¿ -->
                <div class="collapsible-stats" id="collapsibleStats">
                    <div class="stats-header" onclick="toggleStats()">
                        <h3>å¯¦æ™‚åœ°åœ–çµ±è¨ˆ</h3>
                        <div class="stats-toggle"></div>
                    </div>

                    <div class="stats-content">
                        <div class="stats-inner">
                            <div class="stat-item">
                                <span class="stat-label">ç•¶å‰ç¸®æ”¾ç´šåˆ¥</span>
                                <span class="stat-value" id="currentZoom">è¼‰å…¥ä¸­...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">ä¸­å¿ƒåº§æ¨™</span>
                                <span class="stat-value" id="centerCoords">è¼‰å…¥ä¸­...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">è¼‰å…¥çš„æ•¸æ“šé»</span>
                                <span class="stat-value" id="dataPoints">0</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">åœ°åœ–æ¨£å¼</span>
                                <span class="stat-value" id="currentStyle">è¼‰å…¥ä¸­...</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">æ¨™ç±¤èªè¨€</span>
                                <span class="stat-value" id="currentLabelLanguage">ä¸­æ–‡</span>
                            </div>

                            <div class="stat-item">
                                <span class="stat-label">æ•¸æ“šé»æ¨£å¼</span>
                                <span class="stat-value" id="currentPointStyle">ä¾æ•¸æ“šå¤§å°</span>
                            </div>
                        </div>

                        <!-- æ›´æ–°è¨ˆæ•¸å™¨ -->
                        <div class="update-counter">
                            æ›´æ–°: <span id="updateCounter">0</span> æ¬¡
                        </div>
                    </div>

                    <!-- è‡ªå‹•æ”¶ç´æŒ‡ç¤ºå™¨ -->
                    <div class="auto-collapse-indicator" id="autoCollapseIndicator">
                        <span id="autoCollapseCountdown">5</span>ç§’å¾Œè‡ªå‹•æ”¶ç´
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="panel">
                    <h3>ğŸ›ï¸ åœ°åœ–æ§åˆ¶</h3>

                    <div class="control-group">
                        <label for="mapStyle">åœ°åœ–æ¨£å¼:</label>
                        <select id="mapStyle">
                            <option value="osm">OpenStreetMap</option>
                            <option value="osm-dark">OpenStreetMap æ·±è‰²</option>
                            <option value="carto-positron">CartoDB æ˜äº®ç‰ˆ</option>
                            <option value="carto-darkmatter">CartoDB æ·±è‰²ç‰ˆ</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label for="autoCollapseTime">è‡ªå‹•æ”¶ç´æ™‚é–“:</label>
                        <select id="autoCollapseTime">
                            <option value="3">3ç§’å¾Œæ”¶ç´</option>
                            <option value="5" selected>5ç§’å¾Œæ”¶ç´</option>
                            <option value="8">8ç§’å¾Œæ”¶ç´</option>
                            <option value="10">10ç§’å¾Œæ”¶ç´</option>
                            <option value="0">é—œé–‰è‡ªå‹•æ”¶ç´</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button onclick="resetToTaiwan()">ğŸ‡¹ğŸ‡¼ å›åˆ°å°ç£</button>
                    </div>

                    <div class="control-group">
                        <button onclick="generateRandomData()">ğŸ² ç”Ÿæˆéš¨æ©Ÿæ•¸æ“š</button>
                    </div>
                </div>
            </div>

            <!-- åœ°åœ–å®¹å™¨ -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let map;
        let currentCityGeoJSON = null;
        let statsCollapsed = false;
        let sidebarCollapsed = false;
        let autoCollapseTimer = null;
        let autoCollapseTime = 5; // é è¨­5ç§’
        let updateCounter = 0;

        // åœ°åœ–æ¨£å¼é…ç½®
        const MAP_STYLES = {
            'osm': {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            'osm-dark': {
                version: 8,
                sources: {
                    'osm-dark': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'osm-dark',
                    type: 'raster',
                    source: 'osm-dark'
                }]
            },
            'carto-positron': {
                version: 8,
                sources: {
                    'carto-positron': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-positron',
                    type: 'raster',
                    source: 'carto-positron'
                }]
            },
            'carto-darkmatter': {
                version: 8,
                sources: {
                    'carto-darkmatter': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-darkmatter',
                    type: 'raster',
                    source: 'carto-darkmatter'
                }]
            }
        };

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: MAP_STYLES['osm'],
                    center: [121.5654, 25.0330], // å°åŒ—
                    zoom: 10,
                    pitch: 0,
                    bearing: 0
                });

                map.on('load', () => {
                    console.log('âœ… åœ°åœ–è¼‰å…¥å®Œæˆ');
                    loadInitialData();
                    bindControlEvents();
                    updateMapStats();

                    // ç¶å®šåœ°åœ–ç§»å‹•äº‹ä»¶
                    map.on('move', updateMapStats);
                    map.on('zoom', updateMapStats);
                });

                map.on('error', (e) => {
                    console.error('âŒ åœ°åœ–è¼‰å…¥éŒ¯èª¤:', e);
                });

            } catch (error) {
                console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
            }
        }

        // åˆ‡æ›çµ±è¨ˆé¢æ¿
        function toggleStats() {
            const statsPanel = document.getElementById('collapsibleStats');
            const indicator = document.getElementById('autoCollapseIndicator');

            statsCollapsed = !statsCollapsed;

            if (statsCollapsed) {
                // æ”¶ç´ç‹€æ…‹
                statsPanel.classList.add('collapsed');
                indicator.classList.remove('active');
                clearTimeout(autoCollapseTimer);
                console.log('ğŸ“Š çµ±è¨ˆé¢æ¿å·²æ”¶ç´');
            } else {
                // å±•é–‹ç‹€æ…‹
                statsPanel.classList.remove('collapsed');

                // å±•é–‹æ™‚ç«‹å³æ›´æ–°æ‰€æœ‰æ•¸æ“š
                setTimeout(() => {
                    updateMapStats(true); // å¼·åˆ¶æ›´æ–°æ‰€æœ‰æ•¸æ“š
                }, 100);

                // å•Ÿå‹•è‡ªå‹•æ”¶ç´
                if (autoCollapseTime > 0) {
                    startAutoCollapse();
                }

                console.log('ğŸ“Š çµ±è¨ˆé¢æ¿å·²å±•é–‹ï¼Œè‡ªå‹•æ›´æ–°æ•¸æ“š');
            }
        }

        // é–‹å§‹è‡ªå‹•æ”¶ç´å€’è¨ˆæ™‚
        function startAutoCollapse() {
            const indicator = document.getElementById('autoCollapseIndicator');
            const countdownElement = document.getElementById('autoCollapseCountdown');

            let timeLeft = autoCollapseTime;

            indicator.classList.add('active');
            countdownElement.textContent = timeLeft;

            const countdownInterval = setInterval(() => {
                timeLeft--;
                countdownElement.textContent = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    indicator.classList.remove('active');

                    // è‡ªå‹•æ”¶ç´
                    if (!statsCollapsed) {
                        toggleStats();
                    }
                }
            }, 1000);

            // å„²å­˜å®šæ™‚å™¨ä»¥ä¾¿å–æ¶ˆ
            autoCollapseTimer = countdownInterval;
        }

        // åˆ‡æ›å´é‚Šæ¬„
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebarCollapsed = !sidebarCollapsed;

            if (sidebarCollapsed) {
                sidebar.classList.add('collapsed');
            } else {
                sidebar.classList.remove('collapsed');
            }
        }

        // æ›´æ–°åœ°åœ–çµ±è¨ˆ
        function updateMapStats(forceUpdate = false) {
            if (!map) return;

            updateCounter++;
            document.getElementById('updateCounter').textContent = updateCounter;

            try {
                const center = map.getCenter();
                const zoom = map.getZoom();

                // å¦‚æœæ˜¯å¼·åˆ¶æ›´æ–°ï¼ˆå±•é–‹æ™‚ï¼‰ï¼Œæ·»åŠ å‹•ç•«æ•ˆæœ
                if (forceUpdate) {
                    const elements = ['currentZoom', 'centerCoords', 'dataPoints', 'currentStyle', 'currentLabelLanguage', 'currentPointStyle'];
                    elements.forEach((id, index) => {
                        const element = document.getElementById(id);
                        if (element) {
                            setTimeout(() => {
                                element.classList.add('updating');
                                setTimeout(() => element.classList.remove('updating'), 800);
                            }, index * 100);
                        }
                    });
                }

                // æ›´æ–°æ•¸å€¼
                updateElement('currentZoom', `${zoom.toFixed(2)}Â°`);
                updateElement('centerCoords', `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
                updateElement('dataPoints', currentCityGeoJSON ? currentCityGeoJSON.features.length : '0');

                // æ›´æ–°æ¨£å¼åç¨±
                const styleSelect = document.getElementById('mapStyle');
                if (styleSelect && styleSelect.selectedIndex >= 0) {
                    const selectedOption = styleSelect.options[styleSelect.selectedIndex];
                    updateElement('currentStyle', selectedOption.text);
                }

                updateElement('currentLabelLanguage', 'ä¸­æ–‡');
                updateElement('currentPointStyle', 'ä¾æ•¸æ“šå¤§å°');

            } catch (error) {
                console.warn('âš ï¸ æ›´æ–°çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        }

        // å®‰å…¨æ›´æ–°å…ƒç´ å…§å®¹
        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element && element.textContent !== content) {
                element.textContent = content;
            }
        }

        // ç¶å®šæ§åˆ¶äº‹ä»¶
        function bindControlEvents() {
            // åœ°åœ–æ¨£å¼åˆ‡æ›
            const styleSelect = document.getElementById('mapStyle');
            styleSelect.addEventListener('change', (e) => {
                const style = MAP_STYLES[e.target.value];
                if (style) {
                    map.setStyle(style);
                    console.log(`ğŸ¨ åœ°åœ–æ¨£å¼å·²åˆ‡æ›è‡³: ${e.target.value}`);
                    setTimeout(() => updateMapStats(true), 1000); // æ¨£å¼è¼‰å…¥å¾Œæ›´æ–°çµ±è¨ˆ
                }
            });

            // è‡ªå‹•æ”¶ç´æ™‚é–“è¨­å®š
            const autoCollapseSelect = document.getElementById('autoCollapseTime');
            autoCollapseSelect.addEventListener('change', (e) => {
                autoCollapseTime = parseInt(e.target.value);
                console.log(`â° è‡ªå‹•æ”¶ç´æ™‚é–“è¨­å®šç‚º: ${autoCollapseTime}ç§’`);

                // å¦‚æœçµ±è¨ˆé¢æ¿æ˜¯å±•é–‹ç‹€æ…‹ï¼Œé‡æ–°é–‹å§‹å€’è¨ˆæ™‚
                if (!statsCollapsed && autoCollapseTime > 0) {
                    clearTimeout(autoCollapseTimer);
                    startAutoCollapse();
                } else if (autoCollapseTime === 0) {
                    // é—œé–‰è‡ªå‹•æ”¶ç´
                    clearTimeout(autoCollapseTimer);
                    document.getElementById('autoCollapseIndicator').classList.remove('active');
                }
            });
        }

        // è¼‰å…¥åˆå§‹æ•¸æ“š
        function loadInitialData() {
            generateRandomData();
        }

        // ç”Ÿæˆéš¨æ©Ÿæ•¸æ“š
        function generateRandomData() {
            const cities = [
                { name: 'å°åŒ—', coords: [121.5654, 25.0330] },
                { name: 'å°ä¸­', coords: [120.6736, 24.1477] },
                { name: 'é«˜é›„', coords: [120.3014, 22.6273] },
                { name: 'å°å—', coords: [120.2513, 22.9917] },
                { name: 'æ–°ç«¹', coords: [120.9647, 24.8138] },
                { name: 'åŸºéš†', coords: [121.7081, 25.1276] },
                { name: 'æ¡ƒåœ’', coords: [121.2168, 24.9936] },
                { name: 'å˜‰ç¾©', coords: [120.4473, 23.4801] },
                { name: 'å®œè˜­', coords: [121.7195, 24.7021] },
                { name: 'èŠ±è“®', coords: [121.6015, 23.9927] }
            ];

            const features = cities.map((city, index) => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: city.coords
                },
                properties: {
                    name: city.name,
                    value: Math.floor(Math.random() * 100),
                    size: Math.floor(Math.random() * 15) + 8
                }
            }));

            currentCityGeoJSON = {
                type: 'FeatureCollection',
                features: features
            };

            // æ·»åŠ åˆ°åœ°åœ–
            if (map.getSource('cities')) {
                map.getSource('cities').setData(currentCityGeoJSON);
            } else {
                map.addSource('cities', {
                    type: 'geojson',
                    data: currentCityGeoJSON
                });

                map.addLayer({
                    id: 'cities',
                    type: 'circle',
                    source: 'cities',
                    paint: {
                        'circle-radius': ['get', 'size'],
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'value'],
                            0, '#3498db',
                            25, '#2ecc71',
                            50, '#f39c12',
                            75, '#e74c3c',
                            100, '#9b59b6'
                        ],
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });
            }

            updateMapStats(true);
            console.log(`ğŸ² å·²ç”Ÿæˆ ${cities.length} å€‹éš¨æ©Ÿæ•¸æ“šé»`);
        }

        // å›åˆ°å°ç£
        function resetToTaiwan() {
            if (map) {
                map.flyTo({
                    center: [121.5654, 25.0330],
                    zoom: 7,
                    duration: 2000
                });
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ–å¯æ”¶ç´çµ±è¨ˆé¢æ¿åœ°åœ–ç³»çµ±...');
            initializeMap();
        });

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            // æŒ‰ 'S' éµåˆ‡æ›çµ±è¨ˆé¢æ¿
            if (e.key.toLowerCase() === 's' && !e.ctrlKey && !e.altKey) {
                toggleStats();
                e.preventDefault();
            }

            // æŒ‰ 'Tab' éµåˆ‡æ›å´é‚Šæ¬„
            if (e.key === 'Tab' && e.ctrlKey) {
                toggleSidebar();
                e.preventDefault();
            }
        });

        // æ»‘é¼ æ‡¸åœæš«åœè‡ªå‹•æ”¶ç´
        document.getElementById('collapsibleStats').addEventListener('mouseenter', () => {
            if (autoCollapseTimer) {
                clearTimeout(autoCollapseTimer);
                document.getElementById('autoCollapseIndicator').classList.remove('active');
            }
        });

        document.getElementById('collapsibleStats').addEventListener('mouseleave', () => {
            if (!statsCollapsed && autoCollapseTime > 0) {
                startAutoCollapse();
            }
        });
    </script>
</body>

</html>