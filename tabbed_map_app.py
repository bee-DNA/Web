import dash
from dash import dcc, html, Input, Output
import plotly.graph_objects as go
import pandas as pd
import numpy as np

# Âª∫Á´ãÂ§öÊ®ôÁ±§Âú∞ÂúñÊáâÁî®
app = dash.Dash(__name__, suppress_callback_exceptions=True)


# Âª∫Á´ãÁØÑ‰æãÂú∞ÁêÜÊï£ÈªûË≥áÊñô
def create_geographic_scatter_data():
    """Âª∫Á´ãÂú∞ÁêÜÊï£ÈªûË≥áÊñô"""

    locations_data = {
        "city": [
            "Reykjavik",
            "Oslo",
            "Stockholm",
            "Helsinki",
            "Copenhagen",
            "London",
            "Paris",
            "Berlin",
            "Madrid",
            "Rome",
            "Moscow",
            "Kiev",
            "Warsaw",
            "Prague",
            "Vienna",
            "New York",
            "Los Angeles",
            "Chicago",
            "Toronto",
            "Vancouver",
            "Mexico City",
            "Lima",
            "Buenos Aires",
            "Sao Paulo",
            "Brasilia",
            "Cairo",
            "Lagos",
            "Johannesburg",
            "Nairobi",
            "Casablanca",
            "Tokyo",
            "Beijing",
            "Shanghai",
            "Mumbai",
            "Delhi",
            "Bangkok",
            "Jakarta",
            "Manila",
            "Seoul",
            "Sydney",
            "Singapore",
            "Kuala Lumpur",
            "Ho Chi Minh",
            "Hanoi",
            "Phnom Penh",
        ],
        "latitude": [
            64.1466,
            59.9139,
            59.3293,
            60.1699,
            55.6761,
            51.5074,
            48.8566,
            52.5200,
            40.4168,
            41.9028,
            55.7558,
            50.4501,
            52.2297,
            50.0755,
            48.2082,
            40.7128,
            34.0522,
            41.8781,
            43.6532,
            49.2827,
            19.4326,
            -12.0464,
            -34.6118,
            -23.5558,
            -15.8267,
            30.0444,
            6.5244,
            -26.2041,
            -1.2921,
            33.5731,
            35.6762,
            39.9042,
            31.2304,
            19.0760,
            28.7041,
            13.7563,
            -6.2088,
            14.5995,
            37.5665,
            -33.8688,
            1.3521,
            3.1390,
            10.8231,
            21.0285,
            11.5449,
        ],
        "longitude": [
            -21.9426,
            10.7522,
            18.0686,
            24.9384,
            12.5683,
            -0.1278,
            2.3522,
            13.4050,
            -3.7038,
            12.4964,
            37.6173,
            30.5234,
            21.0122,
            14.4378,
            16.3738,
            -74.0060,
            -118.2437,
            -87.6298,
            -79.3832,
            -123.1207,
            -99.1332,
            -77.0428,
            -58.3816,
            -46.6333,
            -47.8828,
            31.2357,
            3.3792,
            28.0473,
            36.8219,
            -7.5898,
            139.6503,
            116.4074,
            121.4737,
            72.8777,
            77.1025,
            100.5018,
            106.8456,
            120.9842,
            126.9780,
            151.2093,
            103.8198,
            101.6869,
            106.6297,
            105.8542,
            104.9160,
        ],
    }

    np.random.seed(42)
    values = np.random.randint(0, 101, len(locations_data["city"]))

    special_values = {
        "New York": 94,
        "London": 11,
        "Tokyo": 15,
        "Beijing": 1,
        "Shanghai": 1,
        "Moscow": 2,
        "Paris": 1,
        "Berlin": 3,
        "Sydney": 3,
        "Toronto": 34,
        "Los Angeles": 24,
        "Mumbai": 13,
        "Delhi": 5,
        "Bangkok": 3,
    }

    for i, city in enumerate(locations_data["city"]):
        if city in special_values:
            values[i] = special_values[city]

    locations_data["value"] = values

    return pd.DataFrame(locations_data)


# Âª∫Á´ãË≥áÊñô
df = create_geographic_scatter_data()


# ÂÆöÁæ©È°èËâ≤Êò†Â∞Ñ
def get_color_and_range(value):
    if 0 <= value <= 25:
        return "#3498db", "0-25"
    elif 26 <= value <= 50:
        return "#2ecc71", "26-50"
    elif 51 <= value <= 75:
        return "#f39c12", "51-75"
    elif 76 <= value <= 100:
        return "#e74c3c", "76-100"
    else:
        return "#95a5a6", "Unknown"


df["color"] = df["value"].apply(lambda x: get_color_and_range(x)[0])
df["range"] = df["value"].apply(lambda x: get_color_and_range(x)[1])
df["size"] = df["value"].apply(lambda x: max(8, x * 0.3 + 15))

# ÂÆöÁæ©Ê®ôÁ±§È†ÅÊ®£Âºè
tab_style = {
    "borderBottom": "1px solid #d6d6d6",
    "padding": "12px 24px",
    "fontWeight": "bold",
    "backgroundColor": "#f8f9fa",
    "color": "#495057",
    "fontSize": "14px",
    "cursor": "pointer",
    "border": "none",
    "borderRadius": "8px 8px 0 0",
    "margin": "0 2px",
}

tab_selected_style = {
    "borderTop": "3px solid #007bff",
    "borderBottom": "1px solid #fff",
    "backgroundColor": "#ffffff",
    "color": "#007bff",
    "padding": "12px 24px",
    "fontWeight": "bold",
    "fontSize": "14px",
    "borderRadius": "8px 8px 0 0",
    "margin": "0 2px",
}

# ÊáâÁî®Á®ãÂºè‰ΩàÂ±Ä
app.layout = html.Div(
    [
        # È†ÇÈÉ®Ê®ôÈ°åÂçÄÂüü
        html.Div(
            [
                html.H1(
                    "üß¨ Âú∞ÁêÜÊï∏ÊìöÂàÜÊûêÁ≥ªÁµ±",
                    style={
                        "textAlign": "center",
                        "marginBottom": "10px",
                        "color": "#2c3e50",
                        "fontFamily": "Arial, sans-serif",
                        "fontSize": "28px",
                    },
                ),
                html.P(
                    "üìä Geographical Data Analysis Platform",
                    style={
                        "textAlign": "center",
                        "fontSize": "16px",
                        "color": "#7f8c8d",
                        "marginBottom": "30px",
                        "fontStyle": "italic",
                    },
                ),
            ],
            style={
                "backgroundColor": "#ecf0f1",
                "padding": "30px 20px",
                "borderRadius": "0 0 15px 15px",
                "marginBottom": "20px",
                "boxShadow": "0 2px 10px rgba(0,0,0,0.1)",
            },
        ),
        # Ê®ôÁ±§È†ÅÂ∞éËà™
        html.Div(
            [
                dcc.Tabs(
                    id="main-tabs",
                    value="map",
                    children=[
                        dcc.Tab(
                            label="üìã Query",
                            value="query",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                        dcc.Tab(
                            label="üîç Search",
                            value="search",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                        dcc.Tab(
                            label="üî• Heatmap",
                            value="heatmap",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                        dcc.Tab(
                            label="üå°Ô∏è ComplexHeatmap",
                            value="complex-heatmap",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                        dcc.Tab(
                            label="üó∫Ô∏è Map",
                            value="map",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                        dcc.Tab(
                            label="üß¨ cgMLST",
                            value="cgmlst",
                            style=tab_style,
                            selected_style=tab_selected_style,
                        ),
                    ],
                    style={"marginBottom": "20px"},
                )
            ],
            style={
                "margin": "0 20px",
                "backgroundColor": "#ffffff",
                "borderRadius": "10px",
                "padding": "10px",
                "boxShadow": "0 2px 8px rgba(0,0,0,0.1)",
            },
        ),
        # Ê®ôÁ±§È†ÅÂÖßÂÆπ
        html.Div(id="tab-content", style={"margin": "20px"}),
    ]
)


# Ê®ôÁ±§È†ÅÂÖßÂÆπÂõûË™ø
@app.callback(Output("tab-content", "children"), [Input("main-tabs", "value")])
def render_content(tab):
    if tab == "query":
        return html.Div(
            [
                html.H3(
                    "üìã Query Analysis",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                html.Div(
                    [
                        html.Div(
                            [
                                html.H4("üî¢ Êï∏ÊìöÊü•Ë©¢Â∑•ÂÖ∑", style={"color": "#34495e"}),
                                html.P(
                                    "ÈÄôË£°ÂèØ‰ª•ÈÄ≤Ë°åË§áÈõúÁöÑÊï∏ÊìöÊü•Ë©¢ÂíåÁØ©ÈÅ∏Êìç‰Ωú„ÄÇ",
                                    style={"color": "#7f8c8d"},
                                ),
                                html.Div(
                                    [
                                        html.Label(
                                            "ÈÅ∏ÊìáÊü•Ë©¢È°ûÂûã:",
                                            style={
                                                "fontWeight": "bold",
                                                "marginBottom": "10px",
                                            },
                                        ),
                                        dcc.Dropdown(
                                            options=[
                                                {"label": "SQL Query", "value": "sql"},
                                                {
                                                    "label": "NoSQL Query",
                                                    "value": "nosql",
                                                },
                                                {
                                                    "label": "GraphQL",
                                                    "value": "graphql",
                                                },
                                            ],
                                            value="sql",
                                            style={"marginBottom": "20px"},
                                        ),
                                        html.Textarea(
                                            placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÊü•Ë©¢Ë™ûÂè•...",
                                            style={
                                                "width": "100%",
                                                "height": "120px",
                                                "padding": "10px",
                                                "fontSize": "14px",
                                            },
                                        ),
                                    ],
                                    style={
                                        "backgroundColor": "#f8f9fa",
                                        "padding": "20px",
                                        "borderRadius": "10px",
                                    },
                                ),
                            ],
                            style={"width": "100%"},
                        )
                    ]
                ),
            ],
            style={"padding": "20px"},
        )

    elif tab == "search":
        return html.Div(
            [
                html.H3(
                    "üîç Advanced Search",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                html.Div(
                    [
                        html.H4("üéØ Êô∫ËÉΩÊêúÁ¥¢ÂºïÊìé", style={"color": "#34495e"}),
                        html.P(
                            "‰ΩøÁî®ÂÖàÈÄ≤ÁöÑÊêúÁ¥¢ÁÆóÊ≥ïÂø´ÈÄüÊâæÂà∞Áõ∏ÈóúÊï∏Êìö„ÄÇ",
                            style={"color": "#7f8c8d"},
                        ),
                        html.Div(
                            [
                                dcc.Input(
                                    placeholder="Ëº∏ÂÖ•ÊêúÁ¥¢ÈóúÈçµË©û...",
                                    style={
                                        "width": "70%",
                                        "padding": "12px",
                                        "fontSize": "16px",
                                        "marginRight": "10px",
                                    },
                                ),
                                html.Button(
                                    "üîç ÊêúÁ¥¢",
                                    style={
                                        "padding": "12px 24px",
                                        "backgroundColor": "#3498db",
                                        "color": "white",
                                        "border": "none",
                                        "borderRadius": "5px",
                                        "cursor": "pointer",
                                    },
                                ),
                            ],
                            style={"marginBottom": "20px"},
                        ),
                        html.Div(
                            [
                                html.P(
                                    "ÊêúÁ¥¢ÁµêÊûúÂ∞áÈ°ØÁ§∫Âú®ÈÄôË£°...",
                                    style={"color": "#95a5a6", "fontStyle": "italic"},
                                )
                            ],
                            style={
                                "backgroundColor": "#f8f9fa",
                                "padding": "20px",
                                "borderRadius": "10px",
                                "minHeight": "200px",
                            },
                        ),
                    ]
                ),
            ],
            style={"padding": "20px"},
        )

    elif tab == "heatmap":
        return html.Div(
            [
                html.H3(
                    "üî• Heatmap Visualization",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                html.Div(
                    [
                        html.H4("üå°Ô∏è ÁÜ±ÂäõÂúñÂàÜÊûê", style={"color": "#34495e"}),
                        html.P(
                            "ÁîüÊàêÊï∏ÊìöÁöÑÁÜ±ÂäõÂúñË¶ñË¶∫ÂåñÔºåË≠òÂà•Ê®°ÂºèÂíåË∂®Âã¢„ÄÇ",
                            style={"color": "#7f8c8d"},
                        ),
                        html.Div(
                            [
                                html.P(
                                    "ÁÜ±ÂäõÂúñÂ∞áÂú®ÈÄôË£°È°ØÁ§∫...",
                                    style={
                                        "textAlign": "center",
                                        "color": "#95a5a6",
                                        "fontSize": "18px",
                                        "marginTop": "80px",
                                    },
                                )
                            ],
                            style={
                                "backgroundColor": "#f8f9fa",
                                "padding": "40px",
                                "borderRadius": "10px",
                                "minHeight": "400px",
                                "border": "2px dashed #bdc3c7",
                            },
                        ),
                    ]
                ),
            ],
            style={"padding": "20px"},
        )

    elif tab == "complex-heatmap":
        return html.Div(
            [
                html.H3(
                    "üå°Ô∏è Complex Heatmap Analysis",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                html.Div(
                    [
                        html.H4("üî¨ Ë§áÈõúÁÜ±ÂäõÂúñ", style={"color": "#34495e"}),
                        html.P(
                            "Â§öÁ∂≠Â∫¶Êï∏ÊìöÁöÑË§áÈõúÁÜ±ÂäõÂúñÂàÜÊûêÔºåÊîØÊåÅËÅöÈ°ûÂíåË®ªÈáã„ÄÇ",
                            style={"color": "#7f8c8d"},
                        ),
                        html.Div(
                            [
                                html.P(
                                    "Ë§áÈõúÁÜ±ÂäõÂúñÂ∞áÂú®ÈÄôË£°È°ØÁ§∫...",
                                    style={
                                        "textAlign": "center",
                                        "color": "#95a5a6",
                                        "fontSize": "18px",
                                        "marginTop": "80px",
                                    },
                                )
                            ],
                            style={
                                "backgroundColor": "#f8f9fa",
                                "padding": "40px",
                                "borderRadius": "10px",
                                "minHeight": "400px",
                                "border": "2px dashed #bdc3c7",
                            },
                        ),
                    ]
                ),
            ],
            style={"padding": "20px"},
        )

    elif tab == "map":
        return html.Div(
            [
                html.H3(
                    "üó∫Ô∏è Geographical Distribution",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                # Âú∞ÂúñÊéßÂà∂Èù¢Êùø
                html.Div(
                    [
                        html.Div(
                            [
                                html.Label(
                                    "üó∫Ô∏è ÈÅ∏ÊìáÂú∞ÂúñÊ®£Âºè:",
                                    style={
                                        "fontWeight": "bold",
                                        "marginBottom": "15px",
                                        "color": "#2c3e50",
                                        "fontSize": "16px",
                                    },
                                ),
                                dcc.RadioItems(
                                    id="map-style-tabs",
                                    options=[
                                        {
                                            "label": " üó∫Ô∏è OpenStreetMapÔºàÊ®ôÊ∫ñÂú∞ÂúñÔºâ",
                                            "value": "open-street-map",
                                        },
                                        {
                                            "label": " üå´Ô∏è CartoDB PositronÔºàÁ∞°Á¥ÑÈ¢®Ê†ºÔºâ",
                                            "value": "carto-positron",
                                        },
                                        {
                                            "label": " üåô CartoDB Dark MatterÔºàÊ∑±Ëâ≤‰∏ªÈ°åÔºâ",
                                            "value": "carto-darkmatter",
                                        },
                                        {
                                            "label": " üöÄ Âü∫Á§éË°õÊòüÂúñÔºàPlotly ÂÖßÂª∫Ôºâ",
                                            "value": "basic",
                                        },
                                        {
                                            "label": " üõ∞Ô∏è Mapbox Ë°õÊòüÂúñÔºàÈúÄË¶Å TokenÔºâ",
                                            "value": "satellite",
                                        },
                                        {
                                            "label": " üõ∞Ô∏è Mapbox Ë°õÊòüË°óÈÅìÔºàÈúÄË¶Å TokenÔºâ",
                                            "value": "satellite-streets",
                                        },
                                    ],
                                    value="open-street-map",
                                    style={"marginBottom": "20px", "fontSize": "14px"},
                                    labelStyle={
                                        "display": "block",
                                        "marginBottom": "8px",
                                        "cursor": "pointer",
                                        "padding": "6px",
                                    },
                                ),
                                html.Div(
                                    id="map-status-tabs",
                                    style={
                                        "color": "#27ae60",
                                        "fontSize": "12px",
                                        "fontStyle": "italic",
                                    },
                                ),
                            ],
                            style={
                                "width": "58%",
                                "display": "inline-block",
                                "marginRight": "4%",
                            },
                        ),
                        html.Div(
                            [
                                html.Label(
                                    "üéØ Êï∏ÂÄºÁØÑÂúçÁØ©ÈÅ∏:",
                                    style={
                                        "fontWeight": "bold",
                                        "marginBottom": "10px",
                                        "color": "#2c3e50",
                                        "fontSize": "16px",
                                    },
                                ),
                                dcc.Dropdown(
                                    id="range-filter-tabs",
                                    options=[
                                        {"label": "üåç È°ØÁ§∫ÂÖ®ÈÉ®ÁØÑÂúç", "value": "all"},
                                        {"label": "üîµ 0-25 (‰ΩéÊï∏ÂÄº)", "value": "0-25"},
                                        {
                                            "label": "üü¢ 26-50 (‰∏≠‰ΩéÊï∏ÂÄº)",
                                            "value": "26-50",
                                        },
                                        {
                                            "label": "üü† 51-75 (‰∏≠È´òÊï∏ÂÄº)",
                                            "value": "51-75",
                                        },
                                        {
                                            "label": "üî¥ 76-100 (È´òÊï∏ÂÄº)",
                                            "value": "76-100",
                                        },
                                    ],
                                    value="all",
                                    style={"marginBottom": "20px"},
                                ),
                                html.Label(
                                    "üîë Mapbox Access Token (ÂèØÈÅ∏):",
                                    style={
                                        "fontWeight": "bold",
                                        "marginBottom": "10px",
                                        "color": "#2c3e50",
                                        "fontSize": "14px",
                                    },
                                ),
                                dcc.Input(
                                    id="mapbox-token-tabs",
                                    type="text",
                                    placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑ Mapbox Token...",
                                    style={
                                        "width": "100%",
                                        "padding": "8px",
                                        "marginBottom": "10px",
                                        "fontSize": "12px",
                                    },
                                    value="",
                                ),
                                html.P(
                                    [
                                        "üí° ÂÖçË≤ªÁç≤Âèñ Token: ",
                                        html.A(
                                            "Mapbox ÂÆòÁ∂≤",
                                            href="https://www.mapbox.com/",
                                            target="_blank",
                                            style={"color": "#3498db"},
                                        ),
                                    ],
                                    style={
                                        "fontSize": "11px",
                                        "color": "#95a5a6",
                                        "margin": "0",
                                    },
                                ),
                            ],
                            style={"width": "38%", "display": "inline-block"},
                        ),
                    ],
                    style={
                        "backgroundColor": "#ffffff",
                        "padding": "25px",
                        "borderRadius": "10px",
                        "marginBottom": "20px",
                        "boxShadow": "0 4px 8px rgba(0,0,0,0.1)",
                        "border": "1px solid #ddd",
                    },
                ),
                # Âú∞ÂúñË≥áË®äÂíåÁµ±Ë®à
                html.Div(
                    [
                        html.Div(id="map-info-tabs", style={"marginBottom": "20px"}),
                        html.Div(id="stats-info-tabs"),
                    ]
                ),
                # Âú∞Âúñ
                html.Div(
                    [dcc.Graph(id="main-map-tabs", style={"height": "700px"})],
                    style={
                        "backgroundColor": "#ffffff",
                        "padding": "20px",
                        "borderRadius": "10px",
                        "boxShadow": "0 4px 8px rgba(0,0,0,0.1)",
                    },
                ),
            ],
            style={"padding": "0 20px"},
        )

    elif tab == "cgmlst":
        return html.Div(
            [
                html.H3(
                    "üß¨ cgMLST Analysis",
                    style={"color": "#2c3e50", "marginBottom": "20px"},
                ),
                html.Div(
                    [
                        html.H4(
                            "üî¨ Ê†∏ÂøÉÂü∫Âõ†ÁµÑÂ§ö‰ΩçÈªûÂ∫èÂàóÂàÜÂûã", style={"color": "#34495e"}
                        ),
                        html.P(
                            "Core Genome Multi-Locus Sequence Typing ÂàÜÊûêÂ∑•ÂÖ∑„ÄÇ",
                            style={"color": "#7f8c8d"},
                        ),
                        html.Div(
                            [
                                html.P(
                                    "cgMLST ÂàÜÊûêÁµêÊûúÂ∞áÂú®ÈÄôË£°È°ØÁ§∫...",
                                    style={
                                        "textAlign": "center",
                                        "color": "#95a5a6",
                                        "fontSize": "18px",
                                        "marginTop": "80px",
                                    },
                                )
                            ],
                            style={
                                "backgroundColor": "#f8f9fa",
                                "padding": "40px",
                                "borderRadius": "10px",
                                "minHeight": "400px",
                                "border": "2px dashed #bdc3c7",
                            },
                        ),
                    ]
                ),
            ],
            style={"padding": "20px"},
        )


# Âú∞ÂúñÁõ∏ÈóúÁöÑÂõûË™øÂáΩÊï∏ÔºàÂè™Âú® Map Ê®ôÁ±§È†Å‰∏≠‰ΩøÁî®Ôºâ
@app.callback(
    Output("map-status-tabs", "children"),
    [
        Input("map-style-tabs", "value"),
        Input("mapbox-token-tabs", "value"),
        Input("main-tabs", "value"),
    ],
)
def update_map_status_tabs(map_style, token, active_tab):
    # Âè™Âú®Âú∞ÂúñÊ®ôÁ±§ÊôÇËôïÁêÜ
    if active_tab != "map":
        raise dash.exceptions.PreventUpdate
    if map_style in ["satellite", "satellite-streets"]:
        if token and len(token) > 20:
            return "‚úÖ Mapbox Ë°õÊòüÂúñÂ∑≤ÈÖçÁΩÆ"
        else:
            return "‚ö†Ô∏è ÈúÄË¶Å Mapbox Token ÊâçËÉΩ‰ΩøÁî®Ë°õÊòüÂúñ"

    status_map = {
        "open-street-map": "‚úÖ OpenStreetMap Â∑≤ËºâÂÖ• - ÂÖ®‰∏ñÁïåÊúÄË©≥Á¥∞ÁöÑÂÖçË≤ªÂú∞Âúñ",
        "carto-positron": "‚úÖ CartoDB Á∞°Á¥ÑÂú∞ÂúñÂ∑≤ËºâÂÖ• - Ê∏ÖÊΩîÁöÑÁôΩËâ≤È¢®Ê†º",
        "carto-darkmatter": "‚úÖ CartoDB Ê∑±Ëâ≤Âú∞ÂúñÂ∑≤ËºâÂÖ• - Áèæ‰ª£ÂåñÈªëËâ≤‰∏ªÈ°å",
        "basic": "‚úÖ Plotly Âü∫Á§éÂú∞ÂúñÂ∑≤ËºâÂÖ• - ÂÖßÂª∫Âú∞ÂúñÊ®£Âºè",
    }
    return status_map.get(map_style, "‚úÖ Âú∞ÂúñÂ∑≤ËºâÂÖ•")


@app.callback(
    Output("map-info-tabs", "children"),
    [
        Input("map-style-tabs", "value"),
        Input("range-filter-tabs", "value"),
        Input("mapbox-token-tabs", "value"),
        Input("main-tabs", "value"),
    ],
)
def show_map_info_tabs(map_style, range_filter, token, active_tab):
    # Âè™Âú®Âú∞ÂúñÊ®ôÁ±§ÊôÇËôïÁêÜ
    if active_tab != "map":
        raise dash.exceptions.PreventUpdate
    map_descriptions = {
        "open-street-map": {
            "name": "üó∫Ô∏è OpenStreetMap",
            "desc": "ÂÖ®‰∏ñÁïåÂçî‰ΩúË£Ω‰ΩúÁöÑË©≥Á¥∞Âú∞ÂúñÔºåÂåÖÂê´ÈÅìË∑Ø„ÄÅÂª∫ÁØâ„ÄÅÂú∞Ê®ôÁ≠âË±êÂØåË≥áË®ä",
            "color": "#3498db",
            "quality": "È´òÂìÅË≥™ (ÂÖçË≤ª)",
        },
        "carto-positron": {
            "name": "üå´Ô∏è CartoDB Positron",
            "desc": "Á∞°ÊΩîÁöÑÁôΩËâ≤È¢®Ê†ºÂú∞ÂúñÔºåÈÅ©ÂêàÊï∏ÊìöË¶ñË¶∫ÂåñÂíåÂàÜÊûê",
            "color": "#95a5a6",
            "quality": "ÂÑ™Ë≥™ (ÂÖçË≤ª)",
        },
        "carto-darkmatter": {
            "name": "üåô CartoDB Dark Matter",
            "desc": "Áèæ‰ª£ÂåñÊ∑±Ëâ≤‰∏ªÈ°åÂú∞ÂúñÔºåÈÅ©ÂêàÂ§úÈñì‰ΩøÁî®ÂíåÂ∞àÊ•≠Â±ïÁ§∫",
            "color": "#34495e",
            "quality": "ÂÑ™Ë≥™ (ÂÖçË≤ª)",
        },
        "basic": {
            "name": "üöÄ Plotly Âü∫Á§éÂú∞Âúñ",
            "desc": "Plotly ÂÖßÂª∫ÁöÑÂü∫Á§éÂú∞ÂúñÊ®£ÂºèÔºåÁ∞°ÂñÆÂèØÈù†",
            "color": "#2ecc71",
            "quality": "Ê®ôÊ∫ñ (ÂÖçË≤ª)",
        },
        "satellite": {
            "name": "üõ∞Ô∏è Mapbox Ë°õÊòüÂúñ",
            "desc": "ÁúüÊ≠£ÁöÑÈ´òËß£ÊûêÂ∫¶Ë°õÊòüÂΩ±ÂÉèÔºåÂ±ïÁ§∫Âú∞ÁêÉÁúüÂØ¶Èù¢Ë≤å",
            "color": "#e74c3c",
            "quality": "ÊúÄÈ´òÂìÅË≥™ (ÈúÄË¶Å Token)",
        },
        "satellite-streets": {
            "name": "üõ∞Ô∏è Mapbox Ë°õÊòüË°óÈÅìÂúñ",
            "desc": "È´òËß£ÊûêÂ∫¶Ë°õÊòüÂΩ±ÂÉèÁµêÂêàË©≥Á¥∞ÁöÑË°óÈÅìÊ®ôÁ±§",
            "color": "#c0392b",
            "quality": "ÊúÄÈ´òÂìÅË≥™ (ÈúÄË¶Å Token)",
        },
    }

    map_info = map_descriptions.get(map_style, map_descriptions["open-street-map"])

    needs_token = map_style in ["satellite", "satellite-streets"]
    has_token = token and len(token) > 20

    status_color = map_info["color"]
    if needs_token and not has_token:
        status_color = "#e67e22"

    return html.Div(
        [
            html.H4(
                "üó∫Ô∏è Áï∂ÂâçÂú∞ÂúñË≥áË®ä", style={"marginBottom": "15px", "color": "#2c3e50"}
            ),
            html.Div(
                [
                    html.Div(
                        [
                            html.H5(
                                map_info["name"],
                                style={"margin": "0", "color": status_color},
                            ),
                            html.P(
                                map_info["desc"],
                                style={
                                    "margin": "5px 0",
                                    "color": "#7f8c8d",
                                    "fontSize": "14px",
                                },
                            ),
                            html.Div(
                                [
                                    html.Span(
                                        f"ÂìÅË≥™Á≠âÁ¥ö: {map_info['quality']}",
                                        style={
                                            "fontSize": "12px",
                                            "color": "#34495e",
                                            "marginRight": "15px",
                                        },
                                    ),
                                    html.Span(
                                        f"ÁØ©ÈÅ∏ÁØÑÂúç: {range_filter}",
                                        style={"fontSize": "12px", "color": "#34495e"},
                                    ),
                                ],
                                style={"marginTop": "8px"},
                            ),
                            (
                                html.Div(
                                    [
                                        (
                                            html.P(
                                                [
                                                    "üîë Token ÁãÄÊÖã: ",
                                                    html.Span(
                                                        (
                                                            "‚úÖ Â∑≤ÈÖçÁΩÆ"
                                                            if has_token
                                                            else (
                                                                "‚ö†Ô∏è ÈúÄË¶ÅÈÖçÁΩÆ"
                                                                if needs_token
                                                                else "‚úÖ ‰∏çÈúÄË¶Å"
                                                            )
                                                        ),
                                                        style={
                                                            "color": (
                                                                "#27ae60"
                                                                if (
                                                                    has_token
                                                                    or not needs_token
                                                                )
                                                                else "#e74c3c"
                                                            ),
                                                            "fontWeight": "bold",
                                                        },
                                                    ),
                                                ],
                                                style={
                                                    "margin": "5px 0",
                                                    "fontSize": "12px",
                                                },
                                            )
                                            if needs_token
                                            else None
                                        )
                                    ]
                                )
                                if needs_token
                                else None
                            ),
                        ],
                        style={
                            "padding": "15px",
                            "backgroundColor": "#f8f9fa",
                            "borderRadius": "8px",
                            "border": f"2px solid {status_color}",
                        },
                    )
                ]
            ),
        ]
    )


@app.callback(
    Output("stats-info-tabs", "children"),
    [Input("range-filter-tabs", "value"), Input("main-tabs", "value")],
)
def update_stats_tabs(range_filter, active_tab):
    # Âè™Âú®Âú∞ÂúñÊ®ôÁ±§ÊôÇËôïÁêÜ
    if active_tab != "map":
        raise dash.exceptions.PreventUpdate
    if range_filter == "all":
        filtered_df = df
        title = "ÂÖ®ÈÉ®Âú∞Èªû"
    else:
        filtered_df = df[df["range"] == range_filter]
        title = f"ÁØÑÂúç {range_filter} ÁöÑÂú∞Èªû"

    total_locations = len(filtered_df)
    avg_value = filtered_df["value"].mean() if len(filtered_df) > 0 else 0
    max_value = filtered_df["value"].max() if len(filtered_df) > 0 else 0
    min_value = filtered_df["value"].min() if len(filtered_df) > 0 else 0

    stats_cards = [
        html.Div(
            [
                html.H4("üìç", style={"margin": "0", "fontSize": "24px"}),
                html.H3(
                    f"{total_locations}", style={"margin": "5px 0", "color": "#3498db"}
                ),
                html.P(
                    "Á∏ΩÂú∞ÈªûÊï∏",
                    style={"margin": "0", "fontSize": "12px", "color": "#7f8c8d"},
                ),
            ],
            style={
                "backgroundColor": "#ffffff",
                "padding": "20px",
                "borderRadius": "10px",
                "textAlign": "center",
                "boxShadow": "0 2px 6px rgba(52, 152, 219, 0.2)",
                "border": "2px solid #3498db",
                "minWidth": "120px",
            },
        ),
        html.Div(
            [
                html.H4("üìä", style={"margin": "0", "fontSize": "24px"}),
                html.H3(
                    f"{avg_value:.1f}", style={"margin": "5px 0", "color": "#2ecc71"}
                ),
                html.P(
                    "Âπ≥ÂùáÊï∏ÂÄº",
                    style={"margin": "0", "fontSize": "12px", "color": "#7f8c8d"},
                ),
            ],
            style={
                "backgroundColor": "#ffffff",
                "padding": "20px",
                "borderRadius": "10px",
                "textAlign": "center",
                "boxShadow": "0 2px 6px rgba(46, 204, 113, 0.2)",
                "border": "2px solid #2ecc71",
                "minWidth": "120px",
            },
        ),
        html.Div(
            [
                html.H4("üî∫", style={"margin": "0", "fontSize": "24px"}),
                html.H3(f"{max_value}", style={"margin": "5px 0", "color": "#e74c3c"}),
                html.P(
                    "ÊúÄÈ´òÊï∏ÂÄº",
                    style={"margin": "0", "fontSize": "12px", "color": "#7f8c8d"},
                ),
            ],
            style={
                "backgroundColor": "#ffffff",
                "padding": "20px",
                "borderRadius": "10px",
                "textAlign": "center",
                "boxShadow": "0 2px 6px rgba(231, 76, 60, 0.2)",
                "border": "2px solid #e74c3c",
                "minWidth": "120px",
            },
        ),
        html.Div(
            [
                html.H4("üîª", style={"margin": "0", "fontSize": "24px"}),
                html.H3(f"{min_value}", style={"margin": "5px 0", "color": "#f39c12"}),
                html.P(
                    "ÊúÄ‰ΩéÊï∏ÂÄº",
                    style={"margin": "0", "fontSize": "12px", "color": "#7f8c8d"},
                ),
            ],
            style={
                "backgroundColor": "#ffffff",
                "padding": "20px",
                "borderRadius": "10px",
                "textAlign": "center",
                "boxShadow": "0 2px 6px rgba(243, 156, 18, 0.2)",
                "border": "2px solid #f39c12",
                "minWidth": "120px",
            },
        ),
    ]

    return html.Div(
        [
            html.H4(
                f"üìà {title} Áµ±Ë®àË≥áË®ä",
                style={"marginBottom": "20px", "color": "#2c3e50"},
            ),
            html.Div(
                stats_cards,
                style={
                    "display": "flex",
                    "justifyContent": "space-around",
                    "flexWrap": "wrap",
                    "gap": "15px",
                },
            ),
        ]
    )


@app.callback(
    Output("main-map-tabs", "figure"),
    [
        Input("map-style-tabs", "value"),
        Input("range-filter-tabs", "value"),
        Input("mapbox-token-tabs", "value"),
        Input("main-tabs", "value"),
    ],
)
def update_main_map_tabs(map_style, range_filter, token, active_tab):
    # Âè™Âú®Âú∞ÂúñÊ®ôÁ±§ÊôÇËôïÁêÜ
    if active_tab != "map":
        raise dash.exceptions.PreventUpdate
    # ÁØ©ÈÅ∏Ë≥áÊñô
    if range_filter == "all":
        filtered_df = df
        title = f"üó∫Ô∏è ÂÖ®ÁêÉÂú∞ÁêÜÂàÜÂ∏ÉÂúñ"
    else:
        filtered_df = df[df["range"] == range_filter]
        title = f"üéØ ÁØÑÂúç {range_filter} ÂàÜÂ∏ÉÂúñ"

    map_names = {
        "open-street-map": "OpenStreetMap",
        "carto-positron": "CartoDB Á∞°Á¥Ñ",
        "carto-darkmatter": "CartoDB Ê∑±Ëâ≤",
        "basic": "Plotly Âü∫Á§é",
        "satellite": "Mapbox Ë°õÊòü",
        "satellite-streets": "Mapbox Ë°õÊòüË°óÈÅì",
    }

    title += f" ({map_names.get(map_style, 'Âú∞Âúñ')})"

    # Âª∫Á´ãÊï£ÈªûÂú∞Âúñ
    fig = go.Figure()

    ranges = ["0-25", "26-50", "51-75", "76-100"]
    colors = ["#3498db", "#2ecc71", "#f39c12", "#e74c3c"]

    for i, range_val in enumerate(ranges):
        range_data = filtered_df[filtered_df["range"] == range_val]

        if len(range_data) > 0:
            fig.add_trace(
                go.Scattermapbox(
                    lat=range_data["latitude"],
                    lon=range_data["longitude"],
                    mode="markers+text",
                    marker=dict(
                        size=range_data["size"],
                        color=colors[i],
                        opacity=0.9,
                        sizemode="diameter",
                    ),
                    text=range_data["value"],
                    textposition="middle center",
                    textfont=dict(size=11, color="white", family="Arial Black"),
                    name=f"üîò {range_val}",
                    hovertemplate="<b>üèôÔ∏è %{customdata[0]}</b><br>"
                    + "üìä Êï∏ÂÄº: %{customdata[1]}<br>"
                    + "üéØ ÁØÑÂúç: %{customdata[2]}<br>"
                    + "üåê Á∑ØÂ∫¶: %{lat:.3f}<br>"
                    + "üåê Á∂ìÂ∫¶: %{lon:.3f}"
                    + "<extra></extra>",
                    customdata=range_data[["city", "value", "range"]].values,
                )
            )

    # ÈÖçÁΩÆ Mapbox Ë®≠ÂÆö
    mapbox_config = {"style": map_style, "center": dict(lat=25, lon=10), "zoom": 1.3}

    if map_style in ["satellite", "satellite-streets"] and token and len(token) > 20:
        mapbox_config["accesstoken"] = token
    elif map_style in ["satellite", "satellite-streets"] and (
        not token or len(token) <= 20
    ):
        mapbox_config["style"] = "open-street-map"
        title += " (‚ö†Ô∏è Áº∫Â∞ë TokenÔºåÈ°ØÁ§∫Ê®ôÊ∫ñÂú∞Âúñ)"

    # Êõ¥Êñ∞‰ΩàÂ±Ä
    fig.update_layout(
        mapbox=mapbox_config,
        title={
            "text": title,
            "x": 0.5,
            "xanchor": "center",
            "font": {"size": 20, "family": "Arial, sans-serif", "color": "#2c3e50"},
        },
        font={"family": "Arial, sans-serif"},
        showlegend=True,
        legend=dict(
            x=1.02,
            y=1,
            bgcolor="rgba(255,255,255,0.95)",
            bordercolor="rgba(0,0,0,0.3)",
            borderwidth=2,
            font=dict(size=12),
        ),
        margin=dict(l=0, r=0, t=60, b=0),
        height=650,
    )

    return fig


if __name__ == "__main__":
    import os

    app.run(
        debug=os.getenv("DASH_DEBUG", "True").lower() == "true",
        host=os.getenv("DASH_HOST", "0.0.0.0"),
        port=int(os.getenv("DASH_PORT", 8056)),
    )
