<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ å¯¦æ™‚çµ±è¨ˆå¢å¼·ç‰ˆ Mapbox åœ°åœ–</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
        }

        .panel {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .panel h3 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stats-panel {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #28a745;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-item:hover {
            background-color: rgba(40, 167, 69, 0.05);
            transform: translateX(2px);
        }

        .stat-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.9rem;
        }

        .stat-value {
            font-weight: 600;
            color: #28a745;
            font-size: 0.95rem;
            background: rgba(40, 167, 69, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            min-width: 80px;
            text-align: right;
            transition: all 0.2s ease;
            font-family: 'Courier New', monospace;
        }

        .stat-value.updating {
            animation: pulse 0.6s ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                background-color: rgba(40, 167, 69, 0.1);
            }

            50% {
                transform: scale(1.02);
                background-color: rgba(40, 167, 69, 0.2);
            }

            100% {
                transform: scale(1);
                background-color: rgba(40, 167, 69, 0.1);
            }
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
            font-size: 0.9rem;
        }

        select,
        button,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .update-frequency {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .update-frequency label {
            font-size: 0.8rem;
            color: #28a745;
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-active {
            background: #28a745;
            animation: blink 1.5s infinite;
        }

        .status-inactive {
            background: #dc3545;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .performance-stats {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f1f3f4;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- æ¨™é¡Œ -->
        <div class="header">
            <h1>ğŸŒ å¯¦æ™‚çµ±è¨ˆå¢å¼·ç‰ˆ Mapbox åœ°åœ–ç³»çµ±</h1>
            <p>å³æ™‚æ›´æ–°åœ°åœ–çµ±è¨ˆè³‡è¨Š - æ”¯æ´é«˜é »ç‡å¯¦æ™‚ç›£æ§</p>
        </div>

        <div class="main-content">
            <!-- å´é‚Šæ¬„ -->
            <div class="sidebar">
                <!-- å³æ™‚çµ±è¨ˆé¢æ¿ -->
                <div class="panel stats-panel">
                    <h3>ğŸ“ˆ å¯¦æ™‚åœ°åœ–çµ±è¨ˆ</h3>

                    <div class="stat-item">
                        <span class="stat-label">
                            <span class="status-indicator status-active" id="statusIndicator"></span>
                            æ›´æ–°ç‹€æ…‹
                        </span>
                        <span class="stat-value" id="updateStatus">é‹è¡Œä¸­</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">ç•¶å‰ç¸®æ”¾ç´šåˆ¥</span>
                        <span class="stat-value" id="currentZoom">è¼‰å…¥ä¸­...</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">ä¸­å¿ƒåº§æ¨™</span>
                        <span class="stat-value" id="centerCoords">è¼‰å…¥ä¸­...</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">è¼‰å…¥çš„æ•¸æ“šé»</span>
                        <span class="stat-value" id="dataPoints">0</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">åœ°åœ–æ¨£å¼</span>
                        <span class="stat-value" id="currentStyle">è¼‰å…¥ä¸­...</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">æ¨™ç±¤èªè¨€</span>
                        <span class="stat-value" id="currentLabelLanguage">ä¸­æ–‡</span>
                    </div>

                    <div class="stat-item">
                        <span class="stat-label">æœ€å¾Œæ›´æ–°æ™‚é–“</span>
                        <span class="stat-value" id="lastUpdateTime">--:--:--</span>
                    </div>

                    <div class="performance-stats">
                        <div>ğŸ“Š æ€§èƒ½æŒ‡æ¨™:</div>
                        <div>æ›´æ–°é »ç‡: <span id="updateFrequency">0</span> æ¬¡/ç§’</div>
                        <div>ç¸½æ›´æ–°æ¬¡æ•¸: <span id="totalUpdates">0</span></div>
                        <div>å¹³å‡éŸ¿æ‡‰æ™‚é–“: <span id="avgResponseTime">0</span>ms</div>
                    </div>
                </div>

                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="panel">
                    <h3>ğŸ›ï¸ åœ°åœ–æ§åˆ¶</h3>

                    <div class="control-group">
                        <label for="mapStyle">åœ°åœ–æ¨£å¼:</label>
                        <select id="mapStyle">
                            <option value="osm">OpenStreetMap</option>
                            <option value="osm-dark">OpenStreetMap æ·±è‰²</option>
                            <option value="carto-positron">CartoDB æ˜äº®ç‰ˆ</option>
                            <option value="carto-darkmatter">CartoDB æ·±è‰²ç‰ˆ</option>
                        </select>
                    </div>

                    <div class="update-frequency">
                        <label for="updateInterval">æ›´æ–°é »ç‡è¨­å®š:</label>
                        <select id="updateInterval">
                            <option value="50">è¶…é«˜é » (50ms)</option>
                            <option value="100" selected>é«˜é » (100ms)</option>
                            <option value="250">ä¸­é » (250ms)</option>
                            <option value="500">æ¨™æº– (500ms)</option>
                            <option value="1000">ä½é » (1ç§’)</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <button onclick="resetToTaiwan()">ğŸ‡¹ğŸ‡¼ å›åˆ°å°ç£</button>
                    </div>

                    <div class="control-group">
                        <button onclick="generateRandomData()">ğŸ² ç”Ÿæˆéš¨æ©Ÿæ•¸æ“š</button>
                    </div>
                </div>
            </div>

            <!-- åœ°åœ–å®¹å™¨ -->
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let map;
        let currentCityGeoJSON = null;
        let updateIntervalId = null;
        let statsUpdateScheduled = false;
        let updateInterval = 100; // é è¨­ 100ms

        // çµ±è¨ˆè¿½è¹¤
        let totalUpdates = 0;
        let lastUpdateTimes = [];
        let lastPerformanceUpdate = Date.now();

        // åœ°åœ–æ¨£å¼é…ç½®
        const MAP_STYLES = {
            'osm': {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors'
                    }
                },
                layers: [{
                    id: 'osm',
                    type: 'raster',
                    source: 'osm'
                }]
            },
            'osm-dark': {
                version: 8,
                sources: {
                    'osm-dark': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'osm-dark',
                    type: 'raster',
                    source: 'osm-dark'
                }]
            },
            'carto-positron': {
                version: 8,
                sources: {
                    'carto-positron': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-positron',
                    type: 'raster',
                    source: 'carto-positron'
                }]
            },
            'carto-darkmatter': {
                version: 8,
                sources: {
                    'carto-darkmatter': {
                        type: 'raster',
                        tiles: ['https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'],
                        tileSize: 256,
                        attribution: 'Â© OpenStreetMap contributors, Â© CartoDB'
                    }
                },
                layers: [{
                    id: 'carto-darkmatter',
                    type: 'raster',
                    source: 'carto-darkmatter'
                }]
            }
        };

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            try {
                map = new mapboxgl.Map({
                    container: 'map',
                    style: MAP_STYLES['osm'],
                    center: [121.5654, 25.0330], // å°åŒ—
                    zoom: 10,
                    pitch: 0,
                    bearing: 0
                });

                map.on('load', () => {
                    console.log('âœ… åœ°åœ–è¼‰å…¥å®Œæˆ');

                    // ç«‹å³é–‹å§‹å¯¦æ™‚çµ±è¨ˆæ›´æ–°
                    startRealtimeStats();

                    // è¼‰å…¥åˆå§‹æ•¸æ“š
                    loadInitialData();

                    // ç¶å®šæ§åˆ¶äº‹ä»¶
                    bindControlEvents();

                    // ç«‹å³æ›´æ–°ä¸€æ¬¡çµ±è¨ˆ
                    updateMapStats();
                });

                map.on('error', (e) => {
                    console.error('âŒ åœ°åœ–è¼‰å…¥éŒ¯èª¤:', e);
                    updateStatus('è¼‰å…¥éŒ¯èª¤', false);
                });

            } catch (error) {
                console.error('âŒ åœ°åœ–åˆå§‹åŒ–å¤±æ•—:', error);
                updateStatus('åˆå§‹åŒ–å¤±æ•—', false);
            }
        }

        // é–‹å§‹å¯¦æ™‚çµ±è¨ˆæ›´æ–°
        function startRealtimeStats() {
            // æ¸…é™¤ç¾æœ‰çš„æ›´æ–°å™¨
            if (updateIntervalId) {
                clearInterval(updateIntervalId);
            }

            // è¨­å®šæ–°çš„æ›´æ–°å™¨
            updateIntervalId = setInterval(() => {
                if (map && !document.hidden) {
                    scheduleStatsUpdate();
                }
            }, updateInterval);

            // ç¶å®šåœ°åœ–äº‹ä»¶ï¼ˆé«˜é »ç‡æ›´æ–°ï¼‰
            const realtimeEvents = ['move', 'zoom', 'rotate', 'pitch'];
            realtimeEvents.forEach(eventName => {
                map.off(eventName, scheduleStatsUpdate);
                map.on(eventName, scheduleStatsUpdate);
            });

            console.log(`ğŸš€ å¯¦æ™‚çµ±è¨ˆå·²å•Ÿå‹•ï¼Œæ›´æ–°é »ç‡: ${updateInterval}ms`);
            updateStatus('é‹è¡Œä¸­', true);
        }

        // å®‰æ’çµ±è¨ˆæ›´æ–°ï¼ˆé˜²æ­¢éæ–¼é »ç¹ï¼‰
        function scheduleStatsUpdate() {
            if (statsUpdateScheduled) return;

            statsUpdateScheduled = true;
            requestAnimationFrame(() => {
                try {
                    updateMapStats();
                } finally {
                    statsUpdateScheduled = false;
                }
            });
        }

        // æ›´æ–°åœ°åœ–çµ±è¨ˆ
        function updateMapStats() {
            if (!map) return;

            const startTime = performance.now();

            try {
                const center = map.getCenter();
                const zoom = map.getZoom();
                const bearing = map.getBearing();
                const pitch = map.getPitch();

                // æ·»åŠ å‹•ç•«æ•ˆæœ
                const elements = ['currentZoom', 'centerCoords', 'dataPoints', 'currentStyle', 'lastUpdateTime'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('updating');
                        setTimeout(() => element.classList.remove('updating'), 200);
                    }
                });

                // æ›´æ–°æ•¸å€¼
                updateElement('currentZoom', `${zoom.toFixed(2)}Â°`);
                updateElement('centerCoords', `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`);
                updateElement('dataPoints', currentCityGeoJSON ? currentCityGeoJSON.features.length : '0');

                // æ›´æ–°æ¨£å¼åç¨±
                const styleSelect = document.getElementById('mapStyle');
                if (styleSelect && styleSelect.selectedIndex >= 0) {
                    const selectedOption = styleSelect.options[styleSelect.selectedIndex];
                    updateElement('currentStyle', selectedOption.text);
                }

                // æ›´æ–°æ™‚é–“
                const now = new Date();
                updateElement('lastUpdateTime', now.toLocaleTimeString('zh-TW', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }));

                // è¨ˆç®—æ€§èƒ½æŒ‡æ¨™
                const endTime = performance.now();
                const responseTime = endTime - startTime;

                totalUpdates++;
                lastUpdateTimes.push(Date.now());

                // ä¿æŒæœ€è¿‘ 10 ç§’çš„æ›´æ–°è¨˜éŒ„
                const tenSecondsAgo = Date.now() - 10000;
                lastUpdateTimes = lastUpdateTimes.filter(time => time > tenSecondsAgo);

                // æ¯ç§’æ›´æ–°ä¸€æ¬¡æ€§èƒ½çµ±è¨ˆ
                if (Date.now() - lastPerformanceUpdate > 1000) {
                    updatePerformanceStats(responseTime);
                    lastPerformanceUpdate = Date.now();
                }

            } catch (error) {
                console.warn('âš ï¸ æ›´æ–°çµ±è¨ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                updateStatus('æ›´æ–°éŒ¯èª¤', false);
            }
        }

        // æ›´æ–°æ€§èƒ½çµ±è¨ˆ
        function updatePerformanceStats(responseTime) {
            const frequency = lastUpdateTimes.length / 10; // æ¯ç§’æ›´æ–°æ¬¡æ•¸
            updateElement('updateFrequency', frequency.toFixed(1));
            updateElement('totalUpdates', totalUpdates);
            updateElement('avgResponseTime', responseTime.toFixed(1));
        }

        // å®‰å…¨æ›´æ–°å…ƒç´ å…§å®¹
        function updateElement(id, content) {
            const element = document.getElementById(id);
            if (element && element.textContent !== content) {
                element.textContent = content;
            }
        }

        // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
        function updateStatus(status, active) {
            updateElement('updateStatus', status);
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = `status-indicator ${active ? 'status-active' : 'status-inactive'}`;
            }
        }

        // ç¶å®šæ§åˆ¶äº‹ä»¶
        function bindControlEvents() {
            // åœ°åœ–æ¨£å¼åˆ‡æ›
            const styleSelect = document.getElementById('mapStyle');
            styleSelect.addEventListener('change', (e) => {
                const style = MAP_STYLES[e.target.value];
                if (style) {
                    map.setStyle(style);
                    console.log(`ğŸ¨ åœ°åœ–æ¨£å¼å·²åˆ‡æ›è‡³: ${e.target.value}`);
                }
            });

            // æ›´æ–°é »ç‡è¨­å®š
            const intervalSelect = document.getElementById('updateInterval');
            intervalSelect.addEventListener('change', (e) => {
                updateInterval = parseInt(e.target.value);
                startRealtimeStats(); // é‡æ–°å•Ÿå‹•æ›´æ–°å™¨
                console.log(`âš¡ æ›´æ–°é »ç‡å·²è¨­å®šç‚º: ${updateInterval}ms`);
            });
        }

        // è¼‰å…¥åˆå§‹æ•¸æ“š
        function loadInitialData() {
            // ç”Ÿæˆä¸€äº›ç¤ºä¾‹æ•¸æ“šé»
            generateRandomData();
        }

        // ç”Ÿæˆéš¨æ©Ÿæ•¸æ“š
        function generateRandomData() {
            const cities = [
                { name: 'å°åŒ—', coords: [121.5654, 25.0330] },
                { name: 'å°ä¸­', coords: [120.6736, 24.1477] },
                { name: 'é«˜é›„', coords: [120.3014, 22.6273] },
                { name: 'å°å—', coords: [120.2513, 22.9917] },
                { name: 'æ–°ç«¹', coords: [120.9647, 24.8138] },
                { name: 'åŸºéš†', coords: [121.7081, 25.1276] },
                { name: 'æ¡ƒåœ’', coords: [121.2168, 24.9936] },
                { name: 'å˜‰ç¾©', coords: [120.4473, 23.4801] },
                { name: 'å®œè˜­', coords: [121.7195, 24.7021] },
                { name: 'èŠ±è“®', coords: [121.6015, 23.9927] }
            ];

            const features = cities.map((city, index) => ({
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: city.coords
                },
                properties: {
                    name: city.name,
                    value: Math.floor(Math.random() * 100),
                    size: Math.floor(Math.random() * 15) + 8
                }
            }));

            currentCityGeoJSON = {
                type: 'FeatureCollection',
                features: features
            };

            // æ·»åŠ åˆ°åœ°åœ–
            if (map.getSource('cities')) {
                map.getSource('cities').setData(currentCityGeoJSON);
            } else {
                map.addSource('cities', {
                    type: 'geojson',
                    data: currentCityGeoJSON
                });

                map.addLayer({
                    id: 'cities',
                    type: 'circle',
                    source: 'cities',
                    paint: {
                        'circle-radius': ['get', 'size'],
                        'circle-color': [
                            'interpolate',
                            ['linear'],
                            ['get', 'value'],
                            0, '#3498db',
                            25, '#2ecc71',
                            50, '#f39c12',
                            75, '#e74c3c',
                            100, '#9b59b6'
                        ],
                        'circle-opacity': 0.8,
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#fff'
                    }
                });
            }

            console.log(`ğŸ² å·²ç”Ÿæˆ ${cities.length} å€‹éš¨æ©Ÿæ•¸æ“šé»`);
        }

        // å›åˆ°å°ç£
        function resetToTaiwan() {
            if (map) {
                map.flyTo({
                    center: [121.5654, 25.0330],
                    zoom: 7,
                    duration: 2000
                });
            }
        }

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ–å¯¦æ™‚çµ±è¨ˆåœ°åœ–ç³»çµ±...');
            initializeMap();
        });

        // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æš«åœ/æ¢å¾©æ›´æ–°
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('â¸ï¸ é é¢éš±è—ï¼Œæš«åœæ›´æ–°');
                updateStatus('æš«åœä¸­', false);
            } else {
                console.log('â–¶ï¸ é é¢å¯è¦‹ï¼Œæ¢å¾©æ›´æ–°');
                startRealtimeStats();
            }
        });
    </script>
</body>

</html>