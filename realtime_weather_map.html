<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå¶Ô∏è Âç≥ÊôÇÂ§©Ê∞£Êµ∑Ê¥ãÂú∞ÂúñÁ≥ªÁµ±</title>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.6.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Ê®£Âºè -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-content {
            padding: 20px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }

        .layer-group {
            margin-bottom: 20px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .layer-checkbox {
            margin-right: 10px;
        }

        .layer-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .opacity-slider {
            width: 60px;
            margin-left: 10px;
        }

        .weather-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }

        .weather-station {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2c3e50;
        }

        .weather-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-button {
            background: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .control-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .status-bar {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            backdrop-filter: blur(10px);
        }

        .legend {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            margin-right: 8px;
            border-radius: 3px;
        }

        .api-key-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(52, 152, 219, 0.3);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 250px;
            }

            .map-container {
                height: calc(100vh - 250px);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ÂÅ¥ÈÇäÊ¨Ñ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>üå¶Ô∏è Â§©Ê∞£Êµ∑Ê¥ãÂú∞Âúñ</h1>
                <p>Âç≥ÊôÇÊ∞£Ë±°ËàáÊµ∑Ê¥ãË≥áÊñôË¶ñË¶∫Âåñ</p>
            </div>

            <div class="sidebar-content">
                <!-- API ÈáëÈë∞Ë®≠ÂÆö -->
                <div class="section">
                    <div class="section-title">üîë API Ë®≠ÂÆö</div>
                    <input type="password" id="api-key-input" class="api-key-input"
                        placeholder="Ëº∏ÂÖ• OpenWeather API Key (ÂèØÈÅ∏)">
                    <button class="btn-primary" onclick="updateApiKey()">
                        Ë®≠ÂÆö API Key
                    </button>
                    <small>üí° ‰∏çË®≠ÂÆöÂ∞á‰ΩøÁî®Á§∫ÁØÑË≥áÊñô</small>
                </div>

                <!-- Âú∞ÂúñÊ®£ÂºèÈÅ∏Êìá -->
                <div class="section">
                    <div class="section-title">üé® Âú∞ÂúñÊ®£Âºè</div>
                    <select id="map-style-select" class="api-key-input" onchange="changeMapStyle()">
                        <option value="light">Êòé‰∫ÆÊ®£Âºè</option>
                        <option value="dark">Ê∑±Ëâ≤Ê®£Âºè</option>
                        <option value="satellite">Ë°õÊòüÊ®£Âºè</option>
                        <option value="streets">Ë°óÈÅìÊ®£Âºè</option>
                    </select>
                </div>

                <!-- ÂúñÂ±§ÊéßÂà∂ -->
                <div class="section">
                    <div class="section-title">üó∫Ô∏è ÂúñÂ±§ÊéßÂà∂</div>

                    <!-- Âü∫Êú¨ÂúñÂ±§ -->
                    <div class="layer-group">
                        <h4>üìç Âü∫Êú¨ÂúñÂ±§</h4>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="weather-stations" checked
                                onchange="toggleWeatherStations()">
                            <label class="layer-name" for="weather-stations">Ê∞£Ë±°Á´ô</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="100"
                                onchange="setWeatherStationsOpacity(this.value)">
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="temperature-labels" checked
                                onchange="toggleTemperatureLabels()">
                            <label class="layer-name" for="temperature-labels">Ê∫´Â∫¶Ê®ôÁ±§</label>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="city-labels" checked
                                onchange="toggleCityLabels()">
                            <label class="layer-name" for="city-labels">ÂüéÂ∏ÇÂêçÁ®±</label>
                        </div>
                    </div>

                    <!-- Â§©Ê∞£ÂúñÂ±§ (Ê®°Êì¨) -->
                    <div class="layer-group">
                        <h4>‚òÅÔ∏è Â§©Ê∞£ÂúñÂ±§</h4>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="weather-precipitation">
                            <label class="layer-name" for="weather-precipitation">ÈôçÈõ®Èáè (ÈúÄAPI)</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="70" disabled>
                        </div>
                        <div class="layer-item">
                            <input type="checkbox" class="layer-checkbox" id="weather-clouds">
                            <label class="layer-name" for="weather-clouds">Èõ≤Â±§ (ÈúÄAPI)</label>
                            <input type="range" class="opacity-slider" min="0" max="100" value="60" disabled>
                        </div>
                    </div>
                </div>

                <!-- Âç≥ÊôÇË≥áÊñô -->
                <div class="section">
                    <div class="section-title">üìä Âç≥ÊôÇË≥áÊñô</div>
                    <div id="weather-data">
                        <div class="loading"></div> ËºâÂÖ•‰∏≠...
                    </div>
                </div>

                <!-- Áµ±Ë®àË≥áË®ä -->
                <div class="section">
                    <div class="section-title">üìà Áµ±Ë®àË≥áË®ä</div>
                    <div id="weather-stats">
                        <div class="weather-card">
                            <div style="text-align: center; color: #7f8c8d;">
                                ËºâÂÖ•Áµ±Ë®àË≥áÊñô‰∏≠...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âú∞ÂúñÂÆπÂô® -->
        <div class="map-container">
            <div id="map"></div>

            <!-- Âú∞ÂúñÊéßÂà∂ÊåâÈàï -->
            <div class="map-controls">
                <button class="control-button" onclick="refreshAllData()">
                    üîÑ Êõ¥Êñ∞Ë≥áÊñô
                </button>
                <button class="control-button" onclick="toggleFullscreen()">
                    üì∫ ÂÖ®Ëû¢Âπï
                </button>
                <button class="control-button" onclick="centerOnTaiwan()">
                    üáπüáº ÂõûÂà∞Âè∞ÁÅ£
                </button>
                <button class="control-button" onclick="exportData()">
                    üíæ ÂåØÂá∫Ë≥áÊñô
                </button>
            </div>

            <!-- ÁãÄÊÖãÂàó -->
            <div class="status-bar" id="status">
                ÂàùÂßãÂåñÂú∞Âúñ‰∏≠...
            </div>

            <!-- Âúñ‰æã -->
            <div class="legend" id="legend">
                <div class="legend-title">Ê∫´Â∫¶Âúñ‰æã</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #0000ff;"></div>
                    <span>
                        < 15¬∞C (‰ΩéÊ∫´)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ffff;"></div>
                    <span>15-20¬∞C (Ê∂ºÁàΩ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #00ff00;"></div>
                    <span>20-25¬∞C (ËàíÈÅ©)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffff00;"></div>
                    <span>25-30¬∞C (Ê∫´Êöñ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff8000;"></div>
                    <span>30-35¬∞C (ÁÇéÁÜ±)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff0000;"></div>
                    <span>> 35¬∞C (ÈÖ∑ÁÜ±)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Mapbox Ë®≠ÂÆö
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmVlLWRuYSIsImEiOiJjbWZ5MTlhOTkwZnF3MmxvbjkwN2RtM2Z4In0.yFiY2MNpWqaDINuLaz1e0w';

        // ÂÖ®ÂüüËÆäÊï∏
        let map;
        let currentApiKey = null;
        let weatherStationsData = null;
        let updateInterval = null;
        let currentPopup = null;

        // Âú∞ÂúñÊ®£ÂºèÈÖçÁΩÆ
        const mapStyles = {
            'light': 'mapbox://styles/mapbox/light-v11',
            'dark': 'mapbox://styles/mapbox/dark-v11',
            'satellite': 'mapbox://styles/mapbox/satellite-v9',
            'streets': 'mapbox://styles/mapbox/streets-v12'
        };

        // ÂàùÂßãÂåñÂú∞Âúñ
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: mapStyles.light,
                center: [121.0, 23.8], // Âè∞ÁÅ£‰∏≠ÂøÉ
                zoom: 7,
                pitch: 0,
                bearing: 0
            });

            map.on('load', () => {
                updateStatus('Âú∞ÂúñËºâÂÖ•ÂÆåÊàê');
                loadInitialData();
                setupMapLayers();
                startAutoUpdate();
            });

            // Ê∑ªÂä†Â∞éËà™ÊéßÂà∂
            map.addControl(new mapboxgl.NavigationControl());

            // Ê∑ªÂä†ÊØî‰æãÂ∞∫
            map.addControl(new mapboxgl.ScaleControl());

            // Âú∞ÂúñÈªûÊìä‰∫ã‰ª∂ (ÈóúÈñâÂΩàÁ™ó)
            map.on('click', (e) => {
                if (currentPopup) {
                    currentPopup.remove();
                    currentPopup = null;
                }
            });
        }

        // ËºâÂÖ•ÂàùÂßãË≥áÊñô
        async function loadInitialData() {
            try {
                await loadWeatherStations();
                updateStatus('ÂàùÂßãË≥áÊñôËºâÂÖ•ÂÆåÊàê');
            } catch (error) {
                console.error('ËºâÂÖ•ÂàùÂßãË≥áÊñôÂ§±Êïó:', error);
                updateStatus('ËºâÂÖ•Â§±Êïó: ' + error.message);
            }
        }

        // ËºâÂÖ•Ê∞£Ë±°Á´ôË≥áÊñô
        async function loadWeatherStations() {
            try {
                updateStatus('ËºâÂÖ•Ê∞£Ë±°Á´ôË≥áÊñô...');

                let url = '/api/weather/stations';
                if (currentApiKey) {
                    url += '?api_key=' + encodeURIComponent(currentApiKey);
                }

                const response = await fetch(url);
                const geojsonData = await response.json();

                if (geojsonData.error) {
                    throw new Error(geojsonData.message || geojsonData.error);
                }

                weatherStationsData = geojsonData;

                // Êõ¥Êñ∞ÊàñÊ∑ªÂä†Ë≥áÊñôÊ∫ê
                if (map.getSource('weather-stations')) {
                    map.getSource('weather-stations').setData(geojsonData);
                } else {
                    map.addSource('weather-stations', {
                        'type': 'geojson',
                        'data': geojsonData
                    });
                }

                // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÂ§©Ê∞£Ë≥áÊñô
                updateWeatherSidebar(geojsonData);
                updateWeatherStats(geojsonData);

                updateStatus('Ê∞£Ë±°Á´ôË≥áÊñôÊõ¥Êñ∞ÂÆåÊàê');
            } catch (error) {
                console.error('ËºâÂÖ•Ê∞£Ë±°Á´ôË≥áÊñôÂ§±Êïó:', error);
                updateStatus('ËºâÂÖ•Ê∞£Ë±°Á´ôË≥áÊñôÂ§±Êïó: ' + error.message);
                showError('ËºâÂÖ•Ê∞£Ë±°Á´ôË≥áÊñôÂ§±Êïó: ' + error.message);
            }
        }

        // Ë®≠ÂÆöÂú∞ÂúñÂúñÂ±§
        function setupMapLayers() {
            if (!weatherStationsData) return;

            try {
                // Ê∞£Ë±°Á´ôÈªûÂúñÂ±§
                if (!map.getLayer('weather-points')) {
                    map.addLayer({
                        'id': 'weather-points',
                        'type': 'circle',
                        'source': 'weather-stations',
                        'paint': {
                            'circle-radius': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                6, 8,
                                12, 15
                            ],
                            'circle-color': [
                                'interpolate',
                                ['linear'],
                                ['get', 'temperature'],
                                0, '#0000ff',   // ËóçËâ≤ (Ê•µ‰ΩéÊ∫´)
                                15, '#00ffff',  // ÈùíËâ≤ (‰ΩéÊ∫´)
                                20, '#00ff00',  // Á∂†Ëâ≤ (Ê∂ºÁàΩ)
                                25, '#ffff00',  // ÈªÉËâ≤ (ËàíÈÅ©)
                                30, '#ff8000',  // Ê©ôËâ≤ (Ê∫´Êöñ)
                                35, '#ff0000'   // Á¥ÖËâ≤ (ÁÇéÁÜ±)
                            ],
                            'circle-stroke-width': 2,
                            'circle-stroke-color': '#ffffff',
                            'circle-opacity': 1.0
                        }
                    });
                }

                // Ê∫´Â∫¶Ê®ôÁ±§ÂúñÂ±§
                if (!map.getLayer('weather-labels')) {
                    map.addLayer({
                        'id': 'weather-labels',
                        'type': 'symbol',
                        'source': 'weather-stations',
                        'layout': {
                            'text-field': '{temperature}¬∞C',
                            'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                            'text-size': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                6, 10,
                                12, 14
                            ],
                            'text-offset': [0, -2.5],
                            'text-anchor': 'center'
                        },
                        'paint': {
                            'text-color': '#2c3e50',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });
                }

                // ÂüéÂ∏ÇÂêçÁ®±Ê®ôÁ±§ÂúñÂ±§
                if (!map.getLayer('city-labels')) {
                    map.addLayer({
                        'id': 'city-labels',
                        'type': 'symbol',
                        'source': 'weather-stations',
                        'layout': {
                            'text-field': '{name}',
                            'text-font': ['Open Sans Regular', 'Arial Unicode MS Regular'],
                            'text-size': 12,
                            'text-offset': [0, 2.5],
                            'text-anchor': 'center'
                        },
                        'paint': {
                            'text-color': '#34495e',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 1.5
                        }
                    });
                }

                // Ê∑ªÂä†ÈªûÊìä‰∫ã‰ª∂
                map.on('click', 'weather-points', handleStationClick);

                // Ê∑ªÂä†ÊªëÈº†Êá∏ÂÅúÊïàÊûú
                map.on('mouseenter', 'weather-points', () => {
                    map.getCanvas().style.cursor = 'pointer';
                });

                map.on('mouseleave', 'weather-points', () => {
                    map.getCanvas().style.cursor = '';
                });

            } catch (error) {
                console.error('Ë®≠ÂÆöÂú∞ÂúñÂúñÂ±§Â§±Êïó:', error);
            }
        }

        // ËôïÁêÜÊ∞£Ë±°Á´ôÈªûÊìä‰∫ã‰ª∂
        function handleStationClick(e) {
            // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            e.originalEvent.stopPropagation();

            const properties = e.features[0].properties;

            // ÈóúÈñâÁèæÊúâÂΩàÁ™ó
            if (currentPopup) {
                currentPopup.remove();
            }

            const popupContent = `
                <div style="font-family: Arial; min-width: 250px;">
                    <h3 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
                        üèôÔ∏è ${properties.name}
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px; margin-bottom: 15px;">
                        <div style="background: #ecf0f1; padding: 8px; border-radius: 4px;">
                            <strong>üå°Ô∏è Ê∫´Â∫¶:</strong><br>
                            <span style="font-size: 18px; color: #e74c3c;">${properties.temperature}¬∞C</span>
                        </div>
                        <div style="background: #ecf0f1; padding: 8px; border-radius: 4px;">
                            <strong>üíß ÊøïÂ∫¶:</strong><br>
                            <span style="font-size: 16px; color: #3498db;">${properties.humidity}%</span>
                        </div>
                        <div style="background: #ecf0f1; padding: 8px; border-radius: 4px;">
                            <strong>üìä Ê∞£Â£ì:</strong><br>
                            <span style="font-size: 14px;">${properties.pressure} hPa</span>
                        </div>
                        <div style="background: #ecf0f1; padding: 8px; border-radius: 4px;">
                            <strong>üí® È¢®ÈÄü:</strong><br>
                            <span style="font-size: 14px;">${properties.wind_speed} m/s</span>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        <strong>‚òÅÔ∏è Â§©Ê∞£ÁãÄÊ≥Å:</strong><br>
                        <span style="color: #27ae60;">${properties.weather_description}</span>
                    </div>
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #bdc3c7;">
                    <small style="color: #7f8c8d;">
                        üìÖ Êõ¥Êñ∞ÊôÇÈñì: ${new Date(properties.timestamp).toLocaleString('zh-TW')}
                    </small>
                </div>
            `;

            currentPopup = new mapboxgl.Popup({
                closeOnClick: false,
                anchor: 'bottom',
                offset: [0, -10]
            })
                .setLngLat(e.lngLat)
                .setHTML(popupContent)
                .addTo(map);
        }

        // Êõ¥Êñ∞ÂÅ¥ÈÇäÊ¨ÑÂ§©Ê∞£Ë≥áÊñô
        function updateWeatherSidebar(geojsonData) {
            const weatherDataDiv = document.getElementById('weather-data');

            if (!geojsonData.features || geojsonData.features.length === 0) {
                weatherDataDiv.innerHTML = '<p>Êö´ÁÑ°Â§©Ê∞£Ë≥áÊñô</p>';
                return;
            }

            const weatherCards = geojsonData.features.map(feature => {
                const props = feature.properties;
                return `
                    <div class="weather-card" onclick="focusOnStation('${props.name}', ${feature.geometry.coordinates[0]}, ${feature.geometry.coordinates[1]})" style="cursor: pointer;">
                        <div class="weather-station">${props.name}</div>
                        <div class="weather-data">
                            <div><strong>Ê∫´Â∫¶:</strong> ${props.temperature}¬∞C</div>
                            <div><strong>ÊøïÂ∫¶:</strong> ${props.humidity}%</div>
                            <div><strong>Ê∞£Â£ì:</strong> ${props.pressure} hPa</div>
                            <div><strong>È¢®ÈÄü:</strong> ${props.wind_speed} m/s</div>
                        </div>
                    </div>
                `;
            }).join('');

            weatherDataDiv.innerHTML = weatherCards;
        }

        // Êõ¥Êñ∞Â§©Ê∞£Áµ±Ë®à
        function updateWeatherStats(geojsonData) {
            if (!geojsonData.features || geojsonData.features.length === 0) return;

            const temperatures = geojsonData.features.map(f => f.properties.temperature).filter(t => t !== 'N/A');
            const humidities = geojsonData.features.map(f => f.properties.humidity).filter(h => h !== 'N/A');

            if (temperatures.length === 0) return;

            const avgTemp = (temperatures.reduce((a, b) => a + b, 0) / temperatures.length).toFixed(1);
            const maxTemp = Math.max(...temperatures);
            const minTemp = Math.min(...temperatures);
            const avgHumidity = humidities.length > 0 ? (humidities.reduce((a, b) => a + b, 0) / humidities.length).toFixed(1) : 'N/A';

            const statsDiv = document.getElementById('weather-stats');
            statsDiv.innerHTML = `
                <div class="weather-card">
                    <div class="weather-station">üìä ÂÖ®Âè∞Áµ±Ë®à</div>
                    <div class="weather-data">
                        <div><strong>Âπ≥ÂùáÊ∫´Â∫¶:</strong> ${avgTemp}¬∞C</div>
                        <div><strong>ÊúÄÈ´òÊ∫´Â∫¶:</strong> ${maxTemp}¬∞C</div>
                        <div><strong>ÊúÄ‰ΩéÊ∫´Â∫¶:</strong> ${minTemp}¬∞C</div>
                        <div><strong>Âπ≥ÂùáÊøïÂ∫¶:</strong> ${avgHumidity}%</div>
                    </div>
                </div>
            `;
        }

        // ËÅöÁÑ¶Âà∞ÊåáÂÆöÊ∞£Ë±°Á´ô
        function focusOnStation(name, lng, lat) {
            map.flyTo({
                center: [lng, lat],
                zoom: 10,
                duration: 1000
            });
            updateStatus(`ËÅöÁÑ¶Âà∞ ${name}`);
        }

        // Êõ¥ÊîπÂú∞ÂúñÊ®£Âºè
        function changeMapStyle() {
            const styleSelect = document.getElementById('map-style-select');
            const selectedStyle = styleSelect.value;

            map.setStyle(mapStyles[selectedStyle]);

            // ÈáçÊñ∞Ë®≠ÂÆöÂúñÂ±§ (Ê®£ÂºèÊõ¥ÊîπÂæåÈúÄË¶ÅÈáçÊñ∞Ê∑ªÂä†)
            map.once('styledata', () => {
                if (weatherStationsData) {
                    map.addSource('weather-stations', {
                        'type': 'geojson',
                        'data': weatherStationsData
                    });
                    setupMapLayers();
                }
            });

            updateStatus(`Â∑≤ÂàáÊèõÂà∞ ${selectedStyle} Ê®£Âºè`);
        }

        // ÂúñÂ±§ÊéßÂà∂ÂáΩÊï∏
        function toggleWeatherStations() {
            const checkbox = document.getElementById('weather-stations');
            const visibility = checkbox.checked ? 'visible' : 'none';

            if (map.getLayer('weather-points')) {
                map.setLayoutProperty('weather-points', 'visibility', visibility);
            }
        }

        function toggleTemperatureLabels() {
            const checkbox = document.getElementById('temperature-labels');
            const visibility = checkbox.checked ? 'visible' : 'none';

            if (map.getLayer('weather-labels')) {
                map.setLayoutProperty('weather-labels', 'visibility', visibility);
            }
        }

        function toggleCityLabels() {
            const checkbox = document.getElementById('city-labels');
            const visibility = checkbox.checked ? 'visible' : 'none';

            if (map.getLayer('city-labels')) {
                map.setLayoutProperty('city-labels', 'visibility', visibility);
            }
        }

        function setWeatherStationsOpacity(value) {
            const opacity = value / 100;
            if (map.getLayer('weather-points')) {
                map.setPaintProperty('weather-points', 'circle-opacity', opacity);
            }
        }

        // Êõ¥Êñ∞ API Key
        function updateApiKey() {
            const apiKeyInput = document.getElementById('api-key-input');
            currentApiKey = apiKeyInput.value.trim() || null;

            if (currentApiKey) {
                updateStatus('Êõ¥Êñ∞ API KeyÔºåÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô...');
            } else {
                updateStatus('Ê∏ÖÈô§ API KeyÔºå‰ΩøÁî®Á§∫ÁØÑË≥áÊñô...');
            }
            loadWeatherStations();
        }

        // Êõ¥Êñ∞ÊâÄÊúâË≥áÊñô
        function refreshAllData() {
            updateStatus('Âà∑Êñ∞ÊâÄÊúâË≥áÊñô‰∏≠...');
            loadWeatherStations();
        }

        // ÂõûÂà∞Âè∞ÁÅ£Ë¶ñÁ™ó
        function centerOnTaiwan() {
            map.flyTo({
                center: [121.0, 23.8],
                zoom: 7,
                pitch: 0,
                bearing: 0,
                duration: 1500
            });
            updateStatus('Â∑≤ÂõûÂà∞Âè∞ÁÅ£Ë¶ñÁ™ó');
        }

        // ÂàáÊèõÂÖ®Ëû¢Âπï
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                updateStatus('ÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÊ®°Âºè');
            } else {
                document.exitFullscreen();
                updateStatus('ÈÄÄÂá∫ÂÖ®Ëû¢ÂπïÊ®°Âºè');
            }
        }

        // ÂåØÂá∫Ë≥áÊñô
        function exportData() {
            if (!weatherStationsData) {
                updateStatus('ÁÑ°Ë≥áÊñôÂèØÂåØÂá∫');
                return;
            }

            const dataStr = JSON.stringify(weatherStationsData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `weather_data_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();

            URL.revokeObjectURL(url);
            updateStatus('Ë≥áÊñôÂ∑≤ÂåØÂá∫');
        }

        // ÈñãÂßãËá™ÂãïÊõ¥Êñ∞
        function startAutoUpdate() {
            // ÊØè10ÂàÜÈêòËá™ÂãïÊõ¥Êñ∞‰∏ÄÊ¨°
            updateInterval = setInterval(() => {
                updateStatus('Ëá™ÂãïÊõ¥Êñ∞Ë≥áÊñô‰∏≠...');
                loadWeatherStations();
            }, 10 * 60 * 1000);
        }

        // Êõ¥Êñ∞ÁãÄÊÖãÂàó
        function updateStatus(message) {
            const now = new Date().toLocaleTimeString('zh-TW');
            document.getElementById('status').textContent = `${now} - ${message}`;
        }

        // È°ØÁ§∫ÈåØË™§Ë®äÊÅØ
        function showError(message) {
            const weatherDataDiv = document.getElementById('weather-data');
            weatherDataDiv.innerHTML = `
                <div class="error-message">
                    ‚ùå ${message}
                </div>
            `;
        }

        // È†ÅÈù¢ËºâÂÖ•ÂÆåÊàêÂæåÂàùÂßãÂåñÂú∞Âúñ
        window.addEventListener('load', () => {
            initMap();
        });

        // È†ÅÈù¢Âç∏ËºâÊôÇÊ∏ÖÁêÜ
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>

</html>